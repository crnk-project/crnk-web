<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Crnk Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Crnk Documentation</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_examples">1. Examples</a></li>
<li><a href="#_architecture">2. Architecture</a></li>
<li><a href="#_setup">3. Setup</a>
<ul class="sectlevel2">
<li><a href="#_requirements">3.1. Requirements</a></li>
<li><a href="#_repository">3.2. Repository</a></li>
<li><a href="#_bom">3.3. BOM</a></li>
<li><a href="#_logging">3.4. Logging</a></li>
<li><a href="#_integration_with_jax_rs">3.5. Integration with JAX-RS</a></li>
<li><a href="#_integration_with_servlet_api">3.6. Integration with Servlet API</a></li>
<li><a href="#_integration_with_spring_and_spring_boot">3.7. Integration with Spring and Spring Boot</a></li>
<li><a href="#_integration_with_vert_x">3.8. Integration with Vert.x</a></li>
<li><a href="#_tomcat_setup">3.9. Tomcat Setup</a></li>
<li><a href="#_discovery_with_cdi">3.10. Discovery with CDI</a></li>
<li><a href="#_discovery_with_guice">3.11. Discovery with Guice</a></li>
<li><a href="#_discovery_with_spring">3.12. Discovery with Spring</a></li>
<li><a href="#_no_discovery">3.13. No Discovery</a></li>
<li><a href="#_implement_a_custom_discovery_mechanism">3.14. Implement a custom discovery mechanism</a></li>
<li><a href="#_crnkboot">3.15. CrnkBoot</a></li>
<li><a href="#_properties">3.16. Properties</a></li>
<li><a href="#_serving_directory_listings_with_the_home_module">3.17. Serving Directory Listings with the Home Module</a></li>
<li><a href="#_setting_up_the_crnk_ui">3.18. Setting up the Crnk UI</a></li>
</ul>
</li>
<li><a href="#_resource">4. Resource</a>
<ul class="sectlevel2">
<li><a href="#_jsonapiresource">4.1. JsonApiResource</a></li>
<li><a href="#_jsonapiid">4.2. JsonApiId</a></li>
<li><a href="#_jsonapirelation">4.3. JsonApiRelation</a></li>
<li><a href="#_jsonapirelationid">4.4. JsonApiRelationId</a></li>
<li><a href="#_jsonapimetainformation">4.5. JsonApiMetaInformation</a></li>
<li><a href="#_jsonapilinksinformation">4.6. JsonApiLinksInformation</a></li>
<li><a href="#_jsonapifield">4.7. JsonApiField</a></li>
<li><a href="#_jackson_annotations">4.8. Jackson annotations</a></li>
<li><a href="#_nested_resources">4.9. Nested Resources</a></li>
<li><a href="#_jsonapiversion">4.10. @JsonApiVersion</a></li>
</ul>
</li>
<li><a href="#_repositories">5. Repositories</a>
<ul class="sectlevel2">
<li><a href="#_resourcerepository">5.1. ResourceRepository</a></li>
<li><a href="#_bulkresourcerepository">5.2. BulkResourceRepository</a></li>
<li><a href="#_query_parameters_with_queryspec">5.3. Query parameters with QuerySpec</a></li>
<li><a href="#_basic_filtering">5.4. Basic Filtering</a></li>
<li><a href="#_nested_filtering">5.5. Nested Filtering</a></li>
<li><a href="#_sorting">5.6. Sorting</a></li>
<li><a href="#_pagination">5.7. Pagination</a></li>
<li><a href="#_numbersize_paging">5.8. Number/Size Paging</a></li>
<li><a href="#_sparse_fieldsets">5.9. Sparse Fieldsets</a></li>
<li><a href="#_url_mapping">5.10. URL Mapping</a></li>
<li><a href="#_relationship_repositories">5.11. Relationship Repositories</a></li>
<li><a href="#_resourcelist">5.12. ResourceList</a></li>
<li><a href="#_error_handling">5.13. Error Handling</a></li>
<li><a href="#_meta_information">5.14. Meta Information</a></li>
<li><a href="#_links_information">5.15. Links Information</a></li>
<li><a href="#_inheritance">5.16. Inheritance</a></li>
<li><a href="#_payload_size_optimizations">5.17. Payload Size Optimizations</a></li>
<li><a href="#_repository_decoration">5.18. Repository Decoration</a></li>
<li><a href="#_resourcefieldcontributor">5.19. ResourceFieldContributor</a></li>
<li><a href="#_jsonapiexposed">5.20. @JsonApiExposed</a></li>
</ul>
</li>
<li><a href="#_client">6. Client</a>
<ul class="sectlevel2">
<li><a href="#_setup_2">6.1. Setup</a></li>
<li><a href="#_usage_2">6.2. Usage</a></li>
<li><a href="#_url_handling">6.3. URL handling</a></li>
<li><a href="#_modules">6.4. Modules</a></li>
<li><a href="#_type_safety">6.5. Type-Safety</a></li>
<li><a href="#_http_customization">6.6. HTTP customization</a></li>
<li><a href="#_jax_rs_interoperability">6.7. JAX-RS interoperability</a></li>
</ul>
</li>
<li><a href="#_formats">7. Formats</a>
<ul class="sectlevel2">
<li><a href="#_plain_json">7.1. Plain JSON</a></li>
</ul>
</li>
<li><a href="#_testkit">8. TestKit</a></li>
<li><a href="#_reactive_programming">9. Reactive Programming</a>
<ul class="sectlevel2">
<li><a href="#_servlet_example">9.1. Servlet Example</a></li>
<li><a href="#_interacting_with_traditional_repositories">9.2. Interacting with traditional repositories</a></li>
<li><a href="#_roadmap_and_limitations">9.3. Roadmap and Limitations</a></li>
</ul>
</li>
<li><a href="#_security">10. Security</a>
<ul class="sectlevel2">
<li><a href="#_authentication">10.1. Authentication</a></li>
<li><a href="#_resource_based_access_control_with_the_securitymodule">10.2. Resource-based Access Control with the SecurityModule</a></li>
<li><a href="#_role_based_access_control_with_resourcefilter">10.3. Role-based Access Control with ResourceFilter</a></li>
<li><a href="#_dataroom_access_control">10.4. Dataroom Access Control</a></li>
<li><a href="#_adapt_user_interfaces_based_on_authorizations">10.5. Adapt User Interfaces based on Authorizations</a></li>
<li><a href="#_provide_authentication_information_to_the_user">10.6. Provide Authentication Information to the User</a></li>
<li><a href="#_exception_mapping">10.7. Exception Mapping</a></li>
<li><a href="#_potential_future_work">10.8. (Potential) Future Work</a></li>
</ul>
</li>
<li><a href="#_data_access">11. Data Access</a>
<ul class="sectlevel2">
<li><a href="#_in_memory">11.1. In-Memory</a></li>
<li><a href="#_jpa">11.2. JPA</a></li>
<li><a href="#_jsr_303_validation_module">11.3. JSR 303 Validation Module</a></li>
<li><a href="#_meta_module">11.4. Meta Module</a></li>
<li><a href="#_faceted_search">11.5. Faceted Search</a></li>
</ul>
</li>
<li><a href="#_generation">12. Generation</a>
<ul class="sectlevel2">
<li><a href="#_java_annotation_processor">12.1. Java Annotation Processor</a></li>
<li><a href="#_openapi">12.2. OpenAPI</a></li>
<li><a href="#_typescript">12.3. Typescript</a></li>
<li><a href="#_gradle_customizations">12.4. Gradle customizations</a></li>
<li><a href="#_documentation_with_asciidoc">12.5. Documentation with AsciiDoc</a></li>
</ul>
</li>
<li><a href="#_bulk_updates_with_operations_module">13. Bulk Updates with Operations Module</a>
<ul class="sectlevel2">
<li><a href="#_operation_module_properties">13.1. Operation Module Properties</a></li>
<li><a href="#_example_request_and_response">13.2. Example Request and Response</a></li>
</ul>
</li>
<li><a href="#_monitoring">14. Monitoring</a>
<ul class="sectlevel2">
<li><a href="#_opentracing">14.1. OpenTracing</a></li>
<li><a href="#_tracing_with_zipkinbrave">14.2. Tracing with Zipkin/Brave</a></li>
</ul>
</li>
<li><a href="#_faq">15. FAQ</a></li>
<li><a href="#_advanced_customizations_through_modules">16. Advanced Customizations through Modules</a>
<ul class="sectlevel2">
<li><a href="#_request_filtering">16.1. Request Filtering</a></li>
<li><a href="#_filter_modifications">16.2. Filter Modifications</a></li>
<li><a href="#_filter_priority">16.3. Filter Priority</a></li>
<li><a href="#_access_to_http_layer">16.4. Access to HTTP layer</a></li>
<li><a href="#_module_extensions_and_dependencies">16.5. Module Extensions and dependencies</a></li>
<li><a href="#_integrate_third_party_data_stores">16.6. Integrate third-party data stores</a></li>
<li><a href="#_implement_a_custom_discovery_mechanism_2">16.7. Implement a custom discovery mechanism</a></li>
<li><a href="#_let_a_module_hook_into_the_crnk_http_client_implementation">16.8. Let a module hook into the Crnk HTTP client implementation</a></li>
<li><a href="#_implement_a_custom_integration">16.9. Implement a custom integration</a></li>
<li><a href="#_create_repositories_at_runtime">16.10. Create repositories at runtime</a></li>
<li><a href="#_discovery_of_modules_by_crnkclient">16.11. Discovery of Modules by CrnkClient</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Crnk is a native resource-oriented rest library where resources, their relationships and repositories are the main building
blocks. In that regard Crnk differ quite dramatically from most REST library out there and opens up many new possibilities.
It allows you to rapidly build REST APIs without having to worry about lower protocol details and lets you instead
focus on what matters: your application.</p>
</div>
<div class="paragraph">
<p>The <a href="#architecture">[architecture]</a> chapter goes into  more details about the merits of resource-oriented APIs, how design
cleaner and more consistent APIs that are easier to understand and better to maintain and evolve with a changing future.</p>
</div>
<div class="paragraph">
<p>Crnk come with support for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>popular frameworks like Spring Boot, JEE, Vert.x.</p>
</li>
<li>
<p>reactive and classical/blocking programming model.</p>
</li>
<li>
<p>standardized url handling: e.g. <code>/api/persons?filter[title]=John</code> and <code>/api/persons/{id}</code></p>
</li>
<li>
<p>sorting, filtering, pagination.</p>
</li>
<li>
<p>attaching link and meta information to resources.</p>
</li>
<li>
<p>inserting, updating and deleting of resources.</p>
</li>
<li>
<p>support to request complex object graphs in a single request with JSON:API inclusions.</p>
</li>
<li>
<p>support for partial objects with sparse field sets.</p>
</li>
<li>
<p>atomically create, update and delete multiple with <a href="http://jsonpatch.com/">jsonpatch.com</a>.</p>
</li>
<li>
<p>a flexible module API to choose and extend the feature set of Crnk.</p>
</li>
<li>
<p>eased testing with the client implementation providing type-safe stubs to access server repositories.</p>
</li>
<li>
<p>repositories providing runtime/meta information about Crnk to implement, for example, documentation
and UI automation.</p>
</li>
<li>
<p>generation of type-safe client stubs (currently Typescript as target language implemented)</p>
</li>
<li>
<p>filters and decorates to intercept and modify all aspects of an application and Crnk.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This allows to rapidly build advanced screens like:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/demo_app.png" alt="demo app"></span></p>
</div>
<div class="paragraph">
<p>By default Crnk follows the JSON:API specification and recommendations. But there is also a similar,
more <a href="#format_plain">basic endpoint</a> targeting simpler applications.</p>
</div>
<div class="paragraph">
<p>Crnk is small, modular and lightweight. It integrates well with many popular frameworks and APIs
and scale to anything from micro-services to serverless systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CDI: resolve repositories and extensions with CDI.</p>
</li>
<li>
<p>Spring: run Crnk with Spring, including support for Spring Boot, ORM, Security and Sleuth.</p>
</li>
<li>
<p>Reactor: for support of reactive programming.</p>
</li>
<li>
<p>Servlet API: run Crnk as servlet.</p>
</li>
<li>
<p>JAXRS: run Crnk as feature.</p>
</li>
<li>
<p>JPA: expose entities as JSON:API resources.</p>
</li>
<li>
<p>JSR-303 bean validation: properly marshal validation and constraints exceptions.</p>
</li>
<li>
<p>OpenTracing: trace all your calls.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While Crnk follows the JSON:API specification, it is not limited to that. Have a look at the
<a href="http://www.crnk.io/">roadmap</a> for more information.</p>
</div>
<div class="paragraph">
<p><a id="examples"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples">1. Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Crnk comes with various examples. There is a main example application in a dedicated repository
available from <a href="https://github.com/crnk-project/crnk-example">crnk-example</a>. It <strong>shows an end-to-end example</strong>
with Crnk, Angular, Spring Boot and ngrx-json-api.</p>
</div>
<div class="paragraph">
<p>And there are various simpler example applications that show the integration of Crnk into various frameworks like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>spring-boot-example</code></p>
</li>
<li>
<p><code>spring-boot-minimal-example</code> showcasing a minimal setup of Crnk with Spring Boot.</p>
</li>
<li>
<p><code>spring-boot-microservice-example</code> showcasing how to connect two separate JSON:API endpoints through a relationship with crnk-client.</p>
</li>
<li>
<p><code>wildfly-example</code></p>
</li>
<li>
<p><code>dropwizard-mongo-example</code></p>
</li>
<li>
<p><code>dropwizard-simple-example</code></p>
</li>
<li>
<p><code>jersey-example</code></p>
</li>
<li>
<p><code>dagger-vertx-example</code> showcasing a very lightweight setup with Dagger, Vert.x, Proguard, OpenJ9 VM having a small size, startup time and memory footprint.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>available from <a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-integration-examples/">crnk-integration-examples</a>.</p>
</div>
<div class="paragraph">
<p>The impatient may also directly want to jump to <a href="#resource_repository">ResourceRepository</a>, but it is highly recommended to
familiarize one self with the architecture and annotations as well. Unlike traditional REST libraries, Crnk comes with a lot of
built-in semantics that allow to automate otherwise laborious tasks.</p>
</div>
<div class="paragraph">
<p><a id="architecture"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture">2. Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Resources</strong>, <strong>relationships</strong> and <strong>repositories</strong> are the central building blocks of Crnk:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resources hold data as value attributes, meta information and link information.</p>
</li>
<li>
<p>Relationships establish links between resources.</p>
</li>
<li>
<p><strong>resource repositories</strong> and <strong>relationship repositories</strong> implement access to resources and relationships.
<code>GET</code>, <code>POST</code>, <code>PATCH</code>, <code>DELETE</code> requests allow to interact with the repositories.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A Crnk application models its API as resources and relationships. One may also call it a <strong>graph</strong> with one
wants to throw in some current buzzword. For example, for a <code>person</code> resource holding an address, there
are different possibilities to set it up in such a resource-oriented
way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>person</code> resource holding address information as attribute. A <code>PATCH</code> request to <code>/api/person/{id}</code>
with the new address will update the attribute on the person accordingly.</p>
</li>
<li>
<p>A <code>person</code> resource, an <code>address</code> resource and a relationship between the two. Then a <code>PATCH</code>
request to <code>/api/person/{id}/relationships/address</code> will trigger an update of the relationship.</p>
</li>
<li>
<p>A dedicated <code>AddressChangeResource</code> that is in a relationship with the <code>person</code> resource.
Then a <code>POST</code> request to <code>/api/addressChange</code> or <code>/api/person/{id}/addressChange</code> (depending on the setup)
will trigger a new address change. This is
the most elaborate setup and can complement the <code>address</code> relationship from before. It allows not just
to trigger a change, but also, for example, to query
the current status and get a history of changes. This in turn allows to model more complex workflows where
an address change may take a larger mount of time and may involve further manual steps.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The opposite to this are RPC-style APIs, where one would implement a <code>changeAddress</code> service taking
the person id and new address as input and performing the desired changes. Crnk
focuses on resource-oriented APIs, but still works well together with the later, for which there are already many
libraries out there such as JAX-RS and Spring MVC.</p>
</div>
<div class="paragraph">
<p>The <strong>benefits of resource-oriented APIs</strong> are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A clean, consistent model of your API. Seeing it means understanding it. The semantics of resource and relationships
are well established. Consumers can learn about the API by just browsing it through the provided linking.</p>
</li>
<li>
<p>Better evolution into the future. RPC-style APIs frequently suffer from many different, isolated services. Every
service can basically do whatever it pleases. Over time this can lead to difficulties understanding and changing a system.</p>
</li>
<li>
<p>Better testability and mocking: By using built-in in-memory repositories and providing test data for resources, a fully
running endpoint can be achieved within hours. After that can, for example, frontend and backend development
take place in parallel without uncertainty about API contracts.</p>
</li>
<li>
<p>The basic yet powerful model allows for a rich set of tooling and automation to reduce the amount of custom coding.
Crnk comes with support for JPA, JSR-303 validation, faceted search support, OpenTracing and more next to
handling lower-layer REST details, linking and relationships.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Crnk is implemented as library rather than new framework. It almost no third-party dependencies, is
lightweight in design and integrates well with many other libraries like Vert.X, JAX-RS and Spring Boot.</p>
</div>
<div class="paragraph">
<p>Crnk follows, but is not limited by the <a href="https://jsonapi.org/">JSON:API</a> specification to built resource-oriented APIs.
Its implementation is hosted in the <code>crnk-core</code> project. The JSON:API specification provides
all the essential building blocks like sorting, filtering, paging, document formats, linking and error handling to access
resources and relationships. If desired, also other protocols like GraphQL and custom REST API contract can be
implemented by updating the serialization layer of <code>crnk-core</code>. To understand the inner working, it is
important to know how requests are processed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Crnk interceptor is called from the underlying framework. This might be, for example, from a Servlet environment,
JAX-RS or Spring MVC.</p>
</li>
<li>
<p>The request is deserialized to Crnk data structures like <code>Document</code>, <code>Resource</code>, <code>ResourceIdentifier</code> or <code>ErrorData</code>.</p>
</li>
<li>
<p>The type of request is determined: whether it is a <code>POST</code>, <code>PATCH</code>, <code>GET</code> or <code>DELETE</code> request and whether it is a resource or
relationship request.</p>
</li>
<li>
<p>The request is forwarded to the appropriate repository implementation.</p>
</li>
<li>
<p><code>GET</code> requests can ask for inclusions of further, related resources. Result resources will then trigger further requests to
other repositories. This can happen either manually from within the initially called repository or automatically
by Crnk (explained in detail in later chapters).</p>
</li>
<li>
<p>The result resources are merged into response document and returned to the underlying framework for delivery. Possible
exceptions are handled as and mapped as well.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A benefit of Crnk is its flexibility how to set all this up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resources and relationships can be defined with simple Java Beans and annotations or programmatically. The later allows
virtually any kind of customization at runtime. One example is <code>crnk-data-jpa</code>
that is able to expose any JPA entity as resource.</p>
</li>
<li>
<p>Resources and relationships can be entirely decoupled concerns. A new relationship repository can introduce
an additoinal relationship to existing resources. For example, an audit component could intercept and log any
modifications and introduce a new relationship <code>history</code> onto each resource to access it.</p>
</li>
<li>
<p>Information about resources, relationships and repositories are available trough a Java API and resource endpoint.</p>
</li>
<li>
<p>Filters and decorators allow to intercept and modify every step along the request chain. This can be used, for example,
to enforce security, collect metrics or do tracing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To facilitate the setup, Crnk comes with a small module API. Independent functionality can be assembled as module and then just
included into the application. Crnk comes with a number of modules on its own:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>crnk-data-jpa</code></p>
</li>
<li>
<p><code>crnk-data-facets</code></p>
</li>
<li>
<p><code>crnk-validation</code></p>
</li>
<li>
<p><code>crnk-operations</code></p>
</li>
<li>
<p>Spring modules</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Such modules can make use of filters, decorators, decoupled resources and relationships and various other features.
Everything together fosters the use of the <strong>composite pattern</strong> where larger applications can be assembled from smaller
parts, some from third-party modules and others from manually implemented ones.</p>
</div>
<div class="paragraph">
<p><a id="setup"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup">3. Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Crnk integrates well with many popular frameworks. The example applications outline various different possible
setups. But application are also free to customize their setup to their liking.
There are three main, orthogonal aspects of Crnk that need configuration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The integration into a web framework like JAXRS or the Servlet API to be able to process requests.</p>
</li>
<li>
<p>The discovery of repositories, modules, exception mappers, etc. Usually by a dependency injection framework. But can also
happen manually.</p>
</li>
<li>
<p>The selection of third-party modules to reuse. For a list of modules provided by Crnk see the &lt;modules&gt; chapter.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The subsequent sections explain various possibilities resp. how to implement a custom one.
The <a href="#reactive">[reactive]</a> chapter further outlines how to setup Crnk in an asynchronous/reactive setting.</p>
</div>
<div class="sect2">
<h3 id="_requirements">3.1. Requirements</h3>
<div class="paragraph">
<p>Crnk library requires minimum Java 8 (as of Crnk 2.4) to build and run. In the future it will come with support
for both the current major Java releases (9, 10, 11, etc.) and the current long-term support version that gets
released every three years.</p>
</div>
</div>
<div class="sect2">
<h3 id="_repository">3.2. Repository</h3>
<div class="paragraph">
<p>Crnk Maven artifacts are available from Bintray/JCenter.</p>
</div>
<div class="paragraph">
<p><a href="https://bintray.com/crnk-project" class="bare">https://bintray.com/crnk-project</a></p>
</div>
<div class="paragraph">
<p>In Gradle it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>repositories {
   jcenter()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that due to performance/reliability issues, releases are only intermittently pushed to Maven Central.
It is highly recommended for project to go with JCenter as well.</p>
</div>
<div class="paragraph">
<p>Stable releases hosted on Bintray/JCenter are also available from:</p>
</div>
<div class="paragraph">
<p><a href="https://bintray.com/crnk-project/maven" class="bare">https://bintray.com/crnk-project/maven</a>
<a href="https://dl.bintray.com/crnk-project/maven/" class="bare">https://dl.bintray.com/crnk-project/maven/</a></p>
</div>
<div class="paragraph">
<p>Most recent builds are available from (for a limited period of time):</p>
</div>
<div class="paragraph">
<p><a href="https://bintray.com/crnk-project/mavenLatest" class="bare">https://bintray.com/crnk-project/mavenLatest</a>
<a href="https://dl.bintray.com/crnk-project/mavenLatest/" class="bare">https://dl.bintray.com/crnk-project/mavenLatest/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_bom">3.3. BOM</h3>
<div class="paragraph">
<p>With <code>io.crnk:crnk-bom</code> a Maven BOM is provided that manages the dependencies of all crnk artifacts.
In Gradle the setup then looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>buildscript {
	dependencies {
		classpath "io.spring.gradle:dependency-management-plugin:1.0.4.RELEASE"
	}
}

gradle.beforeProject { Project project -&gt;
	project.with {
		apply plugin: 'io.spring.dependency-management'
		dependencyManagement {
			imports {
				mavenBom "io.crnk:crnk-bom:$CRNK_VERSION"
			}
		}
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The crnk modules can then simply be used without having to specify a version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>dependencies {
	compile 'io.crnk:crnk-rs'
	compile 'io.crnk:crnk-setup-spring-boot2'
	...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging">3.4. Logging</h3>
<div class="paragraph">
<p>Crnk makes use of SLF4J to do logging. Make sure to have the API properly setup. For example by making use of Logback or one of the many bridges to
other Logging frameworks.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Set <code>io.crnk</code> to <code>DEBUG</code> if you encounter any issues during setup or later at runtime.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_integration_with_jax_rs">3.5. Integration with JAX-RS</h3>
<div class="paragraph">
<p>Crnk allows integration with JAX-RS environments through the usage of JAX-RS specification. JAX-RS 2.0 is
required for this integration. Under the hood there is a @PreMatching filter which checks each request for
JSON:API processing. The setup can look as simple as:</p>
</div>
<div class="sect3">
<h4 id="_crnkfeature">3.5.1. CrnkFeature</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>@ApplicationPath("/")
	public class MyApplication extends Application {

		@Override
		public Set&lt;Object&gt; getSingletons() {
			CrnkFeature crnkFeature = new CrnkFeature();
			return Collections.singleton((Object)crnkFeature);
		}
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CrnkFeature</code> provides various accessors to customize the behavior of Crnk.
A more advanced setup may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>	public class MyAdvancedCrnkFeature implements Feature {

		@Inject
		private EntityManager em;

		@Inject
		private EntityManagerFactory emFactory;

		...

		@Override
		public boolean configure(FeatureContext featureContext) {
			// also map entities to JSON:API resources (see further below)
			JpaModule jpaModule = new JpaModule(emFactory, em, transactionRunner);
			jpaModule.setRepositoryFactory(new ValidatedJpaRepositoryFactory());

			// limit all incoming requests to 20 resources if not specified otherwise
			DefaultQuerySpecUrlMapper urlMapper = new DefaultQuerySpecUrlMapper();
			urlMapper.setDefaultLimit(20L);

			ServiceLocator serviceLocator = ...
			CrnkFeature feature = new CrnkFeature();
			feature.addModule(jpaModule);
			feature.getBoot().setUrlMapper(urlMapper);

			featureContext.register(feature);
			return true;
		}
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Crnk will install a JAX-RS filter that will intercept and process any Crnk-related request.</p>
</div>
<div class="paragraph">
<p>Note that depending on the discovery mechanism in use (like Spring or CDI), modules like this JpaModule can be picked
up automatically and do not manual registration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exception_mapping_for_jax_rs_services">3.5.2. Exception mapping for JAX-RS services</h4>
<div class="paragraph">
<p>In many cases Crnk repositories are used along regular JAX-RS services. In such scenarios it can be worthwhile
if Crnk repositories and JAX-RS services make use of the same exception handling and response format. To make
use of the JSON:API resp. Crnk exception handling in JAX-RS services, one can add the
<strong>ExceptionMapperBridge</strong> to the JAX-RS application. The constructor of <code>ExceptionMapperBridge</code>
takes <code>CrnkFeature</code> as parameter.</p>
</div>
<div class="paragraph">
<p>For an example have a look at the next section which make use of it together with <code>JsonApiResponseFilter</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_jsonapi_format_with_jax_rs_services">3.5.3. Use JSON:API format with JAX-RS services</h4>
<div class="paragraph">
<p>Similar to <code>ExceptionMapperBridge</code> in the previous section, it is possible for JAX-RS services to return
resources in JSON:API format with <strong>JsonApiResponseFilter</strong>. <code>JsonApiResponseFilter</code> wraps primitive
responses with a <code>data</code> object; resource objects with <code>data</code> and <code>included</code> objects.
The constructor of <code>JsonApiResponseFilter</code> takes <code>CrnkFeature</code> as parameter.</p>
</div>
<div class="paragraph">
<p>To determine which JAX-RS services should be wrapped, <code>JsonApiResponseFilter</code> checks whether the
<code>@Produce</code> annotation delivers JSON:API. The produce
annotation can be added, for example, to the class:</p>
</div>
<div class="listingblock">
<div class="title">ScheduleRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>@Path("schedules")
@Produces(HttpHeaders.JSONAPI_CONTENT_TYPE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the JAX-RS application setup looks like:</p>
</div>
<div class="listingblock">
<div class="title">JsonApiResponseFilterTestBase.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>    @ApplicationPath("/")
    class TestApplication extends ResourceConfig {

        TestApplication(JsonApiResponseFilterTestBase instance, boolean enableNullResponse) {
            instance.setEnableNullResponse(enableNullResponse);

            property(CrnkProperties.NULL_DATA_RESPONSE_ENABLED, Boolean.toString(enableNullResponse));

            CrnkFeature feature = new CrnkFeature();
            feature.addModule(new TestModule());

            register(new JsonApiResponseFilter(feature));
            register(new JsonapiExceptionMapperBridge(feature));
            register(new JacksonFeature());

            register(feature);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that  <code>CrnkProperties.NULL_DATA_RESPONSE_ENABLED</code> determines whether null responses should be wrapped
as JSON:API responses.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jax_rs_service_interoperability">3.5.4. JAX-RS service interoperability</h4>
<div class="paragraph">
<p>It is possible to implement repositories that host both JAX-RS and JSON-API methods to complement JSON
API repositories with non-resource based services. Have a look at the <a href="#client_jaxrs">Crnk Client chapter</a> for an example.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_integration_with_servlet_api">3.6. Integration with Servlet API</h3>
<div class="paragraph">
<p>There are two ways of integrating crnk using Servlets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding an instance of <code>CrnkServlet</code></p>
</li>
<li>
<p>Adding an instance of <code>CrnkFilter</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_integrating_using_a_servlet">3.6.1. Integrating using a Servlet</h4>
<div class="paragraph">
<p>There is a <code>CrnkServlet</code> implementation allowing to integrate Crnk into a Servlet environment.
It can be configured with all the parameters outlined in the subsequent sections. Many times
application will desire to do more advanced customizations, in this case one can
extends <code>CrnkServlet</code> and get access to <code>CrnkBoot</code>. The code below shows a sample implementation:</p>
</div>
<div class="listingblock">
<div class="title">SampleCrnkServlet.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>public class SampleCrnkServlet extends CrnkServlet {

	@Override
	protected void initCrnk(CrnkBoot boot) {
		// do your configuration here
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The newly created servlet must be added to the <code>web.xml</code> file or to another deployment descriptor.
The code below shows a sample <code>web.xml</code> file with a properly defined and configured servlet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  &lt;web-app&gt;
    &lt;servlet&gt;
      &lt;servlet-name&gt;SampleCrnkServlet&lt;/servlet-name&gt;
      &lt;servlet-class&gt;io.crnk.servlet.SampleCrnkServlet&lt;/servlet-class&gt;
      &lt;init-param&gt;
        &lt;!-- can typically be ommitted and is auto-detected --&gt;
        &lt;param-name&gt;crnk.config.core.resource.domain&lt;/param-name&gt;
        &lt;param-value&gt;http://www.mydomain.com&lt;/param-value&gt;
      &lt;/init-param&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;SampleCrnkServlet&lt;/servlet-name&gt;
      &lt;url-pattern&gt;/api/v1/ *&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
  &lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>init-param</code> allow to pass configuration flags to Crnk. For a list of properties see <a href="#properties">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_integrating_using_a_filter">3.6.2. Integrating using a filter</h4>
<div class="paragraph">
<p>Integrating Crnk as a Servlet filter works in a very similar fashion as for servlets:</p>
</div>
<div class="listingblock">
<div class="title">SampleCrnkFilter.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>public class SampleCrnkFilter extends CrnkFilter {

	@Override
	protected void initCrnk(CrnkBoot boot) {
		// do your configuration here
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The newly created filter must be added to <code>web.xml</code> file or other deployment descriptor.
A code below shows a sample <code>web.xml</code> file with properly defined and configured filter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  &lt;web-app&gt;
    &lt;filter&gt;
      &lt;filter-name&gt;SampleCrnkFilter&lt;/filter-name&gt;
      &lt;filter-class&gt;io.crnk.servlet.SampleCrnkFilter&lt;/filter-class&gt;
      &lt;init-param&gt;
        &lt;!-- can typically be ommitted and is auto-detected --&gt;
        &lt;param-name&gt;crnk.config.core.resource.domain&lt;/param-name&gt;
        &lt;param-value&gt;http://www.mydomain.com&lt;/param-value&gt;
      &lt;/init-param&gt;
    &lt;/filter&gt;
  &lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>init-param</code> allow to pass configuration flags to Crnk. For a list of properties see <a href="#properties">here</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_integration_with_spring_and_spring_boot">3.7. Integration with Spring and Spring Boot</h3>
<div class="paragraph">
<p>Crnk provides with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io-crnk:crnk-setup-spring</code> support for plain Spring 4 and 5.</p>
</li>
<li>
<p><code>io-crnk:crnk-setup-spring-boot1</code> support for Spring Boot 1.x. This module is considered being deprecated and will be removed in the future.</p>
</li>
<li>
<p><code>io-crnk:crnk-setup-spring-boot2</code> support for Spring Boot 2.x.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a <code>CrnkCoreAutoConfiguration</code> in  <code>crnk-setup-spring-boot2</code> that outlines
the basic setup that can easily be applied to a Spring-only setup without Spring Boot using <code>crnk-setup-spring</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It uses the <code>CrnkFilter</code> servlet filter to process requests.</p>
</li>
<li>
<p>Service discovery is performed with <code>SpringServiceDiscovery</code> using the Spring <code>ApplicationContext</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>io-crnk:crnk-setup-spring-boot1</code> and  <code>io-crnk:crnk-setup-spring-boot2</code> host Spring Boot auto configurations
that are enabled if the presence of the particular Crnk module and/or Spring component. Each auto configuration
can be enabled and disabled and may host further properties to reconfigure it. The following auto configurations are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CrnkHomeAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkCoreAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkValidationAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkJpaAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkMetaAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkOperationsAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkUIAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkSecurityAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkSpringMvcAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkErrorControllerAutoConfiguration</code></p>
</li>
<li>
<p><code>CrnkTomcatAutoConfiguration</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The most important one is <code>CrnkCoreAutoConfiguration</code> to setup the core of Crnk. Its main properties are:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code>crnk.enabled=true
crnk.domain-name=http://localhost:8080
crnk.path-prefix=/api
crnk.default-page-limit=20
crnk.max-page-limit=1000
crnk.allow-unknown-attributes=false
crnk.return404-on-null=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/crnk-project/crnk-framework/blob/master/crnk-setup/crnk-setup-spring-boot2/src/main/java/io/crnk/setup/spring/boot/core/CrnkCoreProperties.java">CrnkCoreProperties</a>
and the various auto configurations for more information. Next to configuration properties there is also the possibility to provide a <code>Configurer</code> implementation
to gain programmatic access to module configurations. The following <code>Configurer</code> are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CrnkBootConfigurer</code></p>
</li>
<li>
<p><code>JpaModuleConfigurer</code></p>
</li>
<li>
<p><code>SecurityModuleConfigurer</code></p>
</li>
<li>
<p><code>MetaModuleConfigurer</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Next to all the auto configurations there are also a number of further Spring-specific modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SpringSecurityModule</code> provides a mapping of Spring Security exception types to JSON:API errors that complements
the Spring-independent <code>SecurityModule</code>. Auto configuration is provided by <code>CrnkSecurityAutoConfiguration</code>. It sets up <code>SecurityModule</code> and
<code>SpringSecurityModule</code>. By default access to all repositories is blocked. A bean of type <code>SecurityModuleConfigurer</code>
can be added to grant access to repositories.</p>
</li>
<li>
<p><code>SpringTransactionRunner</code> lets all requests run in a transaction. If the request completes, the transaction is committed.
In case of an error, the transaction is rolled back.</p>
</li>
<li>
<p>Spring MVC Module makes Spring MVC services available in the Crnk Home Module next to the JSON:API repositories to have a list of all offered
services. Auto configuration is provided by <code>CrnkSpringMvcAutoConfiguration</code>.</p>
</li>
<li>
<p>With <code>CrnkErrorController</code> configured by <code>CrnkErrorControllerAutoConfiguration</code> additionally a new error controller is
provided that returns errors in JSON:API format. <code>crnk.spring.mvc.errorController=false</code> allows to disable the controller.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_integration_with_vert_x">3.8. Integration with Vert.x</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Reactive programming support has been introduced in Crnk 2.6 and is still considered experimental
  with some limitations. Please also provide feedback about this Vert.x integration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Crnk integrates with Vert.x RxJava 2 using <code>crnk-reactive</code> and <code>crnk-setup-vertx</code>. More information about
reactive programming is available <a href="#reactive">here</a>. To make use of Crnk with Vert.x, make sure you have
the following dependencies specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>	compile 'io.crnk:crnk-setup-vertx'
	compile 'io.vertx:vertx-rx-java2'</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example Vert.x vehicle may then look like:</p>
</div>
<div class="listingblock">
<div class="title">CrnkVerticle.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>public class CrnkVerticle extends AbstractVerticle {

    private static final Logger LOGGER = LoggerFactory.getLogger(CrnkVerticle.class);

    public ReactiveTestModule testModule = new ReactiveTestModule();

    private int port;

    private CrnkVertxHandler handler;

    public CrnkVerticle(int port) {
        this.port = port;

        handler = new CrnkVertxHandler((boot) -&gt; {
            boot.addModule(HomeModule.create());
            boot.addModule(testModule);
        });
    }

    @Override
    public void start() {
        HttpServer server = vertx.createHttpServer();

        server.requestStream().toFlowable()
                .flatMap(request -&gt; handler.process(request))
                .subscribe((response) -&gt; LOGGER.debug("delivered response {}", response), error -&gt; LOGGER.debug("error occured", error));
        server.listen(port);
    }

    public CrnkBoot getBoot() {
        return handler.getBoot();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CrnkVertxHandler</code> holds the Crnk setup. Its constructor takes a <code>Consumer&lt;CrnkBoot&gt;</code> that allows the customization
of Crnk. The example makes use of it to register two modules. <code>CrnkVertxHandler.process</code> is the main method
that allows to process <code>HttpServerRequest</code> objects of Vert.x.</p>
</div>
<div class="paragraph">
<p><a id="tomcatSetup"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_tomcat_setup">3.9. Tomcat Setup</h3>
<div class="paragraph">
<p>There is a bit of a controversy about which characters to encode or not encode in URLs based on
RFC 7230 and RFC 3986. JSON:API is affected in that regard due to the use of [ and ].
Browser vendors have yet to endorse those RFCs. But unfortunately, Tomcat already started
to enforce the RFCs from their side. As such it is useful to
relax the [ and ] characters to simplify development with JSON:API, like entering
URLs manually in the browser. For this purpose <code>relaxedPathChars</code> can be set to <code>[]</code>, for more information
see:</p>
</div>
<div class="paragraph">
<p><a href="https://stackoverflow.com/questions/41053653/tomcat-8-is-not-able-to-handle-get-request-with-in-query-parameters" class="bare">https://stackoverflow.com/questions/41053653/tomcat-8-is-not-able-to-handle-get-request-with-in-query-parameters</a></p>
</div>
<div class="paragraph">
<p>The Spring Boot auto configuration already does this out-of-the-box.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
There is no weakened security out of this as long as parameters are not used
  in some obscure fashion.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_discovery_with_cdi">3.10. Discovery with CDI</h3>
<div class="paragraph">
<p>To enable CDI support, add <code>io.crnk:crnk-cdi</code> to your classpath. Crnk will then pickup the
<code>CdiServiceDiscovery</code> implementation and use it to discover its modules and repositories. Modules, repositories,
etc. will then be picked up if they are registered as CDI beans.</p>
</div>
<div class="paragraph">
<p>By default <code>Cdi.current()</code> is used to obtain a <code>BeanManager</code>. The application may also make use of
<code>CdiServiceDiscovery.setBeanManager(&#8230;&#8203;)</code> to set a custom one. The various integrations like <code>CrnkFeature</code> provide
a <code>setServiceDiscovery</code> method to set a customized instance.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<code>Cdi.current()</code> has shown to be unreliable in some cases when doing EAR deployment. In such cases
it is highly recommended to set the <code>BeanManager manually</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_discovery_with_guice">3.11. Discovery with Guice</h3>
<div class="paragraph">
<p>A <code>GuiceServiceDiscovery</code> implementation is provided. The various integrations like <code>CrnkFeature</code> provide
a <code>setServiceDiscovery</code> method to set the instance. For an example have a look at the dropwizard example
application (<a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-integration-examples/dropwizard-simple-example" class="bare">https://github.com/crnk-project/crnk-framework/tree/master/crnk-integration-examples/dropwizard-simple-example</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_discovery_with_spring">3.12. Discovery with Spring</h3>
<div class="paragraph">
<p>The Spring integration comes with a <code>SpringServiceDiscovery</code> that makes use of the Spring <code>ApplicationContext</code>
to discover beans.</p>
</div>
</div>
<div class="sect2">
<h3 id="_no_discovery">3.13. No Discovery</h3>
<div class="paragraph">
<p>It is also possible to make use of no discovery mechanism at all. In this case it is still possible to add repositories
and other features through modules. A simple example looks like:</p>
</div>
<div class="listingblock">
<div class="title">DropwizardService</div>
<div class="content">
<pre class="CodeRay highlight"><code>		SimpleModule module = new SimpleModule("example");
		module.addRepository(new ProjectRepository());

		CrnkFeature crnkFeature = new CrnkFeature();
		crnkFeature.addModule(module);

		environment.jersey().register(crnkFeature);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look at the various <a href="#modules">[modules]</a> chapters for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implement_a_custom_discovery_mechanism">3.14. Implement a custom discovery mechanism</h3>
<div class="paragraph">
<p>Application can bring along there own implementation of <code>ServiceDiscovery</code>. For more information
see <a href="#customdiscovery">here</a>.</p>
</div>
<div class="paragraph">
<p><a id="CrnkBoot"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_crnkboot">3.15. CrnkBoot</h3>
<div class="paragraph">
<p><code>CrnkBoot</code> is a class shared among all the different integrations that takes care of setting up and starting
Crnk. Every integration will provide access to it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CrnkFeature.getBoot()</code> for JAX-RS.</p>
</li>
<li>
<p><code>@Autowired CrnkBoot boot</code> for Spring.</p>
</li>
<li>
<p><code>CrnkServlet.getBoot()</code> or <code>CrnkServlet.initBoot(&#8230;&#8203;)</code> in case of a subclass.</p>
</li>
<li>
<p><code>CrnkVertxHandler.getBoot()</code> for Vert.x.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>CrnkBoot</code> allows for virtually any kind of customization not directly provided by the integration itself, such as Spring Boot
auto configurations and properties. Some possibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getObjectMapper</code> allows access to the used Jackson instance.</p>
</li>
<li>
<p><code>addModule</code> allows to add a module. See &lt;modules&gt; and &lt;moduledev,module development&gt; chapters for more information.</p>
</li>
<li>
<p><code>setServiceDiscovery</code> sets a custom service discovery mechanism.</p>
</li>
<li>
<p><code>setPropertiesProvider</code> allows to set how properties are resolved.</p>
</li>
<li>
<p><code>getQuerySpecDeserializer</code> and <code>setQuerySpecDeserializer</code> allows to reconfigure how parameters are parsed.
Note that in some areas JSON:API only provides reocmmendations and Crnk follows those recommendations
by default. So depending on your use cases, you may want to configure or implement some aspects differently.</p>
</li>
<li>
<p><code>setMaxPageLimit</code> allows to set the maximum number of allowed resources that can be fetched with a request
by limiting pagination.</p>
</li>
<li>
<p><code>setDefaultPageLimit</code> allows to set a default page limit if none is specified by the request. <strong>Highly
recommended</strong> to be used as people frequently browse repositories on there own with a web browser and
fail to provide pagination. As a result, your entire database may get downloaded and may bring down
your servers depending on the datasize.</p>
</li>
<li>
<p><code>setWebPathPrefix</code> like <code>/api</code> to specify the path from where the JSON:API endpoint is available.</p>
</li>
<li>
<p><code>setUrlMapper</code> to provide a new url mapping implementation to customize how Crnk generates links.</p>
</li>
<li>
<p><code>getResourceRegistry</code> to access the available JSON:API resources and repositories.</p>
</li>
<li>
<p><code>setAllowUnknownAttributes</code> to ignore unknown filter and sort attributes.</p>
</li>
<li>
<p><code>setAllowUnknownParameters</code> to ignore query parameters not specified by JSON:API (<code>filter</code>, <code>sort</code>, etc.).</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Appropriate page limits are vital to protect against denial-of-service attacks when working
with large data sets! Such attacks may not be of malicious nature, but normal users using a browser
and just omitting to specify pagination parameters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a id="properties"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_properties">3.16. Properties</h3>
<div class="paragraph">
<p>Any of the integrations allows API access to customize Crnk. There are also a number of configuration flags
provided by <code>CrnkProperties</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>crnk.config.core.resource.domain</code>
Domain name as well as protocol and optionally port number used when building links objects in responses i.e. <a href="http://crnk.io" class="bare">http://crnk.io</a>.
The value must not end with <code>/</code>. If the property is omitted, then they are extracted from the incoming request, which should work
well for most use cases.</p>
</li>
<li>
<p><code>crnk.config.web.path.prefix</code>
Default prefix of a URL path used in two cases:</p>
<div class="ulist">
<ul>
<li>
<p>When building <code>links</code> objects in responses</p>
</li>
<li>
<p>When performing method matching
An example of a prefix <code>/api/v1</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>crnk.config.include.paging.packagingEnabled</code> enables pagination for inclusions. Disabled by default. Be aware this may
inadvertently enable pagination for included resources when doing paging on root resources if data structures
are cyclic. See <code>CrnkProperties.INCLUDE_PAGING_ENABLED</code> fore mor information.</p>
</li>
<li>
<p><code>crnk.config.lookup.behavior.default</code> specifies the default lookup behavior for relationships. For more information
see <a href="#jsonApiRelation">@JsonApiRelation</a>.</p>
</li>
<li>
<p><code>crnk.config.include.behavior</code> with possible values <code>BY_TYPE</code> (default) and <code>BY_ROOT_PATH</code>.
<code>BY_ROOT_PATH</code> specifies that an inclusion can only requested as path from the root
resource such as <code>include[tasks]=project.schedule</code>. While <code>BY_TYPE</code> can further request
inclusions by type directly such as <code>include[tasks]=project&amp;include[projects]=schedule</code>.
For simple object structures they are semantically the same, but they do differ
for more complex ones, like when multiple attributes lead
to the same type or for cycle structures. In the later case BY_TYPE inclusions
become recursive, while BY_ROOT_PATH do not. Note that the use of BY_TYPE
outmatches BY_ROOT_PATH, so BY_TYPE includes everything BY_ROOT_PATH does
and potentially more. For more information see <code>CrnkProperties.INCLUDE_BEHAVIOR</code>.</p>
</li>
<li>
<p><code>crnk.config.resource.immutableWrite</code> with values IGNORE (default) or FAIL.
Determines how to deal with field that cannot be changed upon a PATCH or POST
request. For more information see <code>CrnkProperties.RESOURCE_FIELD_IMMUTABLE_WRITE_BEHAVIOR</code>.</p>
</li>
<li>
<p><code>crnk.config.resource.response.return_404</code> with values true and false (default).
Enforces a 404 response should a repository return a null value. This is common practice, but
not strictly mandated by the JSON:API specification. In general it is recommended for
repository to throw <code>ResourceNotFoundException</code>.</p>
</li>
<li>
<p><code>crnk.config.serialize.object.links</code> to serialize links as objects. See
<a href="http://jsonapi.org/format/#document-links" class="bare">http://jsonapi.org/format/#document-links</a>. Disabled by default.</p>
</li>
<li>
<p><code>crnk.config.resource.request.rejectPlainJson</code> whether to reject GET requests with
<code>application/json</code> accept headers and enforce <code>application/vnd.api+json</code>. Disabled by default.</p>
</li>
<li>
<p><code>crnk.config.resource.request.allowUnknownAttributes</code> lets Crnk ignore unknown filter and sort parameters. Disabled by default.</p>
</li>
<li>
<p><code>crnk.config.serialize.object.links</code> determines whether links should be serialized as simple string (default) or as
objects (with a <code>self</code> attribute holding the url).</p>
</li>
<li>
<p><code>crnk.config.resource.request.rejectPlainJson</code> determines whether Crnk should reject <code>application/json</code> requests to  JSON-API
 endpoints. Disabled by default. The JSON-API specification mandates the use of the <code>application/vnd.api+json</code>
 MIME-Type. In cases where frontends or intermediate proxies prefer the <code>application/json</code> MIME-Type, that type can be sent in
 the <code>Accept</code> header instead.
 If an application wants to serve a different response depending on whether the client&#8217;s <code>Accept</code> header
 contains <code>application/vnd.api+json</code> or <code>application/json</code>, this option can be enabled.
 This *does not affect the payload <code>Content-Type</code>. <code>POST</code> and <code>PATCH</code> requests must still use
<code>Content-Type: application/vnd.api+json</code> to describe their request body</p>
</li>
<li>
<p>If <code>crnk.enforceIdName</code> is set to <code>true</code> all <code>@JsonApiId</code> annotated fields will be named <code>id</code> on the rest layer (for sorting, filtering, etc.) regardless of its Java name.
By default this is not enabled for historic reasons. But enabling it more closely reflects the JSON:API specification and is recommended to do so.
It likely will be enabled in Crnk 3 by default.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="home_module"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_serving_directory_listings_with_the_home_module">3.17. Serving Directory Listings with the Home Module</h3>
<div class="paragraph">
<p>The <code>HomeModule</code> provides a listing of available resources in each directory (such as the root <code>/api/</code>). Note that
directory paths always end with a '/' and the <code>HomeModule</code> will process the request if there is no resource or
relationship repository serving that particular path.</p>
</div>
<div class="paragraph">
<p>The <code>HomeModule</code> supports two kinds of formats that can be choosen upon creation. A JSON:API-style format where a
links node holds all links to child directories and repositories. And a JSON HOME format as specified by
<a href="https://tools.ietf.org/html/draft-nottingham-json-home-06">JSON Home</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>		HomeModule metaModule = HomeModule.create();
		...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the Spring Boot example applications it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
  "links" : {
    "meta" : "http://localhost:8080/api/meta/",
    "projects" : "http://localhost:8080/api/projects",
    "resourcesInfo" : "http://localhost:8080/api/resourcesInfo",
    "schedule" : "http://localhost:8080/api/schedule",
    "scheduleDto" : "http://localhost:8080/api/scheduleDto",
    "tasks" : "http://localhost:8080/api/tasks"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>meta</code> entry with a trailing '/' that allows to move to subdirectory <code><a href="http://localhost:8080/api/meta/" class="bare">http://localhost:8080/api/meta/</a></code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
  "links" : {
    "arrayType" : "http://localhost:8080/api/meta/arrayType",
    "attribute" : "http://localhost:8080/api/meta/attribute",
    "dataObject" : "http://localhost:8080/api/meta/dataObject",
    "element" : "http://localhost:8080/api/meta/element",
    "resource" : "http://localhost:8080/api/meta/resource",
    "type" : "http://localhost:8080/api/meta/type"
    ...
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_the_crnk_ui">3.18. Setting up the Crnk UI</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The UI is currently in an early stage. Feature requests and PRs welcomed!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The UI module makes <code>crnk-ui</code> accessible trough the module system. It allows to browse and edit all the repositories
and resources. The setup looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>		UIModule operationsModule = UIModule.create(new UIModuleConfig());
		...</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the user interface is accessible from the <code>/browse/</code> directory next to all the repositories.
Have a look at the Spring Boot example application to see a working example.</p>
</div>
<div class="paragraph">
<p>This module is currently in incubation. Please provide feedback.</p>
</div>
<div class="paragraph">
<p>An example from the Spring Boot example application looks like:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/crnk_ui.png" alt="crnk ui"></span></p>
</div>
<div class="paragraph">
<p><a id="resource"></a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resource">4. Resource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A resource as defined by JSON:API holds the actual data. The engine part of <code>crnk-core</code> is agnostic to how such resources are
actually implemented (see the <a href="#architecture">[architecture]</a> and <a href="#modules">[modules]</a> chapters). This chapter describes the most common
way Java Beans and annotations. See <a href="#runtimerepository">here</a> for more information how setup resources and repositories
programmatically at runtime.</p>
</div>
<div class="paragraph">
<p><a id="jsonApiResource"></a></p>
</div>
<div class="sect2">
<h3 id="_jsonapiresource">4.1. JsonApiResource</h3>
<div class="paragraph">
<p>It is the most important annotation which defines a resource. It requires type parameter to be defined that is used to form a URLs and type field in passed JSONs. According to JSON:API standard, the name defined in type can be either plural or singular</p>
</div>
<div class="paragraph">
<p>The example below shows a sample class which contains a definition of a resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  @JsonApiResource(type = "tasks")
  public class Task {
    // fields, getters and setters
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>type</code> parameter specifies the resource&#8217;s name.</p>
</div>
<div class="paragraph">
<p>By default the type of a resource in a JSON:API document and its name within URLs match, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
  "links": {
    "self": "http://localhost/api/tasks",
  },
  "data": [{
    "type": "tasks",
    "id": "1",
    "attributes": {
      "title": "Some task"
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The optional <code>resourcePath</code> allows to define separate values, typically with <code>resourcePath</code> being plural and
<code>type</code> being singular:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">task</span><span class="delimiter">&quot;</span></span>, resourcePath = <span class="string"><span class="delimiter">&quot;</span><span class="content">tasks</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">public</span> <span class="type">class</span> <span class="class">Task</span> {
    <span class="comment">// fields, getters and setters</span>
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>resulting in (notice the self link does not change, but type does):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
  "links": {
    "self": "http://localhost/api/tasks",
  },
  "data": [{
    "type": "task",
    "id": "1",
    "attributes": {
      "title": "Some task"
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="jsonApiResourcePagingBehavior"></a></p>
</div>
<div class="paragraph">
<p>The optional <code>pagingSpec</code> parameter allows to set the desired paging specification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">tasks</span><span class="delimiter">&quot;</span></span>, pagingSpec = OffsetLimitPagingSpec.class)
  <span class="directive">public</span> <span class="type">class</span> <span class="class">Task</span> {
    <span class="comment">// fields, getters and setters</span>
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is built-in support for <code>OffsetLimitPagingSpec</code> (default) or <code>NumberSizePagingSpec</code>. The paging spec must
be backed by a matching <code>PagingBehavior</code> implementation.  More detailed information about pagination can be
found at <a href="#pagination">Pagination</a> section.</p>
</div>
<div class="paragraph">
<p>The optional <code>subTypes</code> parameter allows to specify an inheritance relationship to other resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">task</span><span class="delimiter">&quot;</span></span>, subTypes = SpecialTask.class)
  <span class="directive">public</span> <span class="type">class</span> <span class="class">Task</span> {
    <span class="comment">// fields, getters and setters</span>
  }

  <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">specialTask</span><span class="delimiter">&quot;</span></span>, resourcePath = <span class="string"><span class="delimiter">&quot;</span><span class="content">task</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">public</span> <span class="type">class</span> <span class="class">SpecialTask</span> <span class="directive">extends</span> Task{
    <span class="comment">// fields, getters and setters</span>
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the <code>SpecialTask</code> extends <code>Task</code> but shares the same <code>resourcePath</code>, meaning <code>SpecialTask</code> does not bring along
a repository implementation (see next chapter), but is served by the task repository. For a more information have a look at the
<a href="#inheritance">[inheritance]</a> section.</p>
</div>
<div class="paragraph">
<p>@JsonApiResource has properties to configure the allowed access modes to a resource:
sortable, filterable, postable, readable, patchable and deletable. An example looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">tasks</span><span class="delimiter">&quot;</span></span>,
            postable = <span class="predefined-constant">false</span>, readable = <span class="predefined-constant">false</span>, patchable = <span class="predefined-constant">false</span>, deletable = <span class="predefined-constant">false</span>,
            sortable = <span class="predefined-constant">false</span>, filterable = <span class="predefined-constant">false</span>
    )
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">AccessDeniedTestResource</span> {

        <span class="annotation">@JsonApiId</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> id;

        <span class="directive">public</span> <span class="predefined-type">String</span> value;

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The properties match the ones from @JsonApiField and provide the base line for it.
For example, if a resource does not allow filtering, none of its fields will either.
If one of those properties is attempted to be violated, an error is thrown.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapiid">4.2. JsonApiId</h3>
<div class="paragraph">
<p>Defines a field which will be used as an identifier of a resource.
Each resource requires this annotation to be present on a field which type implements <code>Serializable</code> or is of primitive type.</p>
</div>
<div class="paragraph">
<p>The example below shows a sample class which contains a definition of a field which contains an identifier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">tasks</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Task</span> {
<span class="annotation">@JsonApiId</span>
<span class="directive">private</span> <span class="predefined-type">Long</span> id;

<span class="comment">// fields, getters and setters</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="jsonApiRelation"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapirelation">4.3. JsonApiRelation</h3>
<div class="paragraph">
<p>Indicates a relationship to either a single value or collection of resources. The type of such fields
must be a valid resource. The next example showcases a bi-directional relationship between <code>Task</code> and <code>Project</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">tasks</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Task</span> {

    <span class="annotation">@JsonApiRelation</span>
    <span class="directive">private</span> Project project;

    ...
}

<span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">project</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Project</span> {

    <span class="annotation">@JsonApiRelation</span>(mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">project</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;Task&gt; tasks;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>project</code> and <code>tasks</code> field are linked through the <code>mappedBy</code> property by pointing from the non-owning
to the owning field of the relationship. <code>project</code> as owning field will be used for all read and update operations. This
means:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for <code>GET /api/projects?include=tasks</code> and <code>GET /api/projects/{id}/tasks</code>, first the projects are loaded and then
a query is issued against the repository of <code>Task</code> with a filter <code>project.id = {list of project ids}</code>.</p>
</li>
<li>
<p>for <code>PATCH/POST/DELETE /api/project/{id}/tasks</code>, the request is forwarded
to the <code>Task</code> repository by setting the <code>project</code> field and saving the updated resources.</p>
</li>
<li>
<p>for <code>PATCH/POST /api/projects/{id}</code> the <code>tasks</code> attribute can by default not be modified because it is not the owner
of the relationships. But repositories are free to implement this functionality if desired.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Behind the scenes <code>mappedBy</code> makes use of the <code>FORWARD_OPPOSITE</code> repository behavior whereas the opposite
makes use of <code>FORWARD_OWNER</code> that are explained further down in this section. As such <code>mappedBy</code> can be
considered to be a shortcut for setting various other notifications that is useful in many scenarios.
The semantics of <code>mappedBy</code> matches with the concepts of, for example, JPA-related annotations.
It is typical for single-valued fields like <code>project</code> to be the owner. Such fields are usually backed by something like
a column in a database and are simple to read and write. In contrast,
multi-valued fields like <code>tasks</code> can only be obtained by issuing a query against the single-valued counter-part.
In such a setting, it might proof useful to to make use of <a href="#jsonApiRelationId">@JsonApiRelationId</a>
on the owning side (introduced in the next section).</p>
</div>
<div class="paragraph">
<p>@JsonApiRelation comes with a number of attributes to customize its behavior.
<a href="#jsonApiRelationId">@JsonApiRelationId</a> as complementary annotation is introduced in the subsequent section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiRelation</span>(serialize = SerializeType.ONLY_ID)
<span class="directive">private</span> Project project;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The optional <code>serialize</code> parameter specifies how an association should be serialized when making a request.
There are two things to consider. Whether related resources should be added to the <code>include</code> section of the
response document. And whether the id of related resources should be serialized along with the resource
in the corresponding <code>relationships.[name].data</code> section. Either <code>LAZY</code>, <code>ONLY_ID</code> or <code>EAGER</code> can be specified:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LAZY</code> only serializes the ID and does the inclusion if explicitly requested by the <code>include</code> URL parameter. This is the default.</p>
</li>
<li>
<p><code>ONLY_ID</code> always serializes the ID, but does only to an inclusion  if explicitly requested by the <code>include</code> URL parameter.</p>
</li>
<li>
<p><code>EAGER</code> always both serializes the ID and does an inclusion. Be aware of performance implication when enabling this.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiRelation</span>(lookUp = LookupIncludeBehavior.AUTOMATICALLY_ALWAYS)
<span class="directive">private</span> Project project;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JSON:API comes with support for inclusions based on the <code>include</code> parameter. It allows to request complex
object graphs where also related resources can be fetched.  There are two possibilities of how this is implemented.
Either the requested repository also directly returns related resources with the returned ones. Or Crnk can take-over that
work by doing nested calls to adjacent <code>ResourceRepository</code>, <code>OneRelationshipRepository</code> and <code>ManyRelationshipRepository</code>
implementations. The behavior is controlled by the optional <code>lookUp</code> parameter. There are four options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NONE</code> makes the requested repository responsible for returning related resources.</p>
</li>
<li>
<p><code>AUTOMATICALLY_WHEN_NULL</code> will let Crnk lookup related resources if not already done by the requested repository.</p>
</li>
<li>
<p><code>AUTOMATICALLY_ALWAYS</code> will force Crnk to always lookup related resource regardless whether it is already done by the requested repository.</p>
</li>
<li>
<p><code>DEFAULT</code> attempts to find the optimal setting automatically. If a custom relationship repository is found,
<code>@JsonApiRelationId</code> is in use or <code>@JsonApiRelation.repositoryBehavior</code> fetches from the opposite side, then
 <code>AUTOMATICALLY_WHEN_NULL</code> is chosen, otherwise it falls back to <code>NONE</code>. This default behavior should
 be sufficient for most use cases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many different ways how a relationship may end-up being implemented. In the best case, no implementation is necessary
at all and requests can be dispatches to one of the two related resource repositories. The <code>repositoryBehavior</code> allows
to configure behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CUSTOM</code> expects a custom implementation.</p>
</li>
<li>
<p><code>FORWARD_OWNER</code> forward any relationship request to the owning resource repository, the repository that defines the
requested relationship field. GET requests will fetch the owning resources and grab the related resources from there (with the
appropriate inclusion parameter). This assumes that the owning resource properties hold the related resources
(or at least there IDs in case of <code>JsonApiRelationId</code>, see below).
POST, PATCH, DELETE requests will update the properties of the owning resource accordingly and invoke a save operation on the
owning resource repository. An implementation is provided by <code>ImplicitOwnerBasedRelationshipRepository</code>.</p>
</li>
<li>
<p><code>FORWARD_GET_OPPOSITE_SET_OWNER</code> works like <code>FORWARD_OWNER</code> for PATCH, POST, DELETE methods. In contrast,
GET requests are forwarded to the opposite resource repository. For example,
 if there is a relationship between <code>Task</code> and <code>Project</code> with the <code>project</code> and <code>tasks</code> relationship fields. To get all tasks of
 a project, the task repository will be queried with a <code>project.id=&lt;projectId&gt;</code> filter parameter.
 Relational database are one typical example where this pattern fits nicely. In contract to <code>IMPLICIT_FROM_OWNER</code> only a
 single resource repository is involved with a slightly more complex filter parameter, giving performance benefits.
 An implementation is provided by <code>RelationshipRepositoryBase</code>.</p>
</li>
<li>
<p><code>FORWARD_OPPOSITE</code> the opposite to <code>FORWARD_OWNER</code>. Querying works like <code>IMPLICIT_GET_OPPOSITE_MODIFY_OWNER</code>.</p>
</li>
<li>
<p><code>DEFAULT</code> makes use of <code>FORWARD_OWNER</code> if the relationship makes use of <code>@JsonApiRelationId</code> (see below),
<code>lookUp=NONE</code> or <code>lookUp=DEFAULT</code>. <code>FORWARD_OPPOSITE</code> if <code>mappedBy</code> points to another field. <code>CUSTOM</code> if a
 matching relationship repository is found. For all other scenarios it it expects a custom implementation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The forwarding behaviors are implemented by <code>ForwardingRelationshipRepository</code>.</p>
</div>
<div class="paragraph">
<p>The subsequent two resources show case a number of scenarios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">task</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Task</span> {
    <span class="annotation">@JsonApiId</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> id;

    <span class="annotation">@JsonApiRelation</span> <span class="comment">// not backed by repository</span>
    <span class="directive">public</span> Project project;

    <span class="annotation">@JsonApiRelation</span> <span class="comment">// backed by repository</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Task&gt; subTasks;
}

<span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">project</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Project</span> {
    <span class="annotation">@JsonApiId</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> id;

    <span class="annotation">@JsonApiRelation</span>(mappedBy = <span class="string"><span class="delimiter">&quot;</span><span class="content">project</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;Task&gt; tasks;

    <span class="annotation">@JsonApiRelationId</span>
    <span class="directive">public</span> Project parentId;

    <span class="annotation">@JsonApiRelation</span>
    <span class="directive">public</span> Project parent;
}

<span class="type">class</span> <span class="class">SubTaskRepository</span> <span class="directive">extends</span> OneRelationshipRepositoryBase {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> RelationshipMatcher getMatcher() {
        RelationshipMatcher matcher = <span class="keyword">new</span> RelationshipMatcher();
        matcher.rule().field(<span class="string"><span class="delimiter">&quot;</span><span class="content">subTasks</span><span class="delimiter">&quot;</span></span>).add();
        <span class="keyword">return</span> matcher;
    }
    ...
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parent</code> has a <code>@JsonApiRelationId</code> backed by <code>parentId</code>. This triggers the use
of <code>RelationshipRepositoryBehavior.FORWARD_OWNER</code> and <code>LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL</code>.
Only <code>parentId</code> must be populated by the project resource repository, <code>project</code> can
then be looked up on the opposite resource repository (which in this case is the same repository).</p>
</li>
<li>
<p><code>project</code> just carries an empty <code>@JsonApiRelation</code> and has no relationship repository backing it. This
triggers the assumption that the resource repository can handle all requests, translating to
<code>LookupIncludeBehavior.NONE</code> and <code>RelationshipRepositoryBehavior.FORWARD_OWNER</code>.</p>
</li>
<li>
<p><code>tasks</code> declares a <code>mappedBy</code> to its owner <code>project</code>. Accordingly all requests go with
<code>RelationshipRepositoryBehavior.FORWARD_OPPOSITE</code> to the opposite task resource repository. Inclusions
are resolved automatically with <code>LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL</code>.</p>
</li>
<li>
<p><code>subTasks</code> is backed by the <code>SubTaskRepository</code> relationship repository. This
sets <code>RelationshipRepositoryBehavior.CUSTOM</code> and performs look-ups on that repository with
<code>LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL</code> to compute the inclusions.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
It likely takes a moment to familiarize oneself with all configuration options of <code>@JsonApiRelation</code> and the
  subsequent <code>@JsonApiRelationId</code>. But at the same time it is one area where a native resource-oriented REST library like Crnk
  can provide significant benefit and reduce manual work compared to more classical REST libraries like Spring MVC or JAX-RS.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you run into problems in this area, set <code>io.crnk</code> to <code>DEBUG</code> in your logger. It will print information such as:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>20:04:50 DEBUG io.crnk.test.mock.models.Schedule.project: using configured LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.projects: using configured LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.tasks: choosing default RelationshipRepositoryBehavior: mappedBy enforces FORWARD_OPPOSITE
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.tasks: setting up opposite/opposite forwarding repository
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.tasks: RelationshipRepositoryBehavior.FORWARD_OPPOSITE enforces LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL to resolve relationship from opposite side
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.project: choosing default RelationshipRepositoryBehavior: relationId field enforces FORWARD_OWNER
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.project: setting up owner/owner forwarding repository
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.projects: choosing default RelationshipRepositoryBehavior: relationId field enforces FORWARD_OWNER
20:04:50 DEBUG io.crnk.test.mock.models.Schedule.projects: setting up owner/owner forwarding repository</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="jsonApiRelationId"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapirelationid">4.4. JsonApiRelationId</h3>
<div class="paragraph">
<p>Fields annotated with <code>@JsonApiRelation</code> hold fully-realized related resources. There are situations
where the id of a related resource is available for free or can be obtained much more cheaply then
fetching the entire related resource. In this case resources can make use of fields annotated with
<code>@JsonApiRelationId</code>. The complement <code>@JsonApiRelation</code> fields by holding there ID only.
An example looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">schedules</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Schedule</span> {
  ...

  <span class="annotation">@JsonApiRelationId</span>
  <span class="directive">private</span> <span class="predefined-type">Long</span> projectId;

  <span class="annotation">@JsonApiRelation</span>
  <span class="directive">private</span> Project project;

  <span class="directive">public</span> <span class="predefined-type">Long</span> getProjectId() {
    <span class="keyword">return</span> projectId;
  }

  <span class="directive">public</span> <span class="type">void</span> setProjectId(<span class="predefined-type">Long</span> projectId) {
    <span class="local-variable">this</span>.projectId = projectId;
    <span class="local-variable">this</span>.project = <span class="predefined-constant">null</span>;
  }

  <span class="directive">public</span> Project getProject() {
    <span class="keyword">return</span> project;
  }

  <span class="directive">public</span> <span class="type">void</span> setProject(Project project) {
    <span class="local-variable">this</span>.projectId = project != <span class="predefined-constant">null</span> ? project.getId() : <span class="predefined-constant">null</span>;
    <span class="local-variable">this</span>.project = project;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that:
- <code>Schedule</code> resource holds both a <code>project</code> and <code>projectId</code> field that point to the same related resource.
- setters must set both properties to make sure they stay in sync. If only the ID is set, the object must be nulled.
- <code>propertyId</code> will never show in requests and responses. It can be considered to be <code>transient</code>.
- Bi-directional relationships can simply make use of <code>@JsonRelationId(mappedBy="project")</code> on the other side.</p>
</div>
<div class="paragraph">
<p>By default, the naming convention for <code>@JsonApiRelationId</code> field is to end with a <code>Id</code> or <code>Ids</code> suffix. Crnk will
the pair those two objects automatically. Trailing <code>s</code> are ignored for multi-valued fields, meaning that <code>projectIds</code> matches with
 <code>projects</code>. But it is also possible to specify a custom name, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiRelationId</span>
<span class="directive">private</span> <span class="predefined-type">Long</span> projectFk;

<span class="annotation">@JsonApiRelation</span>(idField = <span class="string"><span class="delimiter">&quot;</span><span class="content">projectFk</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> Project project;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a <code>@JsonApiRelationId</code> field cannot be matched to a <code>@JsonApiRelation</code> field, an exception will be thrown.</p>
</div>
<div class="paragraph">
<p><code>@JsonApiRelationId</code> fields are used for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET</code> requests to fill-in the <code>data</code> section of a relationship.</p>
</li>
<li>
<p><code>POST</code> and <code>PATCH</code> requests to fill-in the new value without having to fetch and set the entire related resource.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Further (substantial) benefit for <code>@JsonApiRelationId</code> fields is that no <code>RelationshipRepository</code>
must be implemented</strong>. Instead Crnk will automatically dispatch relationship requests to the owning and
opposite <code>ResourceRepository</code>. This allows to focus on the development of <code>ResourceRepository</code>.
See <a href="#relationshipRepository">RelationshipRepository</a> for more information.</p>
</div>
<div class="paragraph">
<p>Next to plain Java objects, many other libraries support this kind of semantic of having two attributes
referring to the same data. For example in JPA this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiRelationId</span>
<span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">project_id</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">Long</span> projectId;

<span class="annotation">@OneToOne</span>(fetch = FetchType.LAZY)
<span class="annotation">@JoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">project_id</span><span class="delimiter">&quot;</span></span>, insertable = <span class="predefined-constant">false</span>, updatable = <span class="predefined-constant">false</span>)
<span class="directive">private</span> ProjectEntity project;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because two fields are mapped to the same column, one must be set to a read-only mode.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapimetainformation">4.5. JsonApiMetaInformation</h3>
<div class="paragraph">
<p>Field or getter annotated with <code>JsonApiMetaInformation</code> are marked to carry a <code>MetaInformation</code> implementation.
See <a href="http://jsonapi.org/format/#document-meta" class="bare">http://jsonapi.org/format/#document-meta</a> for more information about meta data. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">projects</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">public</span> <span class="type">class</span> <span class="class">Project</span> {

                ...

                <span class="annotation">@JsonApiMetaInformation</span>
                <span class="directive">private</span> ProjectMeta meta;

                <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ProjectMeta</span> <span class="directive">implements</span> MetaInformation {

                        <span class="directive">private</span> <span class="predefined-type">String</span> value;

                        <span class="directive">public</span> <span class="predefined-type">String</span> getValue() {
                                <span class="keyword">return</span> value;
                        }

                        <span class="directive">public</span> <span class="type">void</span> setValue(<span class="predefined-type">String</span> value) {
                                <span class="local-variable">this</span>.value = value;
                        }
                }
        }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapilinksinformation">4.6. JsonApiLinksInformation</h3>
<div class="paragraph">
<p>Field or getter annotated with <code>JsonApiLinksInformation</code> are marked to carry a <code>LinksInformation</code> implementation.
See <a href="http://jsonapi.org/format/#document-links" class="bare">http://jsonapi.org/format/#document-links</a> for more information about linking. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">projects</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">public</span> <span class="type">class</span> <span class="class">Project</span> {

                ...

                <span class="annotation">@JsonApiLinksInformation</span>
                <span class="directive">private</span> ProjectLinks links;

                <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ProjectLinks</span> <span class="directive">implements</span> LinksInformation {

                        <span class="directive">private</span> <span class="predefined-type">String</span> value;

                        <span class="directive">public</span> <span class="predefined-type">String</span> getValue() {
                                <span class="keyword">return</span> value;
                        }

                        <span class="directive">public</span> <span class="type">void</span> setValue(<span class="predefined-type">String</span> value) {
                                <span class="local-variable">this</span>.value = value;
                        }
                }
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default links are serialized as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"links": {
  "self": "http://example.com/posts"
}</pre>
</div>
</div>
<div class="paragraph">
<p>With <code>crnk.config.serialize.object.links=true</code> links get serialized as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"links": {
  "self": {
    "href": "http://example.com/posts",
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p><a id="jsonApiField"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapifield">4.7. JsonApiField</h3>
<div class="paragraph">
<p>Field or getter annotated with <code>@JsonApiField</code> allows to define  the behavior of an individual attribute. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">projects</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">public</span> <span class="type">class</span> <span class="class">Project</span> {

                ...

                <span class="annotation">@JsonApiField</span>(postable=<span class="predefined-constant">true</span>, patchable=<span class="predefined-constant">false</span>, sortable=<span class="predefined-constant">false</span>, filterable=<span class="predefined-constant">false</span>)
                <span class="directive">private</span> <span class="predefined-type">Long</span> projectId;

                ...
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Following options are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sortable</code> defines whether a field can be sorted.</p>
</li>
<li>
<p><code>filterable</code> defines whether a field can be filtered.</p>
</li>
<li>
<p><code>postable</code> defines whether a field can be set with a POST request.</p>
</li>
<li>
<p><code>patchable</code> defines whether a field can be changed with a PATCH request.</p>
</li>
<li>
<p><code>deletable</code> defines whether a multi-valued relationship field can be changed with a DELETE request.</p>
</li>
<li>
<p><code>readable</code> defines whether a field can be read with a GET request.</p>
</li>
<li>
<p><code>patchStrategy</code> defines the behavior of value with PATCH request. It can be either <code>MERGE</code> if you want the value be merged with an original one or <code>SET</code> if you want the value be totaly replaced with a new one.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The same fields are available from <a href="#jsonApiResource">@JsonApiResource</a> to configure a default for all fields of that
resource.</p>
</div>
<div class="paragraph">
<p><a id="jackson_annotations"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_jackson_annotations">4.8. Jackson annotations</h3>
<div class="paragraph">
<p>Crnk comes with (partial) support for Jackson annotations. Currently supported are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JsonIgnore</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Excludes a given attribute from serialization.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JsonProperty.value</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renames an attribute during serialization.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JsonProperty.access</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies whether an object can be read and/or written.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@JsonAnyGetter</code> and <code>@JsonAnySetter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To map dynamic data structures to JSON. For an example have a look at
  <a href="https://github.com/crnk-project/crnk-example/blob/master/crnk-example-service/src/main/java/io/crnk/example/service/model/PersonEntity.java">PersonEntity</a>
  from the example application.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Support for more annotations will be added in the future. PRs welcomed.</p>
</div>
<div class="paragraph">
<p><a id="nested_resources"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_nested_resources">4.9. Nested Resources</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This feature is experimental and will be refined in subsequent releases.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A resource may be nested and belong to a parent resource. URLs then look like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><a href="http://example.com/posts/1/header" class="bare">http://example.com/posts/1/header</a></code> (single)</p>
</li>
<li>
<p><code><a href="http://example.com/posts/1/comments/2" class="bare">http://example.com/posts/1/comments/2</a></code> (multiple)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here a <code>post</code> resource holds two nested relationships: <code>header</code> and <code>comments</code>. Both of those relationships have resources
that cannot exist without the <code>post</code> itself. The former case the relationship holds a single resource, while the later
there might be multiple comments.</p>
</div>
<div class="paragraph">
<p>Nested resources are implemented like any other resource, most notably by providing a resource repository.
The subsequent two section go into detail how to setup such resources.</p>
</div>
<div class="sect3">
<h4 id="_single_nested_resources">4.9.1. Single Nested Resources</h4>
<div class="paragraph">
<p>Single nested resources share the identifier with the parent resource. From the example aboce:</p>
</div>
<div class="paragraph">
<p><code><a href="http://example.com/posts/1/header" class="bare">http://example.com/posts/1/header</a></code></p>
</div>
<div class="paragraph">
<p>Both the <code>post</code> and its <code>header</code> share the identifier <code>1</code>. A resource looks like:</p>
</div>
<div class="listingblock">
<div class="title">PostHeader.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>, nested = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PostHeader</span> {

        <span class="annotation">@JsonApiId</span>
        <span class="annotation">@JsonApiRelationId</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> postId;

        <span class="directive">private</span> <span class="predefined-type">String</span> value;

        <span class="annotation">@JsonApiRelation</span>(opposite = <span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>, lookUp = LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL,
                        repositoryBehavior = RelationshipRepositoryBehavior.FORWARD_OWNER)
        <span class="directive">private</span> Post post;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>nested = true</code> and that the ID also serves as <code>@JsonApiRelationId</code> to point to the parent <code>post</code>. This two
properties introduce the singular nesting to the resource. The repository itself can then be implemented like any other
repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_nested_resources">4.9.2. Multiple Nested Resources</h4>
<div class="paragraph">
<p>To nest multiple resource below a parent, structured identifier can be used:</p>
</div>
<div class="listingblock">
<div class="title">PostCommendId.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonSerialize</span>(using = ToStringSerializer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PostCommentId</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

        <span class="annotation">@JsonApiId</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> id;

        <span class="annotation">@JsonApiRelationId</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> postId;

        <span class="directive">public</span> PostCommentId() {
        }

        <span class="directive">public</span> PostCommentId(<span class="predefined-type">String</span> idString) {
                <span class="predefined-type">String</span><span class="type">[]</span> elements = idString.split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">-</span><span class="delimiter">&quot;</span></span>);
                postId = elements[<span class="integer">0</span>];
                id = elements[<span class="integer">1</span>];
        }

        <span class="directive">public</span> PostCommentId(<span class="predefined-type">String</span> postId, <span class="predefined-type">String</span> id) {
                <span class="local-variable">this</span>.postId = postId;
                <span class="local-variable">this</span>.id = id;
        }

        <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
                <span class="keyword">return</span> id;
        }

        <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">String</span> id) {
                <span class="local-variable">this</span>.id = id;
        }

        <span class="directive">public</span> <span class="predefined-type">String</span> getPostId() {
                <span class="keyword">return</span> postId;
        }

        <span class="directive">public</span> <span class="type">void</span> setPostId(<span class="predefined-type">String</span> postId) {
                <span class="local-variable">this</span>.postId = postId;
        }

        <span class="directive">public</span> <span class="type">int</span> hashCode() {
                <span class="keyword">return</span> toString().hashCode();
        }

        <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> object) {
                <span class="keyword">return</span> object <span class="keyword">instanceof</span> PostCommentId &amp;&amp; object.toString().equals(toString());
        }

        <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
                <span class="keyword">return</span> postId + <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> + id;
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The id is setup of two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the local identifier of the child resource, annotated with <code>@JsonApiId</code>. It must be unique among all nested resources having the same parent.</p>
</li>
<li>
<p>the identifier of the parent resource, annotated with a <code>@JsonApiRelationId</code>. The nested resource must have matching relationship field (in this case <code>parent</code>)`.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>PostCommentId</code> further implements <code>public PostCommentId(String idString)</code>, <code>toString</code>, <code>hashCode</code> and <code>equals</code> and carries the
<code>@JsonSerialize(using = ToStringSerializer.class)</code> annotation to deal with String serialization and equality.</p>
</div>
<div class="paragraph">
<p>The resource itself looks like:</p>
</div>
<div class="listingblock">
<div class="title">PostComment.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">comment</span><span class="delimiter">&quot;</span></span>, nested = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PostComment</span> {

        <span class="annotation">@JsonApiId</span>
        <span class="directive">private</span> PostCommentId id;

        <span class="directive">private</span> <span class="predefined-type">String</span> value;

        <span class="annotation">@JsonApiRelation</span>(opposite = <span class="string"><span class="delimiter">&quot;</span><span class="content">comments</span><span class="delimiter">&quot;</span></span>, lookUp = LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL,
                        repositoryBehavior = RelationshipRepositoryBehavior.FORWARD_OWNER)
        <span class="directive">private</span> Post post;

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usage">4.9.3. Usage</h4>
<div class="paragraph">
<p>For an example have a look at <code>NestedRepositoryClientTest</code> and its parent class. Depending on the use of <a href="#JsonApiExposed">[JsonApiExposed]</a> it
is or is not be possible to also directly access <code><a href="http://example.com/comments" class="bare">http://example.com/comments</a></code> without going
through the parents.</p>
</div>
<div class="paragraph">
<p>When creating new resources with CrnkClient, the nested identifier must be set to let CrnkClient access the postId
to compute URLs.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Nesting is currently limited to a single level (and the possibility to have further relationships on the nested resource).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapiversion">4.10. @JsonApiVersion</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This feature is experimental
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Crnk supports versioning of resources and fields based on content negotiation.
Any resource and field can carry a version range where it is available.
Crnk will disregard any resource and field with a version range that does not intersect with the request version.
The HTTP <code>Accept</code> header is used to pass along the desired version as part of general content negotiation.
This has the benefit that URLs remain constant across versions, greatly simplifying usability and linking.
For a more detailed discussion, see here[<a href="https://blog.ploeh.dk/2015/06/22/rest-implies-content-negotiation/" class="bare">https://blog.ploeh.dk/2015/06/22/rest-implies-content-negotiation/</a>].</p>
</div>
<div class="paragraph">
<p>A versioned resource looks like:</p>
</div>
<div class="listingblock">
<div class="title">VersionedTask.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">versionedTask</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@JsonApiVersion</span>(max = <span class="integer">5</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VersionedTask</span> {

    <span class="directive">public</span> <span class="type">enum</span> CompletionStatus {
        DONE,
        OPEN,
        IN_PROGRESS
    }

    <span class="annotation">@JsonApiId</span>
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@JsonApiVersion</span>(min = <span class="integer">1</span>, max = <span class="integer">3</span>)
    <span class="directive">private</span> <span class="type">boolean</span> completed;

    <span class="annotation">@JsonApiVersion</span>(min = <span class="integer">5</span>)
    <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">completed</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> CompletionStatus newCompleted;

}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The resource itself is available up to version 5.</p>
</li>
<li>
<p>The field <code>completed</code> is only available from version 1 to 3.</p>
</li>
<li>
<p>The field <code>newCompleted</code> introduces a new flavor of <code>completed</code> making use of <code>CompletionStatus</code> rather than
a boolean. Through the use of <code>@JsonProperty</code> it is mapped to <code>completed</code> on the REST layer whereas
the Java side has access to both the old and new field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Crnk makes use of integer-based version number to signal major versions with breaking changes. There is
no need for minor versions in this scheme. But applications are free to use additional minor versions in other contexts.</p>
</div>
<div class="paragraph">
<p>A request than carries an accept header like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>GET /api/versionedTask HTTP/1.1
Accept: application/vnd.api+json; version=2</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the version can be passed as URL parameter (easier to use from a browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>GET /api/versionedTask?version=2 HTTP/1.1
Accept: application/vnd.api+json</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#client">CrnkClient</a> supports setting the request version through <code>CrnkClient.setVersion(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>Not supported is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ID fields cannot be versioned.</p>
</li>
<li>
<p>for multiple classes to serve the same resource for different version ranges.
For example, it is not possible to introduce a class <code>VersionedTaskV2.java</code>.
For most use cases it should be sufficient to redefine fields. This may change in the future</p>
</li>
<li>
<p>Meta and link fields cannot be versioned, this may change in the future.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repositories">5. Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The modelled resources and relationships must be complemented by a corresponding
repository implementation. This is achieved by implementing
one of those two repository interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ResourceRepository for resources.</p>
</li>
<li>
<p>RelationshipRepository resp. BulkRelationshipRepository for relationships.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The repositories are used to serve <code>POST</code>, <code>GET</code>, <code>PATCH</code> and <code>DELETE</code> requests as specified by
JSON:API specification. The repository contract closely resembles the JSON:API specification. Subsequent
sections and chapters outline various possibilities to speed-up and potentially reuse existing
repository implementations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When accessing repositories, do not forget to use the <code>application/vnd.api+json</code> content type.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a id="resource_repository"></a></p>
</div>
<div class="sect2">
<h3 id="_resourcerepository">5.1. ResourceRepository</h3>
<div class="paragraph">
<p><code>ResourceRepository</code> is the main interface used to operate on resources with <code>POST</code>, <code>GET</code>, <code>PATCH</code> and <code>DELETE</code> requests.
The interface takes two generic arguments:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The type of a resource. Typically this is a plain Java Bean making use of the JSON:API annotations. But may also be something
entirely different (see <a href="#architectures&gt; and &lt;&lt;modules">[architectures&gt; and &lt;&lt;modules]</a>). One other example is the
<code>io.crnk.core.engine.document.Resource</code> class used to setup dynamically types repositories.</p>
</li>
<li>
<p>The type of the resource’s identifier. Typically a primitive type like <code>String</code>, <code>long</code> or <code>UUID</code>. But if necessary
can also be a more complex type that serializes to a URL-friendly String.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The methods of <code>ResourceRepository</code> look as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>findOne(ID id, QuerySpec querySpec)</code>
Search one resource with a given ID. If a resource cannot be found, a ResourceNotFoundException exception should be thrown
that translates into a <code>404</code> HTTP error status. The returned resource must adhere to the behavior as specifies by
the various annotations (more details in the <a href="#resource">[resource]</a> chapter), most notably the inclusion of relationships as requested
by the passed <code>querySpec</code> as long as <code>LookupIncludeBehavior</code> does not specify otherwise. More details about <code>QuerySpec</code>
follow in subsequent sections.</p>
</li>
<li>
<p><code>findAll(Iterable&lt;ID&gt;ids, QuerySpec querySpec)</code>
Allows to bulk request multiple resources, but otherwise work exactly like the preceding <code>findOne</code> method.</p>
</li>
<li>
<p><code>findAll(QuerySpec querySpec)</code>
Search for all resources according to the passed <code>querySpec</code> including sorting, filtering, paging, field sets and inclusions.
A <code>ResourceList</code> must be returned that carries the result resources, links information and meta information.</p>
</li>
<li>
<p><code>create(S resource)</code>
Called by <code>POST</code> requests. The request body is deserialized and passed as <code>resource</code> parameter. The method may or may
not have to generate an ID for the newly created resource. The request body may specify relationship data to point to
other resources. During deserialization, those resources are looked up and the <code>@JsonApiRelation</code> annotated fields set
accordingly. For relationships making use of <code>@JsonApiRelationId</code> annotation, only the identifier will be set without
the resource annotation, allowing to improve for performance. The <code>create</code> method has to save those relationships, but
it does and must not perform any changes on the related resources. For bulk inserting and updating resources, have a look
at the <a href="#operations_module">operations module</a>. The method must return the updated resource, most notably with a valid
identifier.</p>
</li>
<li>
<p><code>save(S resource)</code>
Saves a resource upon a <code>PATCH</code> request. The general semantics is identical to the <code>create(&#8230;&#8203;)</code> method, with two
notable exceptions. First, resources are updated but are not allowed to be inserted.
A <code>ResourceNotFoundException</code> must be thrown if the resource does not exist. Second, the <code>PATCH</code> request
allows for partial updates. Internally Crnk will get the current state of a resource, patch it and pass it to this <code>save</code>
method. A <code>ResourceModificationFilter</code> can be registered to collect information about modified fields and relationships and this way,
for example, distinguish patched from un-patched fields.</p>
</li>
<li>
<p><code>delete(ID id)</code>
Removes a resource identified by id parameter. A <code>ResourceNotFoundException</code> must be thrown if the resource does not exist.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ResourceRepositoryBase is a base class that takes care of some boiler-plate, like implementing findOne with findAll. An
implementation can then look as simple as:</p>
</div>
<div class="listingblock">
<div class="title">Task.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>@JsonApiResource(type = "tasks")
public class Task {

	@JsonApiId
	private Long id;

	@JsonProperty("name")
	private String name;

	@Size(max = 20, message = "Description may not exceed {max} characters.")
	private String description;

	@JsonApiRelationId
	private Long projectId;

	@JsonApiRelation(opposite = "tasks", lookUp = LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL,
			repositoryBehavior = RelationshipRepositoryBehavior.FORWARD_OWNER,
			serialize = SerializeType.ONLY_ID)
	private Project project;

   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="title">TaskRepositoryImpl.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>@Component
public class TaskRepositoryImpl extends ResourceRepositoryBase&lt;Task, Long&gt; implements TaskRepository {

	// for simplicity we make use of static, should not be used in real applications
	private static final Map&lt;Long, Task&gt; tasks = new ConcurrentHashMap&lt;&gt;();

	private static final AtomicLong ID_GENERATOR = new AtomicLong(4);

	public TaskRepositoryImpl() {
		super(Task.class);
	}

	@Override
	public &lt;S extends Task&gt; S save(S entity) {
		if (entity.getId() == null) {
			entity.setId(ID_GENERATOR.getAndIncrement());
		}
		tasks.put(entity.getId(), entity);
		return entity;
	}

	@Override
	public &lt;S extends Task&gt; S create(S entity) {
		if (entity.getId() != null &amp;&amp; tasks.containsKey(entity.getId())) {
			throw new BadRequestException("Task already exists");
		}
		return save(entity);
	}

	@Override
	public Class&lt;Task&gt; getResourceClass() {
		return Task.class;
	}

	@Override
	public Task findOne(Long taskId, QuerySpec querySpec) {
		Task task = tasks.get(taskId);
		if (task == null) {
			throw new ResourceNotFoundException("Task not found!");
		}
		return task;
	}

	@Override
	public ResourceList&lt;Task&gt; findAll(QuerySpec querySpec) {
		return querySpec.apply(tasks.values());
	}


	@Override
	public void delete(Long taskId) {
		tasks.remove(taskId);
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example is taken from
<a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-integration-examples/spring-boot-example/src/main/java/io/crnk/example/springboot/domain/repository">crnk-integration-examples/spring-boot-example</a>.
(the basic Spring boot example from crnk-framework, not the dedicated full-blown one from crnk-example).</p>
</div>
<div class="paragraph">
<p>Together with matching project repository, some URLs to checkout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://127.0.0.1:8080/api/tasks
http://127.0.0.1:8080/api/tasks/1
http://127.0.0.1:8080/api/tasks/1
http://127.0.0.1:8080/api/tasks/1/project
http://127.0.0.1:8080/api/tasks/1/relationships/project
http://127.0.0.1:8080/api/tasks?sort=-name
http://127.0.0.1:8080/api/tasks?sort=-id,name
http://127.0.0.1:8080/api/tasks?sort=-id,name
http://127.0.0.1:8080/api/tasks?sort=id&amp;page[offset]=0&amp;page[limit]=2
http://127.0.0.1:8080/api/tasks?filter[name]=Do things
http://127.0.0.1:8080/api/tasks?filter[name][EQ]=Do things
http://127.0.0.1:8080/api/tasks?filter[name][LIKE]=Do%
http://127.0.0.1:8080/api/tasks?filter[name][EQ]=SomeTask,OtherTask
http://127.0.0.1:8080/api/tasks?fields=name
http://127.0.0.1:8080/api/projects
http://127.0.0.1:8080/api/tasks?include=project
http://127.0.0.1:8080/api/browse/</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may notice that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>links get automatically created.</p>
</li>
<li>
<p><code>totalResourceCount</code> and pagination links are added to the response if the <code>page</code> parameter is applied.</p>
</li>
<li>
<p>related <code>project</code> gets automatically resolved from <code>projectId</code>. No relationship repository is implemented here
due to the use of <code>@JsonApiRelationId</code> (see below).</p>
</li>
<li>
<p>the response gets automatically truncated with the <code>fields</code> parameter, ideally suited for bandwidth sensitive applications.</p>
</li>
<li>
<p>multiple values can be separated by comma, typically repositories will then use an <code>OR</code> and accept and resource matching any of the values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is one small example that <strong>shows the power of native resource-oriented REST libraries</strong>. Implementing a similar API with more
classical REST libraries can be a substantial amount of work.</p>
</div>
<div class="paragraph">
<p>There is further a <code>ReadOnlyResourceRepositoryBase</code> base class that does not allow to override
the create, delete and update methods. <code>crnk-meta</code> accordingly reports
insertable, updateable, deltable for such repositories as false.</p>
</div>
<div class="paragraph">
<p><a id="resource_bulk_repository"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_bulkresourcerepository">5.2. BulkResourceRepository</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Experimental and only supports POST
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similar to <code>ResourceRepository</code> but takes a list of resources for <code>create(&#8230;&#8203;)</code>, <code>save(&#8230;&#8203;)</code> and <code>delete(&#8230;&#8203;)</code>.
Allows a repository to process multiple resources at the same time. A request can be made in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The data section of the request document must includes a collection rather than a single data item.</p>
</li>
<li>
<p>A JSON Patch request whereas multiple changes to the same repository then access the bulk methods.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about bulk processing can be found <a href="#operations">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_query_parameters_with_queryspec">5.3. Query parameters with QuerySpec</h3>
<div class="paragraph">
<p>Crnk passes JSON:API query parameters to repositories trough a QuerySpec parameter. It holds
request parameters like sorting and filtering specified by JSON:API. The subsequent
sections will provide a number of example.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Not everything is specified by JSON:API. For some request parameters only recommendations
are provided as different applications are likely to be in need of different semantics and
implementations. For this reason the engine part in <code>crnk-core</code> makes use of <code>QueryAdapter</code> and allows implementations other than
QuerySpec (like the legacy <code>QueryParams</code>). The mapping of HTTP request parameters to QuerySpec and back
is implemented by <a href="#urlmapper"><code>QuerySpecUrlMapper</code></a> that may can also be extended, customized or replaced.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example showing its use URLs also have a look at the <a href="#resource_repository">ResourceRepository</a> section.</p>
</div>
<div class="paragraph">
<p>The QuerySpec API looks like (further setters available as well):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>	public class QuerySpec {
		public &lt;T&gt; List&lt;T&gt; apply(Iterable&lt;T&gt; resources){...}

		public Long getLimit() {...}

		public long getOffset() {...}

		public PagingSpec getPagingSpec() {...}

		public List&lt;FilterSpec&gt; getFilters() {...}

		public List&lt;SortSpec&gt; getSort() {...}

		public List&lt;IncludeFieldSpec&gt; getIncludedFields() {...}

		public List&lt;IncludeRelationSpec&gt; getIncludedRelations() {...}

		public QuerySpec getQuerySpec(Class&lt;?&gt; resourceClass) {...}

		...
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are <code>Spec</code> class for all major features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FilterSpec</code></p>
</li>
<li>
<p><code>SortSpec</code></p>
</li>
<li>
<p><code>IncludeFieldSpec</code></p>
</li>
<li>
<p><code>IncludeRelationSpec</code></p>
</li>
<li>
<p><code>PagingSpec</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information is given in the subsequent sections.</p>
</div>
<div class="paragraph">
<p>QuerySpec provides a method <code>apply</code> that allows in-memory sorting, filtering and paging
on any <code>java.util.Collection</code>. It is useful for testing, mocking and on smaller datasets to keep
the implementation of a repository as simple as possible.</p>
</div>
<div class="paragraph">
<p><a id="filtering"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_basic_filtering">5.4. Basic Filtering</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The JSON:API specification does not a mandate a specific filtering semantic. Instead
it provides a recommendation that comes by default with Crnk. Depending on the data store
in use, application may choose to extend or replace that default implementation by extending or
replacing <code>DefaultQuerySpecUrlMapper</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Resource filtering can be achieved by providing parameters which start with <code>filter</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /tasks?filter[name]=Super task</code> to filter by name with the default <code>EQ</code> operator.</p>
</li>
<li>
<p><code>GET /tasks?filter[name][EQ]=Super task</code> to filter by name with the <code>EQ</code> operator.</p>
</li>
<li>
<p><code>GET /tasks?filter[name][EQ]=SomeTask,OtherTask</code> to filter by multiple <code>OR</code>-ed values.</p>
</li>
<li>
<p><code>GET /tasks?filter[name][LIKE]=Super%</code> to filter by name with the <code>LIKE</code> operator using <code>%</code> as wildcard.</p>
</li>
<li>
<p><code>GET /tasks?filter[address.plz][EQ]=Super task</code> to filter by attribute <code>name</code> within a structured or related attributes <code>address</code>.</p>
</li>
<li>
<p><code>GET /tasks?filter[address.city][EQ]=Super task</code> to filter by attribute <code>city</code> within a structured or related attributes <code>address</code>.</p>
</li>
<li>
<p><code>GET /tasks?filter[name]=Super task&amp;filter[dueDate][GT]=2015-10-01</code></p>
</li>
<li>
<p><code>GET /tasks?filter[name]=null</code> to filter by <code>name</code> being equals <code>null</code>.</p>
</li>
<li>
<p><code>GET /tasks?filter[tasks][name]=Super task</code> is the longer version of <code>/tasks/?filter[name]=Super task</code> where the <code>tasks</code> type is explicitly stated.
See the subsequent <a href="#inclusion">[inclusion]</a> section how to use this to perform filtering of related resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A filter parameter is represented by a <code>FilterSpec</code>. It holds the path to the attribute,
the operator and the filter value. The attribute specifies what gets filtered. The operator
specifies how it is filtered. And the value specifies after what should be filtered.</p>
</div>
<div class="paragraph">
<p>An example looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>FilterSpec filterSpec = PathSpec.of("person", "address", "city").filter(FilterOperator.EQ, "Zurich");
Filterspec filterSpec = new FilterSpec(PathSpec.of("person.address.city"), FilterOperator.NEQ, "Zurich");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The filter value  <code>FilterSpec.value</code> is strongly typed. Typically (by default) it is assumed
that the filter value matches the attribute type and Crnk will attempt to parse passed String-based
filter value accordingly. There are exceptions, for example, the LIKE filter operator always requires
the filter value to be a string to support wildcards for not just String types, but also Enums
and other types (the underlying <code>FilterOperator</code> implementation can specify this with <code>getFilterType(&#8230;&#8203;)</code>).</p>
</div>
<div class="paragraph">
<p>Operators within <code>FilterSpec</code> are represented by the <code>FilterOperator</code> class.
By default, QuerySpec uses the <code>EQ</code> operator if no operator was provided.
Crnk comes with a set of default filters:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Descriptor</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EQ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">equals operator where values match exactly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NEQ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not equals where values do not match.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">where the value matches the specified pattern. It is usually
 not case-sensitive and makes use of <code>%</code> as wildclard, but
 may different depending on the underlying implementation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lower than the specified value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lower than or equals the specified value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">greater than the specified value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">greater than or equals the specified value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>By default the filtering process is quite opinionated and should fit many typical patterns.
But there also many possibilities to customize its behavior to the use case at hand.
For this purpose <a href="#CrnkBoot">[CrnkBoot]</a> offers access to the <code>DefaultQuerySpecUrlMapper</code> with <code>CrnkBoot.getUrlMapper()</code>
and <code>TypeParser</code> with <code>CrnkBoot.getModuleRegistry().getTypeParser()</code> (or <code>ModuleContext</code>).
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TypeParser</code> allows to register and override the parsing of Strings to other classes.
By default it has has built-in parsers for various JRE classes. Custom <code>StringMapper</code>
 can be registered. As fallback it will make use of the <code>ObjectMapper</code> of Jackson
 (which in most cases will be also the default).</p>
</li>
<li>
<p><code>DefaultQuerySpecUrlMapper.setIgnoreParseExceptions(&#8230;&#8203;)</code> allows to ignore if parsing
of a filter value fails. In this case the filter value is left as String and it is
assumed the repository itself will take care of the parsing.</p>
</li>
<li>
<p><code>CrnkBoot.setAllowUnknownAttributes</code> ignore unknown attributes and passes them as is to
the repositories to handle them. More information in the <a href="#properties">[properties]</a> section.</p>
</li>
<li>
<p>The application is free to implements custom <code>FilterOperator</code>. Next to the name
a <code>matches</code> method can be implemented to support in-memory filtering
with <code>QuerySpec.apply</code>. Otherwise, it is up to the repository implementation
to handle the various filter operators; usually by translating them
to datastore-native query expressions. Custom operators can be registered
with <code>DefaultQuerySpecUrlMapper.addSupportedOperator(..)</code>. The default operator can be
overridden by setting <code>DefaultQuerySpecUrlMapper.setDefaultOperator(&#8230;&#8203;)</code>.
For more information see  <a href="#urlmapper"><code>QuerySpecUrlMapper</code></a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="nested_filtering"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_nested_filtering">5.5. Nested Filtering</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This feature is experimental. Please provide feedback.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The url patterns from the previous section allow to <code>AND</code> multiple filter conditions. For scenarios where
this is insufficient, it is also possible to specify more complex filter specifications through JSON.
The subsequent example filters projects by either their <code>name</code> being equals <code>Great Project</code> or its <code>id</code>
being smaller or equals 122.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://127.0.0.1:8080/projects?filter={"OR": {"name": "Great Project", "LE": {"id": 122}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JSON field names matching an operator can be used in two different ways: to setup arbitrary nesting
of <code>AND</code>, <code>OR</code>, <code>NOT</code> or to specify an operator for field, name pair like <code>{"id": 122}</code>.</p>
</li>
<li>
<p>JSON field names matching a resource field name can also be used in two different ways: to filter the
attribute by the specified value or to setup nested attributes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some further examples:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To require a single attribute to equal a value:</p>
<div class="literalblock">
<div class="content">
<pre>{"name": "test"}</pre>
</div>
</div>
</li>
<li>
<p>To require a single attribute to equal a value from within a set:</p>
<div class="literalblock">
<div class="content">
<pre>{"id": [12, 13, 14]}</pre>
</div>
</div>
</li>
<li>
<p>To filter by multiple attributes with the <code>OR</code> operator:</p>
<div class="literalblock">
<div class="content">
<pre>{ "OR": [ {"id": [12, 13, 14]}, {"completed": "true"} ] }</pre>
</div>
</div>
</li>
<li>
<p>To filter by multiple attributes with the <code>AND</code> operator:</p>
<div class="literalblock">
<div class="content">
<pre>{ "AND": [ {"id": [12, 13, 14]}, {"completed": "true"} ] }</pre>
</div>
</div>
<div class="paragraph">
<p>or more simply:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{"id": [12, 13, 14], "completed": "true" }</pre>
</div>
</div>
</li>
<li>
<p>To nest <code>AND</code>, <code>OR</code>, <code>NOT</code> operators:</p>
<div class="literalblock">
<div class="content">
<pre>{"name": "Great Task", "OR": {"id": 122, "name": "Other Task"}}</pre>
</div>
</div>
</li>
<li>
<p>To filter an attribute <code>name</code> on relationship <code>assignee</code>:</p>
<div class="literalblock">
<div class="content">
<pre>{"assignee": {"name": "test"}}</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="sorting"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_sorting">5.6. Sorting</h3>
<div class="paragraph">
<p>Sorting information for the resources can be achieved by providing <code>sort</code> parameter.</p>
</div>
<div class="paragraph">
<p><code>GET /tasks?sort=name,-shortName</code>
<code>GET /tasks?sort=assignee.firstName,assignee.lastName</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sorting parameters are represented by <code>SortSpec</code> within <code>QuerySpec</code> similar to <code>FilterSpec</code> above.</p>
</li>
<li>
<p><code>-</code> is used to denote to sort in descending order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example in Java looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>SortSpec sortSpec = PathSpec.of("person", "address", "city").sort(Direction.ASC);
SortSpec sortSpec = new SortSpec(PathSpec.of("person.address.city"), Direction.DESC);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="pagination"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_pagination">5.7. Pagination</h3>
<div class="sect3">
<h4 id="_offsetlimit_paging">5.7.1. Offset/Limit Paging</h4>
<div class="paragraph">
<p>Crnk comes by default with support for offset/limit paging:</p>
</div>
<div class="paragraph">
<p><code>GET /tasks?page[offset]=0&amp;page[limit]=10</code></p>
</div>
<div class="paragraph">
<p>The parameters are then available with <code>QuerySpec.getPaging(type)</code> or the shortcuts <code>QuerySpec.getLimit</code> and <code>QuerySpec.getOffset</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_numbersize_paging">5.8. Number/Size Paging</h3>
<div class="paragraph">
<p>Support for number/size-based paging can be enabled by registering the <code>NumberSizePagingBehavior</code> in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>register <code>NumberSizePagingBehavior.createModule()</code></p>
</li>
<li>
<p>register <code>NumberSizePagingBehavior</code> directly to service discovery.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Paging parameters can then look like:</p>
</div>
<div class="paragraph">
<p><code>GET /tasks?page[number]=1&amp;page[size]=10</code></p>
</div>
<div class="paragraph">
<p>Internally Crnk is able to translate between offset/limit and number/size-based paging. If
a repository has been implemented with offset/limit paging, it works equally well when number/size paging is used.
The conversion takes place automatically when invoking <code>QuerySpec.getPaging(desiredPagingType)</code>.</p>
</div>
<div class="sect3">
<h4 id="_pagination_links">5.8.1. Pagination Links</h4>
<div class="paragraph">
<p>JSON:API specifies <code>first</code>, <code>previous</code>, <code>next</code> and <code>last</code> links (see <a href="http://jsonapi.org/format/#fetching-pagination" class="bare">http://jsonapi.org/format/#fetching-pagination</a>).
The <code>PagedLinksInformation</code> interface provides a Java representation of those links that can be implemented and returned
by repositories along with the result data. There is a default implementation named <code>DefaultPagedLinksInformation</code>.</p>
</div>
<div class="paragraph">
<p>There are two ways to let Crnk compute pagination links automatically:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The repository returns meta information implementing <code>PagedMetaInformation</code>. With this interface the total
number of (potentially filtered) resources is passed to Crnk, which in turn allows the computation of the links.</p>
</li>
<li>
<p>The repository returns meta information implementing <code>HasMoreResourcesMetaInformation</code>. This interface
only specifies whether further resources are available after the currently requested resources. This
lets Crnk compute all except the <code>last</code> link.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that for both approaches the repository has to return either no links or links information implementing
<code>PagedLinksInformation</code>. If the links are already set, then the computation will be skipped.</p>
</div>
<div class="paragraph">
<p>The potential benefit of the second over the first approach is that it might be easier to just
determine whether more resources are available rather than counting all resources.
This is typically achieved by querying <code>limit + 1</code> resources.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_strategies">5.8.2. Custom strategies</h4>
<div class="paragraph">
<p><code>OffsetLimitPagingBehavior</code> and <code>OffsetLimitPagingSpec</code> and <code>NumberSizePagingBehavior</code> and <code>NumberSizePagingSpec</code>
are two implementations of <code>PagingBehavior</code> and <code>PagingSpec</code>. Applications are free to add further implementations
or replace the existing ones. In order to do so, you would have to perform the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide an instance of a custom <code>PagingBehavior</code> implementation.</p>
</li>
<li>
<p>Register the <code>PagingBehavior</code> to Spring. There are two possibilities:</p>
<div class="ulist">
<ul>
<li>
<p>through the service discovery mechanism like CDI or Spring.</p>
</li>
<li>
<p>through a new module with:</p>
<div class="literalblock">
<div class="content">
<pre>SimpleModule module = new SimpleModule("myPaging");
module.addPaginationBehavior(new MyPaginationBehavior());</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Make use of the new pagination strategy for your resources:</p>
<div class="ulist">
<ul>
<li>
<p>by default the first pagination behavior will become the default for all resources.</p>
</li>
<li>
<p>by explicitly specify which resource makes use of which paging specification with
<a href="#jsonApiResourcePagingBehavior">@JsonApiResource.pagingSpec</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For examples have a look at the <code>OffsetLimitPagingBehavior</code> and <code>OffsetLimitPagingSpec</code> or
<code>NumberSizePagingBehavior</code> and <code>NumberSizePagingSpec</code> implementations.</p>
</div>
<div class="paragraph">
<p>There is the possibility for a <code>PagingBehavior</code> to serve multiple <code>PagingSpec</code>. This is used, for example,
by <code>NumberSizePagingBehavior</code> to translate <code>number</code> and <code>size</code> to <code>offset</code> and <code>limit</code> for repositories
that are based on <code>OffsetLimitPagingSpec</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sparse_fieldsets">5.9. Sparse Fieldsets</h3>
<div class="paragraph">
<p>Information about fields to include in the response can be achieved by providing <code>fields</code> parameter:</p>
</div>
<div class="paragraph">
<p><code>GET /tasks?fields=name,description</code></p>
</div>
<div class="paragraph">
<p><a id="inclusion"></a></p>
</div>
<div class="sect3">
<h4 id="_inclusion_of_related_resources">5.9.1. Inclusion of Related Resources</h4>
<div class="paragraph">
<p>Information about relationships to include in the response can be achieved by providing an <code>include</code> parameter. Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /tasks?include=project</code> performs an inclusion of <code>project</code>.</p>
</li>
<li>
<p><code>GET /tasks?include=assignee,project</code> performs an inclusion of <code>project</code> and <code>assignee</code>.</p>
</li>
<li>
<p><code>GET /tasks?include=assignee.address</code> performs a nested inclusion of <code>assignee</code> within <code>owner</code>.</p>
</li>
<li>
<p><code>GET /tasks/1?include=project</code> performs an inclusion of <code>project</code> for the task with id <code>1</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is not only possible to include related resources, but also to use all other query features like sorting and filtering. In this
case the parameters must be prefixed with the resource type such as <code>[project]</code> to sort and filter the related project:</p>
</div>
<div class="paragraph">
<p><code>GET /tasks?include=project&amp;sort[project]=name&amp;filter[project][name]=someProject</code></p>
</div>
<div class="paragraph">
<p>It is important to note that the requested main resource is NOT affected by <code>[project]</code>. To rather sort all tasks by the related project
make use of:</p>
</div>
<div class="paragraph">
<p><code>GET /tasks?include=project&amp;sort=project.name&amp;filter[project.name]=someProject</code></p>
</div>
<div class="paragraph">
<p>Internally QuerySpec holds the value for a given resource type. If parameters for other resource types, multiple
QuerySpec instances are used. Repositories are then accessed with the QuerySpec matching the repository.
The QuerySpec for a particular resource type can be obtained with <code>QuerySpec.getRelatedSpec(Class)</code> on the root QuerySpec.</p>
</div>
<div class="paragraph">
<p><a id="urlmapper"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_url_mapping">5.10. URL Mapping</h3>
<div class="paragraph">
<p>The mapping of request parameters to QuerySpec and back is implemented by <code>QuerySpecUrlMapper</code>.
With <code>DefaultQuerySpecUrlMapper</code> there is a default implementation that follows the JSON:API
specification and recommendations and introduces some further defaults as documented
in the previous sections (like the filter operators) where the recommendations
do not go far enough. The used <code>QuerySpecUrlMapper</code> can be obtained
from <code>CrnkBoot.getUrlMapper()</code> and <code>CrnkClient.getUrlMapper()</code>. Matching setter allow to
setup a custom implementation.</p>
</div>
<div class="paragraph">
<p><code>DefaultQuerySpecUrlMapper</code> comes with a number of customization options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>setAllowUnknownAttributes(boolean)</code>
<code>DefaultQuerySpecUrlMapper</code> validates all passed parameters against the domain model and fails
if one of the attributes is unknown. This flag allows to disable that check in case this should be necessary.</p>
</li>
<li>
<p><code>setAllowUnknownParameters(boolean)</code>
<code>DefaultQuerySpecUrlMapper</code> validates all passed parameters to be one of the following types: <code>filter</code>, <code>sort</code>, <code>page</code>, <code>fields</code> or <code>include</code>.
In case of any custom query parameter <code>ParametersDeserializationException</code> will be thrown.
This flag allows to disable that check and ignore any unknown ones.</p>
</li>
<li>
<p><code>setIgnoreParseExceptions(boolean)</code>
<code>DefaultQuerySpecUrlMapper</code> attempts to convert all filter parameters to their proper type based on the
attribute type to be filtered. In some scenarios like dates this behavior may be undesirable as applications
introduce expressions like 'now`. Enabling this flag will let <code>DefaultQuerySpecDeserializer</code> ignore
such values and provide them as <code>String</code> within <code>FilterSpec</code>.</p>
</li>
<li>
<p><code>setEnforceDotPathSeparator(boolean)</code>
DefaultQuerySpecUrlMapper makes use of a dotted URL convetion like
 <code><a href="http://&#8230;&#8203;/resource?filter">task</a>[project.name]=myProject</code>. But for historic reasons it also
 accepts <code><a href="http://&#8230;&#8203;/resource?filter">task</a>[project][name]=myProject</code>. The later is not recommended
 to be used anymore because  there is danger of introducing ambiguity when resources and attributes
 are named equally. By enabling this flag, support for the historic format gets removed and no
 ambiguity can occur. While not being the default, it is recommended to do so. With the next
 major version, the default will change.</p>
</li>
<li>
<p><code>setMapJsonNames</code>
Whether to map JSON to Java names for <code>QuerySpec</code>. Enabled by default. Typically JSON and Java names are equal, but, for example,
fields can be renamed with the <code>@JsonProperty</code> annotation.</p>
</li>
<li>
<p><code>addSupportedOperator</code>
Adds a new <code>FilterOperator</code>. See <a href="#filtering">[filtering]</a> for more information.</p>
</li>
<li>
<p><code>setDefaultOperator</code>
Sets the default <code>FilterOperator</code>. See <a href="#filtering">[filtering]</a> for more information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some of those methods are also available from some of the integrations like <code>CrnkFeature</code> for convenience.</p>
</div>
<div class="paragraph">
<p><a id="relationshipRepository"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_relationship_repositories">5.11. Relationship Repositories</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Before getting started with the development of relationship repositories, familiarize yourself
with <a href="#jsonApiRelation">@JsonApiRelation</a>. In various scenarios, a custom implementation is unnecessary!
In many cases <code>@JsonApiRelationId</code> provides the simplest solution to a relationship. Any opposite
relationship can then make use of <code>@JsonApiRelation.mappedBy</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each relationship defined in Crnk (annotation @JsonApiRelation) must have a relationship repository
defined implementing <code>OneRelationshipRepository</code> or <code>ManyRelationshipRepository</code>. The
repository implements the methods necessary to work with a relationship. They provide the methods to work
with single-valued and multi-valued relationships:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getMatcher()</code>
Provides a  <code>RelationshipMatcher</code> instance that specifies which relationships it is able provide.
It can match against source and target types and fields in any combination. Note that this
is a default method that access the legacy <code>getSourceResourceClass</code> and <code>getTargetResourceClass</code>
by default. Implementation of those methods can be omitted if a matcher is available.</p>
</li>
<li>
<p><code>setRelation(T source, D_ID targetId, String fieldName)</code>
Sets a resource defined by targetId to a field fieldName in an instance source. If no value is to be set, null value is passed.</p>
</li>
<li>
<p><code>setRelations(T source, Iterable&lt;D_ID&gt; targetIds, String fieldName)</code>
Sets resources defined by targetIds to a field fieldName in an instance source. This is a all-or-nothing operation, that is no partial relationship updates are passed. If no values are to be set, empty Iterable is passed.</p>
</li>
<li>
<p><code>addRelations(T source, Iterable&lt;D_ID&gt; targetIds, String fieldName)</code>
Adds relationships to a list of relationships.</p>
</li>
<li>
<p><code>removeRelations(T source, Iterable&lt;D_ID&gt; targetIds, String fieldName)</code>
Removes relationships from a list of relationships.</p>
</li>
<li>
<p><code>findOneRelations(Collection&lt;T_ID&gt; sourceIds, String fieldName, QuerySpec querySpec)</code>
Finds the single-valued relationship for sources with the ids <code>sourceIds</code>.</p>
</li>
<li>
<p><code>findManyRelations(Collection&lt;T_ID&gt; sourceIds, String fieldName, QuerySpec querySpec)</code>
Finds the multi-valued relationship for sources with the ids <code>sourceIds</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of the methods in this interface have a <code>fieldName</code> as last parameter in case multiple fields are served
by the same repository. The <code>findOneRelations</code> and <code>findManyRelations</code> methods gain access to the source
class through <code>querySpec.getResourceClass</code>, whereas the other methods directly obtain a <code>source</code> instance.</p>
</div>
<div class="sect3">
<h4 id="_example">5.11.1. Example</h4>
<div class="listingblock">
<div class="title">HistoryRelationshipRepository</div>
<div class="content">
<pre class="CodeRay highlight"><code>@Component
public class HistoryRelationshipRepository extends ManyRelationshipRepositoryBase&lt;Object, Serializable, History, UUID&gt; {

    @Override
    public RelationshipMatcher getMatcher() {
        return new RelationshipMatcher().rule().target(History.class).add();
    }

    @Override
    public Map&lt;Serializable, ResourceList&lt;History&gt;&gt; findManyRelations(Collection&lt;Serializable&gt; sourceIds, String fieldName, QuerySpec querySpec) {
        Map&lt;Serializable, ResourceList&lt;History&gt;&gt; map = new HashMap&lt;&gt;();
        for (Serializable sourceId : sourceIds) {
            DefaultResourceList list = new DefaultResourceList();
            for (int i = 0; i &lt; 10; i++) {
                History history = new History();
                history.setId(UUID.nameUUIDFromBytes(("historyElement" + i).getBytes()));
                history.setName("historyElement" + i);
                list.add(history);
            }
            map.put(sourceId, list);
        }
        return map;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relationshipmatcher">5.11.2. RelationshipMatcher</h4>
<div class="paragraph">
<p>With <code>RelationshipRepository.getMatcher()</code> one has a lot of flexibility about which kind of relationships a repository is
serving. Rules can look like:</p>
</div>
<div class="listingblock">
<div class="title">RelationshipMatcherTest</div>
<div class="content">
<pre class="CodeRay highlight"><code>new RelationshipMatcher().rule().source("projects").add().matches(field)
new RelationshipMatcher().rule().target(Task.class).add().matches(field)
new RelationshipMatcher().rule().target(Tasks.class).add().matches(field)
new RelationshipMatcher().rule().field("tasks").add().matches(field)
new RelationshipMatcher().rule().oppositeField("project").add().matches(field)</code></pre>
</div>
</div>
<div class="paragraph">
<p>One can implement, for example, a history relationship repository that introduces a history relationship for every other resource
as done in the example from the previous section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_self_and_related_links">5.11.3. Self and Related Links</h4>
<div class="paragraph">
<p>The JSON:API specification from <a href="http://jsonapi.org/format/#fetching-relationships" class="bare">http://jsonapi.org/format/#fetching-relationships</a>
mandates two relationship links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>"self": "http://example.com/articles/1/relationships/author"</code></p>
</li>
<li>
<p><code>"related": "http://example.com/articles/1/author"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While the <code>related</code> link returns full resources, the <code>self</code> link only returns the <code>type</code> and <code>id</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>HTTP/1.1 200 OK
Content-Type: application/vnd.api+json

{
  "links": {
    "self": "/articles/1/relationships/author",
    "related": "/articles/1/author"
  },
  "data": {
    "type": "people",
    "id": "12"
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behind the scenes, Crnk invokes the same relationship repository implementation , but the QuerySpec will specify whether only the identifier is required through
the <code>includedFields</code> property.</p>
</div>
</div>
<div class="sect3">
<h4 id="_forwardingrelationshiprepository">5.11.4. ForwardingRelationshipRepository</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Also have a look at <a href="#jsonApiRelation">@JsonApiRelation.repositoryBehavior</a> before getting started to use
this base class.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In many cases, relationship operations can be mapped back to resource repository operations. Making the need
for a custom relationship repository implementation redundant. <code>@JsonApiRelationId</code> fields is one example
where Crnk will take care of this automatically. But there are many other scenarios where application apply
similar techniques. A findManyTargets request might can be
served by filtering the target repository. Or a relationship can be set by invoking the save operation
on either the source or target resource repository (usually you want to save on the single-valued side).
The <code>ForwardingRelationshipRepository</code> is a base class that takes care of exactly such use cases.
<code>ForwardingRelationshipRepository</code> knows to <code>ForwardingDirection</code>: <code>OWNER</code> and <code>OPPOSITE</code>. The former forwards requests
to the resource repository of the owning side of a relationship, while the later forwards to the opposite side.
<code>ForwardingDirection</code> is set separately for <code>GET</code> and modification operations (<code>POST</code>, <code>PATCH</code>, <code>DELETE</code>).</p>
</div>
<div class="paragraph">
<p>An example to create such a repository looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>RelationshipMatcher taskProjectMatcher = new RelationshipMatcher();
taskProjectMatcher.rule().source(Task.class).target(Project.class).add();

new ForwardingRelationshipRepository(
  Task.class, taskProjectMatcher, ForwardingDirection.OWNER, ForwardingDirection.OWNER
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that to access the opposite side for <code>GET</code> operations, relations must be set up bidirectionally with the
<code>opposite</code> attribute (to allow filtering in that direction):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>	@JsonApiResource(type = "tasks")
	public class Task {

		@JsonApiRelation(opposite = "tasks", lookUp = LookupIncludeBehavior.AUTOMATICALLY_WHEN_NULL)
		private Project project;

	    ...
	}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resourcelist">5.12. ResourceList</h3>
<div class="paragraph">
<p>ResourceRepository and RelationshipRepository return lists of type ResourceList. The ResourceList can carry, next
to the actual resources, also meta and links information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getLinks()</code>
Gets the links information attached to this lists.</p>
</li>
<li>
<p><code>getMeta()</code>
Gets the meta information attached to this lists.</p>
</li>
<li>
<p><code>getLinks(Class&lt;L&gt; linksClass)</code>
Gets the links information of the given type attached to this lists. If the given type is not found, null is returned.</p>
</li>
<li>
<p><code>getMeta(Class&lt;M&gt; metaClass)</code>
Gets the meta information of the given type attached to this lists. If the given type is not found, null is returned.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a default implementation named DefaultResourceList. To gain type-safety, improved readability and crnk-client support,
application may provide a custom implementation extending ResourceListBase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>	class ScheduleList extends ResourceListBase&lt;Schedule, ScheduleListMeta, ScheduleListLinks&gt; {

	}

	class ScheduleListLinks implements LinksInformation {

		public String name = "value";

		...
	}

	class ScheduleListMeta implements MetaInformation {

		public String name = "value";

		...
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This implementation can then be added to a repository interface declaration
and used by both servers and clients:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>	public interface ScheduleRepository extends ResourceRepository&lt;Schedule, Long&gt; {

		@Override
		public ScheduleList findAll(QuerySpec querySpec);

	}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_error_handling">5.13. Error Handling</h3>
<div class="paragraph">
<p>Processing errors in Crnk can be handled by throwing an exception and providing
a corresponding exception mapper which defines mapping to a proper JSON:API error response.</p>
</div>
<div class="sect3">
<h4 id="_throwing_an_exception">5.13.1. Throwing an exception&#8230;&#8203;</h4>
<div class="paragraph">
<p>Here is an example of throwing an Exception in the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  if (somethingWentWrong()) {
    throw new SampleException("errorId", "Oops! Something went wrong.")
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sample exception is nothing more than a simple runtime exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  public class SampleException extends RuntimeException {

    private final String id;
    private final String title;

    public ExampleException(String id, String title) {
      this.id = id;
      this.title = title;
    }

    public String getId() {
      return id;
    }

    public String getTitle() {
      return title;
    }
  }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_and_mapping_it_to_jsonapi_response">5.13.2. &#8230;&#8203;and mapping it to JSON:API response</h4>
<div class="paragraph">
<p>Class responsible for mapping the exception should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>implement <code>ExceptionMapper</code> interface</p>
</li>
<li>
<p>available trough the used discovery mechanism or added trough a module.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sample exception mapper:</p>
</div>
<div class="listingblock">
<div class="title">TestExceptionMapper.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>package io.crnk.test.mock;

import io.crnk.core.engine.document.ErrorData;
import io.crnk.core.engine.error.ErrorResponse;
import io.crnk.core.engine.error.ExceptionMapper;
import io.crnk.core.repository.response.JsonApiResponse;

import java.util.List;

public class TestExceptionMapper implements ExceptionMapper&lt;TestException&gt; {

	public static final int HTTP_ERROR_CODE = 499;

	@Override
	public ErrorResponse toErrorResponse(TestException cve) {
		ErrorData error = ErrorData.builder().setDetail(cve.getMessage()).build();
		return ErrorResponse.builder().setStatus(HTTP_ERROR_CODE).setSingleErrorData(error).build();
	}

	@Override
	public TestException fromErrorResponse(ErrorResponse errorResponse) {
		JsonApiResponse response = errorResponse.getResponse();
		List&lt;ErrorData&gt; errors = (List&lt;ErrorData&gt;) response.getErrors();
		StringBuilder message = new StringBuilder();
		for (ErrorData error : errors) {
			String title = error.getDetail();
			message.append(title);
		}
		return new TestException(message.toString());
	}

	@Override
	public boolean accepts(ErrorResponse errorResponse) {
		return errorResponse.getHttpStatus() == HTTP_ERROR_CODE;
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the server-side an exception is mapped to an <code>ErrorResponse</code> object
with <code>toErrorResponse</code>. It consists of an HTTP status and <code>ErrorData</code> (which is consistent with JSON:API error structure).
On the client-side an <code>ExceptionMapper</code> returning <code>true</code> upon <code>accept(&#8230;&#8203;)</code> is used to map an
<code>ErrorResponse</code> back to an exception with <code>fromErrorResponse</code>.</p>
</div>
<div class="paragraph">
<p>Note that <code>ExceptionMapper</code> follow a number of important behaviors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Built-in <code>ExceptionMapper</code> can be overridden by custom <code>ExceptionMapper</code> implementations. The later always takes precedence.</p>
</li>
<li>
<p>The <code>ExceptionMapper</code> is responsible for providing the logging of exceptions with the appropriate log levels.
Typically a <code>4xx</code> status causes a <code>WARN</code> log message, whereas <code>5xx</code> errors cause an <code>ERROR</code> log message.
Also have a look at the subsequent section about the validation module that takes
care of JSR-303 bean validation exception mapping.</p>
</li>
<li>
<p><code>ExceptionMapper</code> target a given exception class. In case of type hierarchies, the closest <code>ExceptionMapper</code> is chosen.
For example, if there are <code>ExceptionMapper</code> implementations for both <code>RuntimeException</code> and <code>IllegalStateException</code>,
the mappers for <code>RuntimeException</code> is chosen if there is no direct mapper for <code>IllegalStateException</code>.</p>
</li>
<li>
<p><code>ExceptionMapper</code> can implement the <code>Prioritizable</code> interface if multiple implementations target the
same exception type. But note that the type hierarchy still takes precedence.</p>
</li>
<li>
<p>The implementation of a custom <code>ExceptionMapper</code> can be skipped if the exception inherits from <code>CrnkMappableException</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are a number of built-in exception mappers provided by crnk-core and the various modules:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Exception</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UnauthorizedException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">403</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ForbiddenException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">404</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceNotFoundException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">405</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MethodNotAllowedException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">409</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OptimisticLockException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">422</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ConstraintViolationException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">422</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValidationException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>InternalServerErrorException</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">503</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TimeoutException</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_meta_information">5.14. Meta Information</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
With ResourceList and @JsonApiMetaInformation meta information can be returned directly. A MetaRepository implementation is no longer necessary.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is a special interface which can be added to resource repositories to provide meta information: <code>io.crnk.core.repository.MetaRepository</code>.
It contains a single method <code>MetaInformation getMetaInformation(Iterable&lt;T&gt; resources)</code> which return meta information object that implements the marker <code>interface io.crnk.response.MetaInformation</code>.</p>
</div>
<div class="paragraph">
<p>If you want to add meta information along with the responses, all repositories (those that implement <code>ResourceRepository</code> and <code>RelationshipRepository</code>) must implement <code>MetaRepository</code>.</p>
</div>
<div class="paragraph">
<p>When using annotated versions of repositories, a method that returns a <code>MetaInformation</code> object should be annotated with <code>JsonApiMeta</code> and the first parameter of the method must be a list of resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_links_information">5.15. Links Information</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
With ResourceList and @JsonApiLinksInformation links information can be returned directly. A LinksRepository implementation is usually not necessary.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is a special interface which can be added to resource repositories to provide links information: <code>io.crnk.core.repository.LinksRepository</code>.
It contains a single method <code>LinksInformation getLinksInformation(Iterable&lt;T&gt; resources)</code> which return links information object that implements the marker <code>interface io.crnk.response.LinksInformation</code>.</p>
</div>
<div class="paragraph">
<p>If you want to add meta information along with the responses, all repositories (those that implement <code>ResourceRepository</code> and <code>RelationshipRepository</code>), must implement <code>LinksRepository</code>.</p>
</div>
<div class="paragraph">
<p>When using annotated versions of repositories, a method that returns a <code>LinksInformation</code> object should be annotated with <code>JsonApiLinks</code> and the first parameter of the method has to be a list of resources.</p>
</div>
<div class="paragraph">
<p><a id="inheritance"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_inheritance">5.16. Inheritance</h3>
<div class="paragraph">
<p>There are two different kinds of inheritance supported:</p>
</div>
<div class="sect3">
<h4 id="_inheritance_with_a_repository_per_type">5.16.1. Inheritance with a repository per type</h4>
<div class="paragraph">
<p>Each subtype is served by its own resource repository and each repository has its own URL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  @JsonApiResource(type = "task")
  public class Task {
    // fields, getters and setters
  }

  @JsonApiResource(type = "specialTask")
  public class SpecialTask extends Task{
    // fields, getters and setters
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is no special configuration necessary. But repositories of super types must
also return resources of subtypes if they match the specified id or filter parameters.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inheritance_with_a_single_repository_per_type_hierarchy">5.16.2. Inheritance with a single repository per type hierarchy</h4>
<div class="paragraph">
<p>In this case all resources share a repository implementation and URL (except for the identifier part). An example may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  @JsonApiResource(type = "task", subTypes = SpecialTask.class)
  public class Task {
    // fields, getters and setters
  }

  @JsonApiResource(type = "specialTask", resourcePath = "task")
  public class SpecialTask extends Task{
    // fields, getters and setters
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>SpecialTask</code> extends <code>Task</code> but is configured to use the same <code>resourcePath</code>, meaning <code>SpecialTask</code> does not have
a repository implementation on its own, but is served by the repository of <code>Task</code>. For a more detailed example have
a look at <code>InheritanceWithoutSubtypeRepositoryClientTest</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_payload_size_optimizations">5.17. Payload Size Optimizations</h3>
<div class="paragraph">
<p>Self and related links can make up to 60% of the response payload size and not always are those links of use.
Crnk offers a <code>Crnk-Compact: true</code> header that can be sent along with the request. In this case the computation
of those links is omitted. Further relationships without data are completely omitted.</p>
</div>
<div class="paragraph">
<p><a id="repository_decoration"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_repository_decoration">5.18. Repository Decoration</h3>
<div class="paragraph">
<p>Sometimes it is useful to augment a repository with further features. There are  different situations where that can makes sense:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the main repository implementation comes from a third-party library and can/should not directly be modified.</p>
</li>
<li>
<p>the feature is unrelated to the main repository feature set, for example, cross-cutting concerns like security, caching, tracing and metrics.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>RepositoryDecoratorFactory</code> allows to do exactly that. It puts a <strong>decorating</strong> resource or relationship repository inbetween
the Crnk engine and the main repository. It implements the same interface contract as the main repository,
intercept all requests and can do arbitrary modifications. The modifications may or may not include calling the main repository.</p>
</div>
<div class="paragraph">
<p>An example can look like:</p>
</div>
<div class="listingblock">
<div class="title">ApprovalRepositoryDecorator.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>    public static final RepositoryDecoratorFactory createFactory(ApprovalManager approvalManager) {
        return repository -&gt; {
            if (repository instanceof ResourceRepository &amp;&amp; ((ResourceRepository) repository).getResourceClass() == Schedule.class) {
                return new ApprovalRepositoryDecorator(approvalManager, (ResourceRepository) repository);
            }
            return repository;
        };
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The particular example, for example, intercepts the <code>save</code> operation and may trigger an approval workflow:</p>
</div>
<div class="listingblock">
<div class="title">ApprovalRepositoryDecorator.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>    @Override
    public &lt;S extends T&gt; S save(S entity) {
        if (approvalManager.needsApproval(entity, HttpMethod.PATCH)) {
            return approvalManager.requestApproval(entity, HttpMethod.PATCH);
        } else {
            return super.save(entity);
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resourcefieldcontributor">5.19. ResourceFieldContributor</h3>
<div class="paragraph">
<p>The <code>ResourceFieldContributor</code> interface allows to dynamically introduce new fields to resources without actually
touching them. This is useful, for example, if you have a JPA entity exposed with crnk-data-jpa and
want to add further fields like that mentioned history relationship from the earlier relationship example.
<code>ResourceFieldContributor</code> can
be implemented by a repository or obtained from the regular service discovery mechanism.</p>
</div>
<div class="paragraph">
<p>Any type of field can be added: meta, links, attribute and relationship fields. For relationship fields
an application may make use of <code>RelationshipMatcher</code> to provide repository serving those fields.
Notice the <code>accessor</code> property that is used to obtain the value of that field
(make sure this method is efficient to execute). An example is given by the <code>HistoryRelationshipRepository</code> in
<a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-integration-examples/spring-boot-example">crnk-integration-examples/spring-boot-example</a>:</p>
</div>
<div class="listingblock">
<div class="title">HistoryFieldContributor</div>
<div class="content">
<pre class="CodeRay highlight"><code>@Component
public class HistoryFieldContributor implements ResourceFieldContributor {

	@Override
	public List&lt;ResourceField&gt; getResourceFields(ResourceFieldContributorContext context) {
		// this method could be omitted if the history field is added regularly to Project and Task resource. This would be
		// simpler and recommended, but may not always be possible. Here we demonstrate doing it dynamically.
		InformationBuilder.FieldInformationBuilder fieldBuilder = context.getInformationBuilder().createResourceField();
		fieldBuilder.name("history");
		fieldBuilder.genericType(new TypeToken&lt;List&lt;History&gt;&gt;() {
		}.getType());
		fieldBuilder.oppositeResourceType("history");
		fieldBuilder.fieldType(ResourceFieldType.RELATIONSHIP);

		// field values are "null" on resource and we make use of automated lookup to the relationship repository
		// instead:
		fieldBuilder.lookupIncludeBehavior(LookupIncludeBehavior.AUTOMATICALLY_ALWAYS);
		fieldBuilder.accessor(new ResourceFieldAccessor() {
			@Override
			public Object getValue(Object resource) {
				return null;
			}

			@Override
			public void setValue(Object resource, Object fieldValue) {
			}

			@Override
			public Class getImplementationClass() {
				return List.class;
			}
		});
		return Arrays.asList(fieldBuilder.build());
	}
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getRelationshipFields</code> introduces the field dynamically instead of statically.</p>
</li>
<li>
<p><code>getMatcher</code> attaches the repository to the historized resources.</p>
</li>
<li>
<p><code>findManyTarget</code> implements the lookup of history elements.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="JsonApiExposed"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_jsonapiexposed">5.20. @JsonApiExposed</h3>
<div class="paragraph">
<p>A repository may be annotated with <code>@JsonApiExposed(false)</code>. In this case the repository is only available internally to other repositories, not
externally on the JSON:API endpoint. There are different use cases for this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Have a look at the <a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-integration-examples/spring-boot-microservice-example">micro-service example application</a> to see how remote repositories can be linked to local ones.</p>
</li>
<li>
<p><a href="#nested_resources">nested resources</a> can be made accessible only through their parent, such as <code><a href="http://example.com/posts/1/comments/2" class="bare">http://example.com/posts/1/comments/2</a></code> and no longer <code><a href="http://example.com/comments" class="bare">http://example.com/comments</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="client"></a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_client">6. Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a client implementation for Java and Android projects to allow
communicating with JSON-API compliant servers.</p>
</div>
<div class="sect2">
<h3 id="_setup_2">6.1. Setup</h3>
<div class="paragraph">
<p>The basic setup is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  CrnkClient client = new CrnkClient("http://localhost:8080/api");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Four underlying http client libraries are supported.
Add one of those library to the classpath and Crnk will pick it up automatically.
A custom <code>HttpAdapter</code> can also set passed to <code>CrnkClient.setHttpAdapter(&#8230;&#8203;)</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/square/okhttp">OkHttp</a>
that is popular for Java and Android development. Implemented by
<code>io.crnk.client.http.okhttp.OkHttpAdapter</code>.</p>
</li>
<li>
<p><a href="https://hc.apache.org/httpcomponents-client-ga/index.html">Apache Http Client</a>
implemented by <code>io.crnk.client.http.apache.HttpClientAdapter</code>.</p>
</li>
<li>
<p><code>RestTemplate</code> from Spring provides a Spring abstraction of other HTTP libraries.
Spring application benefit from using this over the underlying native implementation to share
the setup configuration setup. It is used by default if the presence of Spring is detected.
Implemented by <code>io.crnk.spring.client.RestTemplateAdapter</code>.</p>
</li>
<li>
<p><code>InMemoryHttpAdapter</code> to directly connect a client to a server without a TCP transport layer
or HTTP server. This <strong>implementation is well suited for unit testing</strong> as no server must be setup, making
unit tests simpler and faster to write, execute and debug. In contrast to invoking a repository directly
on the server, <code>InMemoryHttpAdapter</code> request still pass through the entire Crnk serialization layer
and are processed like any other HTTP request.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  String url = "http://localhost:8080/api";
  CrnkClient client = new CrnkClient(url);
  client.setHttpAdapter(new InMemoryHttpAdapter(crnkBoot, url));</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
For Spring a <strong>reasonable HTTP client implementation must underlie <code>RestTemplate</code></strong>
in order for <code>crnk-client</code> to work properly. For example, the default Java implementation does not
support the <code>PATCH</code> method and as such no resources can be updated.
To explicitly set HTTP implementation use:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  RestTemplateAdapter adapter = (RestTemplateAdapter) client.getHttpAdapter();
  RestTemplate template = adapter.getImplementation();
  template.setRequestFactory(new OkHttp3ClientHttpRequestFactory());</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  client.setHttpAdapter(new RestTemplateAdapter(customRestTemplate));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_usage_2">6.2. Usage</h3>
<div class="paragraph">
<p>The client has three main methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CrnkClient#getRepositoryForInterface(Class)</code> to obtain a resource repository stub from an existing repository interface.</p>
</li>
<li>
<p><code>CrnkClient#getRepositoryForType(Class)</code> to obtain a generic resource repository stub from the provided resource type.</p>
</li>
<li>
<p><code>CrnkClient#getRepositoryForType(Class, Class)</code> to obtain a generic relationship repository stub from the provided source and target resource types.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interface of the repositories is as same as defined in `Repositories`_ section.</p>
</div>
<div class="paragraph">
<p>An example of the usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  CrnkClient client = new CrnkClient("http://localhost:8080/api");
  ResourceRepository&lt;Task, Long&gt; taskRepo = client.getRepositoryForType(Task.class);
  List&lt;Task&gt; tasks = taskRepo.findAll(new QuerySpec(Task.class));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look at, for example, the QuerySpecClientTest to see more examples of how it is used.</p>
</div>
</div>
<div class="sect2">
<h3 id="_url_handling">6.3. URL handling</h3>
<div class="paragraph">
<p>Crnk client and server share the URL handling. <code>QuerySpecUrlMapper</code> performs the mapping of HTTP request parameters to QuerySpec.
For more information see <a href="#urlmapper">url mapping</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modules">6.4. Modules</h3>
<div class="paragraph">
<p><code>CrnkClient</code> can be extended by modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  CrnkClient client = new CrnkClient("http://localhost:8080/api");
  client.addModule(ValidationModule.create());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typical use cases include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>adding exception mappers</p>
</li>
<li>
<p>registering new types of resources (like JPA entities by the <code>JpaModule</code>)</p>
</li>
<li>
<p>intercepting requests for monitoring</p>
</li>
<li>
<p>adding security tokens to requests</p>
</li>
<li>
<p>setup the <code>PlainJsonFormatModule</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many modules allow a registration both on server and client side.
The client part then typically makes use of a subset of the server features, like
exception mappers and resource registrations.</p>
</div>
<div class="paragraph">
<p>There is a mechanism to discover and register client modules automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  CrnkClient client = new CrnkClient("http://localhost:8080/api");
  client.findModules();</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>findModules</code> makes use of <code>java.util.ServiceLoader</code> and looks up
for <code>ClientModuleFactory</code>. <code>JpaModule</code>, <code>ValidationModule</code>,
<code>MetaModule</code>, <code>SecurityModule</code> implement such a service registration.
In contrast, <code>BraveModule</code> needs a Brave instance and does not yet
allow a fully automated setup.</p>
</div>
</div>
<div class="sect2">
<h3 id="_type_safety">6.5. Type-Safety</h3>
<div class="paragraph">
<p>It is possible to work with <code>CrnkClient</code> in a fully type-safe manner.</p>
</div>
<div class="paragraph">
<p>In a first step an interface for a repository is defined:</p>
</div>
<div class="listingblock">
<div class="title">ScheduleRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>public interface ScheduleRepository extends ResourceRepository&lt;Schedule, Long&gt; {
	@Override
	ScheduleList findAll(QuerySpec querySpec);

	class ScheduleList extends ResourceListBase&lt;Schedule, ScheduleListMeta, ScheduleListLinks&gt; {

	}

	class ScheduleListLinks extends DefaultPagedLinksInformation implements LinksInformation {

		public Link objLink = new DefaultLink("value");

		public String stringLink = "value";
	}

	class ScheduleListMeta extends DefaultPagedMetaInformation {

		public String name = "value";

	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then it can be used like:</p>
</div>
<div class="listingblock">
<div class="title">QuerySpecClientTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>        ScheduleRepository scheduleRepository = ((ClientTestContainer) testContainer).getClient().getRepositoryForInterface(ScheduleRepository.class);

        Schedule schedule = new Schedule();
        schedule.setId(13L);
        schedule.setName("mySchedule");
        scheduleRepository.create(schedule);

        QuerySpec querySpec = new QuerySpec(Schedule.class);
        ScheduleList list = scheduleRepository.findAll(querySpec);
        Assert.assertEquals(1, list.size());
        ScheduleListMeta meta = list.getMeta();
        ScheduleListLinks links = list.getLinks();
        Assert.assertNotNull(meta);
        Assert.assertNotNull(links);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="client_jaxrs"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_http_customization">6.6. HTTP customization</h3>
<div class="paragraph">
<p><code>CrnkClient#getHttpAdapter()</code> gives access to the <code>HttpAdapter</code>.
There are two ways to customize HTTP requests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>HttpAdapterListener</code> can be added with <code>addListener</code>
to  <code>HttpAdapter</code>. <code>HttpAdapterListener</code>  allows to intercept both requests and responses and perform changes.</p>
</li>
<li>
<p>The <code>HttpAdapter</code> interface can be cast to used implementation, which in turn gives access to the native
builder/listener mechanisms to perform any kind of advanced customization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Typical use cases to customize the HTTP requests and responses are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add custom request headers (security, tracing, etc.)</p>
</li>
<li>
<p>collect statistics</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/crnk-project/crnk-framework/blob/master/crnk-monitor/crnk-monitor-brave4/src/main/java/io/crnk/monitor/brave/BraveClientModule.java">crnk-monitor-brave4</a> for
an advanced example.</p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/32196424/how-to-add-headers-to-okhttp-request-interceptor?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa">How to add
headers to OkHttp request interceptor</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_jax_rs_interoperability">6.7. JAX-RS interoperability</h3>
<div class="paragraph">
<p>The interface stubs from the previous section can also be used to make calls to JAX-RS. For example, the
<code>ScheduleRepository</code> can be complemented with a JAX-RS annotation:</p>
</div>
<div class="listingblock">
<div class="title">ScheduleRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>@Path("schedules")
@Produces(HttpHeaders.JSONAPI_CONTENT_TYPE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>and further JAX-RS services can be added:</p>
</div>
<div class="listingblock">
<div class="title">ScheduleRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>	@GET
	@Path("repositoryAction")
	@Produces(MediaType.TEXT_HTML)
	String repositoryAction(@QueryParam(value = "msg") String msg);

	@GET
	@Path("repositoryActionJsonApi")
	String repositoryActionJsonApi(@QueryParam(value = "msg") String msg);

	@GET
	@Path("repositoryActionWithJsonApiResponse")
	String repositoryActionWithJsonApiResponse(@QueryParam(value = "msg") String msg);

	@GET
	@Path("repositoryActionWithResourceResult")
	Schedule repositoryActionWithResourceResult(@QueryParam(value = "msg") String msg);

	@GET
	@Path("repositoryActionWithException")
	Schedule repositoryActionWithException(@QueryParam(value = "msg") String msg);

	@GET
	@Path("repositoryActionWithNullResponse")
	@Produces(MediaType.TEXT_HTML)
	String repositoryActionWithNullResponse();

	@GET
	@Path("repositoryActionWithNullResponseJsonApi")
	String repositoryActionWithNullResponseJsonApi();

	@GET
	@Path("{id}/resourceAction")
	String resourceAction(@PathParam("id") long id, @QueryParam(value = "msg") String msg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make this work a dependency to <code>org.glassfish.jersey.ext:jersey-proxy-client</code> must be added and <code>JerseyActionStubFactory</code>
registered with <code>CrnkClient</code>:</p>
</div>
<div class="listingblock">
<div class="title">AbstractClientTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>		client.setActionStubFactory(JerseyActionStubFactory.newInstance());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a client can make use the Crnk stubs and it will transparently switch between JSON-API and JAX-RS calls:</p>
</div>
<div class="listingblock">
<div class="title">JsonApiActionResponseTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>        String result = scheduleRepository.repositoryAction("hello");
        Assert.assertEquals("repository action: hello", result);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Due to limited configurability of the Jersey Proxies it is currently not possible to reuse the same HTTP connections
for both types of calls. We attempt to address that in the future. Be aware of this when you, for example, add further
request headers (like security), as it has to be done in two places (unfortunately).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a id="format"></a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_formats">7. Formats</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default Crnk follows the JSON:API specification to establish a REST endpoint. This chapter outlines the support
for formats other than JSON:API.</p>
</div>
<div class="paragraph">
<p><a id="format_plain"></a></p>
</div>
<div class="sect2">
<h3 id="_plain_json">7.1. Plain JSON</h3>
<div class="paragraph">
<p>The relationships and inclusions mechanisms of JSON:API allow to built powerful applications. But
sometimes those advanced features can also make simpler applications harder to write.
For example, clients do not have direct access to relationships, but rather have the resolve them through their
identifiers.</p>
</div>
<div class="paragraph">
<p><code>crnk-format-plain-json</code> hosts the <code>PlainJsonFormatModule</code> that allows to setup a simpler,
non-JSON:API format. The module can be applied both to CrnkBoot and CrnkClient. An example looks like:</p>
</div>
<div class="listingblock">
<div class="title"><a href="http://localhost:8080/tasks/12" class="bare">http://localhost:8080/tasks/12</a></div>
<div class="content">
<pre class="CodeRay highlight"><code>{
  "data" : {
    "id" : "12",
    "type" : "tasks",
    "name" : "someTask",
    "schedule" : {
      "data" : null,
      "links" : {
        "self" : "http://localhost:8080/tasks/12/relationships/schedule",
        "related" : "http://localhost:8080/tasks/12/schedule"
      }
    },
    "project" : {
      "data" : {
        "id" : "1",
        "type" : "projects",
        "name" : "someProject"
      },
      "links" : {
        "self" : "http://localhost:8080/tasks/12/relationships/project",
        "related" : "http://localhost:8080/tasks/12/project"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most notably the project relationship is directly inlined within the task. And a resource is written in a more flat manner without the
<code>attributes</code> and <code>relationships</code> containers. Contributions to add more flexibility to the module are always welcome.</p>
</div>
<div class="paragraph">
<p>Note that the JSON:API endpoint remains fully functional. The HTTP <code>Accept</code> and <code>Content-Type</code> headers are used to select
the format. As such, the Crnk client continues to make use of the JSON:API format. Related to this there is
a <code>format</code> attribute for
the Typescript generator to select the desired format for generation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>crnkGen{

  typescript{
    ...
    format = 'PLAINJSON' // or 'JSONAPI'
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="testkit"></a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testkit">8. TestKit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With <code>crnk-testkit</code> is in the early stages of providing utilities to facilitate testing.
<code>RandomWalkLinkChecker</code> is a class that performs a random walk on an API endpoint by following
all the links as specified by JSON:API. It will verify that each links provides a valid
<code>2xx</code> response code. The setup looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CrnkClient client = ...
HttpAdapter httpAdapter = client.getHttpAdapter();

RandomWalkLinkChecker linkChecker = <span class="keyword">new</span> RandomWalkLinkChecker(httpAdapter);
linkChecker.setWalkLength(<span class="integer">100</span>);
linkChecker.addStartUrl(...)

linkChecker.performCheck();</code></pre>
</div>
</div>
<div class="paragraph">
<p>More possibilities for automation in the future are to add checks for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>paging</p>
</li>
<li>
<p>filtering</p>
</li>
<li>
<p>sorting</p>
</li>
<li>
<p>security</p>
</li>
<li>
<p>field sets</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="reactive"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactive_programming">9. Reactive Programming</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Initial support is available, but still considered (very) experimental. The implementation is expected to mature over the coming weeks. Breaking changes
  to the reactive API might be possible. The traditional API is left unchanged.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ReactiveModule</code> of <code>crnk-reactive</code> bring support for reactive programming to Crnk.
It allows to build more responsive, elastic, resilient, message-driven applications (see
<a href="https://www.reactivemanifesto.org/" class="bare">https://www.reactivemanifesto.org/</a>). <a href="https://projectreactor.io/" class="bare">https://projectreactor.io/</a> was chosen as library.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Traditional and reactive-style programming APIs are considered being equally important and will both be supported the coming years.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>crnk-reactive</code> brings along three new interfaces that act as reactive counter-parts of the traditional resource and relationship interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ReactiveResourceRepository</code></p>
</li>
<li>
<p><code>ReactiveOneRelationshipRepository</code></p>
</li>
<li>
<p><code>ReactiveManyRelationshipRepository</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The differences to the traditional ones are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Single and multi-valued relationships are served by different interfaces (minor cleanup, usually one or the other is necessary).</p>
</li>
<li>
<p><code>ResourceField</code> instead of a simple <code>String</code> give more detailed information about the accessed relationship.</p>
</li>
<li>
<p>Most importantly, <code>reactor.core.publisher.Mono</code> is used as return type to enable reactive programming.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>NOTE that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A potential future V3 version of the traditional interfaces will align the first two differences.</p>
</li>
<li>
<p><code>Mono</code> rather than <code>Flux</code> is used for list return types since meta and links information must be returned as well, not just a sequence of resources.
For large number of resources, the JSON:API pagination mechanisms can be applied.</p>
</li>
<li>
<p>Internally the traditional and reactive repositories are served by the same Crnk engine and share virtually all of the code base.
The difference lies in the used <code>ResultFactory</code> implementation. <code>ImmediateResultFactory</code> is used by the traditional API. <code>MonoResultFactory</code> by
reactive setups.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_servlet_example">9.1. Servlet Example</h3>
<div class="paragraph">
<p>The subsequent example shows as simple reactive resource repository holding its data in-memory:</p>
</div>
<div class="listingblock">
<div class="title">InMemoryReactiveResourceRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>package io.crnk.test.mock.reactive;

import io.crnk.core.engine.information.resource.ResourceField;
import io.crnk.core.engine.internal.utils.PreconditionUtil;
import io.crnk.core.engine.registry.RegistryEntry;
import io.crnk.core.queryspec.QuerySpec;
import io.crnk.core.resource.list.ResourceList;
import io.crnk.reactive.repository.ReactiveResourceRepositoryBase;
import io.crnk.test.mock.TestException;
import io.crnk.test.mock.UnknownException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import reactor.core.publisher.Mono;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

public class InMemoryReactiveResourceRepository&lt;T, I&gt; extends ReactiveResourceRepositoryBase&lt;T, I&gt; {

	private static final Logger LOGGER = LoggerFactory.getLogger(InMemoryReactiveResourceRepository.class);

	protected Map&lt;I, T&gt; resources = new ConcurrentHashMap&lt;&gt;();

	private long nextId = 0;

	public InMemoryReactiveResourceRepository(Class&lt;T&gt; clazz) {
		super(clazz);
	}


	@Override
	public Mono&lt;T&gt; findOne(I id, QuerySpec querySpec) {
		if ((Long) id == 10000L) {
			return Mono.error(new TestException("msg"));
		}
		if ((Long) id == 10001L) {
			return Mono.error(new UnknownException("msg"));
		}
		return super.findOne(id, querySpec);
	}


	@Override
	public Mono&lt;ResourceList&lt;T&gt;&gt; findAll(QuerySpec querySpec) {
		LOGGER.debug("findAll {}", querySpec);
		return Mono.fromCallable(() -&gt; querySpec.apply(resources.values()));
	}

	@Override
	public Mono&lt;T&gt; create(T entity) {
		LOGGER.debug("create {}", entity);

		RegistryEntry entry = resourceRegistry.findEntry(getResourceClass());
		ResourceField idField = entry.getResourceInformation().getIdField();
		Long id = (Long) idField.getAccessor().getValue(entity);
		if (id == null) {
			idField.getAccessor().setValue(entity, nextId++);
		}
		return save(entity);
	}


	@Override
	public Mono&lt;T&gt; save(T entity) {
		LOGGER.debug("save {}", entity);
		RegistryEntry entry = resourceRegistry.findEntry(getResourceClass());
		ResourceField idField = entry.getResourceInformation().getIdField();
		I id = (I) idField.getAccessor().getValue(entity);
		PreconditionUtil.assertNotNull("no id specified", entity);
		if ((Long) id == 10000L) {
			return Mono.error(new TestException("msg"));
		}
		if ((Long) id == 10001L) {
			return Mono.error(new UnknownException("msg"));
		}
		resources.put(id, entity);
		return Mono.just(entity);
	}

	@Override
	public Mono&lt;Boolean&gt; delete(I id) {
		LOGGER.debug("delete {}", id);
		return Mono.fromCallable(() -&gt; resources.remove(id) != null);
	}

	public Map&lt;I, T&gt; getMap() {
		return resources;
	}

	public void clear() {
		resources.clear();
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following snipped shows how to setup the <code>ReactiveModule</code> together with <code>AsyncCrnkServlet</code> in Spring:</p>
</div>
<div class="listingblock">
<div class="title">ReactiveServletTestApplication.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>	@Bean
	public AsyncCrnkServlet asyncCrnkServlet(SlowResourceRepository slowResourceRepository) {
		SimpleModule slowModule = new SimpleModule("slow");
		slowModule.addRepository(slowResourceRepository);

		AsyncCrnkServlet servlet = new AsyncCrnkServlet();
		servlet.getBoot().addModule(new ReactiveModule());
		servlet.getBoot().addModule(testModule);
		servlet.getBoot().addModule(slowModule);

		return servlet;
	}

	@Bean
	public ServletRegistrationBean crnkServletRegistration(AsyncCrnkServlet servlet) {
		ServletRegistrationBean bean = new ServletRegistrationBean(servlet, "/api/*");
		bean.setLoadOnStartup(1);
		return bean;
	}

	@Bean
	public CrnkBoot crnkBoot(AsyncCrnkServlet servlet) {
		return servlet.getBoot();
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ready-to-use integrations into Spring, Vert.x and Ratpack are planned for the near future.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interacting_with_traditional_repositories">9.2. Interacting with traditional repositories</h3>
<div class="paragraph">
<p>Reactive and traditional repositories work well together side-by-side and can also be used in a mixed setting, for example when requesting the inclusion
of related resources. Since the traditional repositories will block the caller, there are two mechanisms in place to remedy the issue:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A repository can be annotated with <code>ImmediateRepository</code>. In this case the traditional repository is marked as being non-blocking and can be safely invoked.</p>
</li>
<li>
<p><code>ReactiveModule.setWorkerScheduler(&#8230;&#8203;)</code> allows to set the scheduler to use to invoke traditional repositories. By default <code>Schedulers.elastic</code> is used where
worker threads are spanned as necessary.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_roadmap_and_limitations">9.3. Roadmap and Limitations</h3>
<div class="ulist">
<ul>
<li>
<p><code>DocumentFilter</code>, <code>RepositoryFilter</code> cannot be used in a reactive setup. Reactive counter-party will be available in the near future.</p>
</li>
<li>
<p><code>HttpRequestContextProvider.getRequestContext</code> can only be used in a non-reactive setting or while the reactive request is being setup.
<code>HttpRequestContextProvider.getRequestContextResult</code> must be used instead that makes use of the subscriber context of Reactor.</p>
</li>
<li>
<p><code>crnk-data-jpa</code> has not yet been ported yet. JDBC and JPA are blocking and require a transaction.</p>
</li>
<li>
<p>Spring, Vert.x and Ratpack integrations are target for the near future.</p>
</li>
<li>
<p>More testing will be necessary.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Contributions in any area welcomed.
:basedir: ../../../..</p>
</div>
<div class="paragraph">
<p><a id="security_module"></a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security">10. Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The resource-oriented nature of Crnk makes a number of quite powerful security schemes possible
to authorize access to resources. The semantics of JSON:API with resources, relationships, fields
and parameters provide much more information about an application compared to, for example, a
more classical JAX-RS oder Spring MVC application. This in turn allows to automate and simplify
many security-related topics, which in turn allows for a more robust authorization.</p>
</div>
<div class="paragraph">
<p>Authorization can happen on three levels:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resource-based authorization: only a subset of all resource types are accessible to the user.</p>
</li>
<li>
<p>Field-based authorization: only a subset of the fields (attributes and relationships) of a resource are accessible to the user.</p>
</li>
<li>
<p>Data-based authorization: only a subset of all resources of a given type are accessible to the user
based on the contents of the resources. Typically denominated Dataroom access control (DAC).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Crnk comes with support for all three. The subsequent sections outline a number of different strategies how to apply them.</p>
</div>
<div class="sect2">
<h3 id="_authentication">10.1. Authentication</h3>
<div class="paragraph">
<p>Authorization requires to first know the calling user through authentication. Crnk is agnostic to
the used authorization scheme and is usually provided by the underlying integration, for example,
the <code>Principal</code> of JEE or the <code>SecurityContext</code> of Spring Security. They in turn are populated
from a scheme like OAuth, JWT or SAML.</p>
</div>
<div class="paragraph">
<p>Crnk makes use of <code>SecurityProvider</code> to integrate with such systems and check access to roles
for the current user:</p>
</div>
<div class="listingblock">
<div class="title">SecurityProvider.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>package io.crnk.core.engine.security;

public interface SecurityProvider {

    boolean isUserInRole(String role, SecurityProviderContext context);

    /**
     * @return true if the user has been logged in. If not, a {@link io.crnk.core.exception.UnauthorizedException} rather than
     * {@link io.crnk.core.exception.ForbiddenException} is  thrown.
     */
    boolean isAuthenticated(SecurityProviderContext context);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JAX-RS and servlet integration of Crnk come both with a <code>SecurityProvider</code> implementation. Which in
turn also provides an implementation for all integrations derived from them, such as Spring.</p>
</div>
<div class="paragraph">
<p>The <code>SecurityProvider</code> is accessible from the module API and can be used to perform both DAC and RBAC
or any other kind of check.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resource_based_access_control_with_the_securitymodule">10.2. Resource-based Access Control with the SecurityModule</h3>
<div class="paragraph">
<p>There is a <code>SecurityModule</code> provided by <code>crnk-security</code> that intercepts all repository requests and
perform access control. Currently it supports resource-based access control.
A setup can looks as follows:</p>
</div>
<div class="listingblock">
<div class="title">SecurityModuleIntTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>            Builder builder = SecurityConfig.builder();
            builder.permitRole("allRole", ResourcePermission.ALL);
            builder.permitRole("getRole", ResourcePermission.GET);
            builder.permitRole("patchRole", ResourcePermission.PATCH);
            builder.permitRole("postRole", ResourcePermission.POST);
            builder.permitRole("deleteRole", ResourcePermission.DELETE);
            builder.permitRole("taskRole", Task.class, ResourcePermission.ALL);
            builder.permitRole("taskReadRole", Task.class, ResourcePermission.GET);
            builder.permitRole("projectRole", Project.class, ResourcePermission.ALL);
            builder.permitAll(ResourcePermission.GET);
            builder.permitAll(Project.class, ResourcePermission.POST);
            module = SecurityModule.newServerModule(builder.build());

            CrnkFeature feature = new CrnkFeature();
            feature.addModule(module);
            feature.addModule(testModule);</code></pre>
</div>
</div>
<div class="paragraph">
<p>A builder is used to construct rules. Each rule grants access to either a given or all resources.
Thereby <code>ResourcePermission</code> specifies the set of authorized methods: <code>GET</code>, <code>POST</code>, <code>PATCH</code>, <code>DELETE</code>.</p>
</div>
<div class="paragraph">
<p>Once the rules are defined, the runtime checks go well beyond more traditional approaches like
JEE <code>@RolesAllowed</code> annotation. The rules are enforced in various contexts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Access to resource repositories are checked.</p>
</li>
<li>
<p>Access to relationship repositories are checked based on the target (return) type.</p>
</li>
<li>
<p>Relationship fields targeting resources the user is not authorized to see are omitted from results and cannot
be modified.</p>
</li>
<li>
<p>A request may span multiple repository accesses in case of inclusions with the <code>include</code> parameter. In this
case every access is checked individually.</p>
</li>
<li>
<p><code>HomeModule</code> and <code>MetaModule</code> show only resources the user is authorized to see. In case of the <code>MetaModule</code>
the <code>MetaAttribute</code> and <code>MetaResource</code> provide further information about what can be read, inserted, updated and
deleted.</p>
</li>
<li>
<p>(soon) Query parameters for sorting and filtering are checked against unauthorized access to
related resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Internally the security module makes use of <code>ResourceFilter</code> to perform this task. More information about that is
available in a subsequent section.</p>
</div>
<div class="paragraph">
<p>Is is up to the application how and when to configure the <code>SecurityModule</code>. The set of rules can be static
or created dynamically. <code>SecurityModule.reconfigure(&#8230;&#8203;)</code> allows to replace the security
rules at runtime.</p>
</div>
<div class="paragraph">
<p><a id="resourcefilter"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_role_based_access_control_with_resourcefilter">10.3. Role-based Access Control with ResourceFilter</h3>
<div class="paragraph">
<p>The <code>SecurityModule</code> is only one example how to implement security. Underlying it is the <code>ResourceFilter</code> interface
provided by the Crnk engine:</p>
</div>
<div class="listingblock">
<div class="title">ResourceFilter.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>public interface ResourceFilter {
	FilterBehavior filterResource(ResourceFilterContext filterContext, ResourceInformation resourceInformation, HttpMethod method);
	FilterBehavior filterField(ResourceFilterContext filterContext, ResourceField field, HttpMethod method);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ResourceFilter</code> allows to restrict access to resources and fields. To methods <code>filterResource</code> and
<code>filterField</code> can be implemented for this purpose. Both return a <code>FilterBehavior</code> which allows to
distinguish between <code>NONE</code>, <code>IGNORE</code> and <code>FORBIDDEN</code>. For example, a field like a
lock count can make use of <code>IGNORE</code> in order to be ignored for POST and PATCH requests (the current value
on the server is left untouched). While access to an unauthorized resource or
field results in a forbidden error with <code>FORBIDDEN</code>. An example is given by the
<code>SecurityResourceFilter</code> of <code>SecurityModule</code> in 'crnk-security`. Since <code>ResourceFilter</code> methods are
invoked often, it is important for them to return quickly.</p>
</div>
<div class="paragraph">
<p>There is a <code>ResourceFilterDirectory</code> that complements <code>ResourceFilter</code>. It allows to query the authorization status
of a particular resource or field in context of the current request. The <code>ResourceFilterDirectory</code> makes
use of per-request caching as the information may be accessed repeatedly for a request.
It can be obtained with <code>ModuleContext.getResourceFilterDirectory(&#8230;&#8203;)</code> from the module API. For example, the <code>MetaModule</code> and
<code>HomeModule</code> make use of <code>ResourceFilterDirectory</code> to only list authorized elements.</p>
</div>
<div class="paragraph">
<p>Out of scope for <code>ResourceFilter</code> is the filtering based on data, this subject of the DataRoom Access Control
of the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dataroom_access_control">10.4. Dataroom Access Control</h3>
<div class="paragraph">
<p>Filtering of resources is one of the main building blocks of JSON:API. As such it is typically
not too hard to implement DAC. The roles of a user can be checked and if necessary
for filters specific to that user can be added. There are two possibilities
to add such filters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by updating the repository filters.</p>
</li>
<li>
<p>by implementing a repository decorator that intercepts the request before reaching the repository.
For more information see <a href="#repository_decoration">Repository Decoration</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>SecurityModule</code> comes with built-in support for DAC. An example looks like:</p>
</div>
<div class="listingblock">
<div class="title">DataRoomFilterTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>Unresolved directive in security.adoc - include::../../../../crnk-security/src/test/java/io/crnk/security/DataRoomFilterTest.java[tags=docs]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>DataRoomFilter</code> can be passed to the <code>SecurityConfig</code>. It has to provide
a <code>QuerySpec</code> of what the current caller is allowed to see. In the
example here all callers are just allowed to see tasks named
<code>foo</code>. Real-world scenarios access the user principal and roles to decide for
a particular filter. The returned <code>QuerySpec</code> is applied to all repository operations: <code>GET</code>, <code>PATCH</code>, <code>POST</code> and
<code>DELETE</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Descripton</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Added to the caller <code>QuerySpec</code> to filter by both caller and DataRoom filters. This will
  remove any sensitive/undesired resources from the result. Note that it is important to
  adapt the <code>QuerySpec</code> rather than filtering results of the query: only the former
  efficiently supports paging (if necessary, one can workaround this a bit for the later
  if deemed in practical by always query with offset 0 and limiting the number of pages one can request).
  Note there is also a further subtle difference when requesting a single resource by id:
  A <code>FORBIDDEN</code> status code is returned and a warning written to the log if the resource
  with the requested ID does not pass DAC. It is assumed that the caller should not know
  its ID in the first place.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Verifies that the created resources matches with DataRoom filter. Checks are
  performed in memory with <code>QuerySpec.apply</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PATCH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalent to <code>POST</code> but further verifiers that the caller has access to the existing,
  unchanged resource. Implementors may further those to make involved fields
  immutable with <code>@JsonApiField(patchable=false)</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Verifies that deleted resources match DataRoom filtering by querying them before deletion.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When accessing relationship repositories, only one side is checked
  for performance reasons. It is assumed that <code>DataRoomFilter</code> applies proper filters to
  both sides of a relationship. For <code>GET</code> it is the target side of the relationship
  (the returned resources), for <code>PATCH</code>, <code>POST</code> and <code>DELETE</code> the modified source side.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_adapt_user_interfaces_based_on_authorizations">10.5. Adapt User Interfaces based on Authorizations</h3>
<div class="paragraph">
<p>In many cases it is desired to adjust UIs based on the authorizations of a user to guide the
user early what he is authorized to do. There are two mechanisms that are outlined
in the next sections.</p>
</div>
<div class="sect3">
<h4 id="_resourcepermissioninformation">10.5.1. ResourcePermissionInformation</h4>
<div class="paragraph">
<p>The <code>ResourcePermissionInformation</code> interface specializes <code>MetaInformation</code> to
give access to the <code>ResourcePermission</code> of that particular element, either a list
or a single resource. If either of the two carries a <code>MetaInformation</code> implementing <code>ResourcePermissionInformation</code>, then the <code>SecurityModule</code>
will fill-in the <code>ResourcePermission</code> for the current request.</p>
</div>
</div>
<div class="sect3">
<h4 id="_api">10.5.2. API</h4>
<div class="paragraph">
<p><code>SecurityModule.setExposeRepositories(true)</code> sets up repositories accessible through the
<code>&lt;contextPath&gt;/security/</code> path. Currently supported are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;contextPath&gt;/security/role</code> to gain access to all configure roles.</p>
</li>
<li>
<p><code>&lt;contextPath&gt;/security/callerPermission</code> to gain access to all permissions of the current caller.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_home_and_meta_module">10.5.3. Home and Meta Module</h4>
<div class="ulist">
<ul>
<li>
<p><code>HomeModule</code> and <code>MetaModule</code> hide resources the user is not authorized to see.
Any UI can query their respective URLs to gain information about what the user is authorized to see.</p>
</li>
<li>
<p>The <code>MetaAttribute</code>  and <code>MetaResource</code> resources from the <code>MetaModule</code>  further show
information about which resources and fields can be inserted, updated and deleted.
The resources are available from <code>/meta/attributes</code> and <code>/meta/resource</code> respectively.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_provide_authentication_information_to_the_user">10.6. Provide Authentication Information to the User</h3>
<div class="paragraph">
<p>A frequent use case is to display user/login related information for a user. However, Crnk does not
do authentication on its own and the set of provided information is typically application-specific.
As such there is no direct support from Crnk, but a custom repository can look like:</p>
</div>
<div class="listingblock">
<div class="title">LoginRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code> public class LoginRepository extends ResourceRepositoryBase&lt;Login, String&gt; {


 	public LoginRepository() {
 		super(Login.class);
 	}

 	@Override
 	public ResourceList&lt;Login&gt; findAll(QuerySpec querySpec) {
 		List&lt;Login&gt; logins = new ArrayList&lt;&gt;();
 		SecurityContext context = SecurityContextHolder.getContext();
 		if (context != null) {
 			Authentication authentication = context.getAuthentication();
 			Login me = new Login();
 			me.setId("me");
 			me.setUserName(authentication.getName());
 			logins.add(me);
 		}
 		return querySpec.apply(logins);
 	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This particular example has been taken from
<a href="https://github.com/crnk-project/crnk-example/blob/master/crnk-example-service/src/main/java/io/crnk/example/service/security/LoginRepository.java">crnk-example</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exception_mapping">10.7. Exception Mapping</h3>
<div class="paragraph">
<p>Crnk comes with four exceptions that are relevant in a security context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io.crnk.core.exception.ForbiddenException</code> results in a HTTP <code>403</code> status code and forbids access to the requested element.</p>
</li>
<li>
<p><code>io.crnk.core.exception.UnauthorizedException</code> results in a HTTP <code>401</code> status code to trigger authentication.</p>
</li>
<li>
<p><code>io.crnk.core.exception.RepositoryNotFoundException</code> and <code>io.crnk.core.exception.ResourceNotFoundException</code> may be
used in favor of <code>io.crnk.core.exception.ForbiddenException</code> to completely hide unauthorized resources with a status <code>404</code>
indistinguishable from non-existing ones.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_potential_future_work">10.8. (Potential) Future Work</h3>
<div class="ulist">
<ul>
<li>
<p>Authorize access to fields with <code>SecurityModule</code>.</p>
</li>
<li>
<p>Authorize sort and filter parameters.</p>
</li>
<li>
<p>Resource annotations to configure <code>SecurityModule</code>.</p>
</li>
<li>
<p>Deny rules for <code>SecurityModule</code>.</p>
</li>
<li>
<p>Potentially give security-related information through <code>OPTIONS</code> requests.</p>
</li>
<li>
<p>DAC support for <code>SecurityModule</code>.
<a id="dataaccess"></a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_access">11. Data Access</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a id="in_memory"></a></p>
</div>
<div class="sect2">
<h3 id="_in_memory">11.1. In-Memory</h3>
<div class="paragraph">
<p>There are many use cases where data is not accessed from an external data store, but rather is already
available in-memory on the server or is sufficiently small to so.
For this purpose Crnk offers <code>QuerySpec.apply(&#8230;&#8203;)</code> and <code>InMemoryResourceRepository</code> to quickly build
repositories to offer access to in-memory data structures. This implementations are well suited for
up to a few thousands of resources.</p>
</div>
<div class="paragraph">
<p><code>QuerySpec.apply(&#8230;&#8203;)</code> allows the sorting, filtering, and paging for a list of objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> ResourceList&lt;Task&gt; findAll(QuerySpec querySpec) {
    <span class="predefined-type">List</span>&lt;Task&gt; tasks = ...
    return querySpec.apply(resources.values());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behind the scenes it makes use of <code>InMemoryEvaluator</code> that offers further customization options.
While sorting makes use of <code>Comparable</code>, filtering makes use of <code>FilterOperator.matches(value1, value2)</code>.
Custom <code>FilterOperator</code> implementations may extend the feature set of  <code>InMemoryEvaluator</code>. Paging
is implemented by simply truncating the result list. Inclusions and field sets are honored by
by the Crnk engine when returning results (other non-in-memory repositories may want to implement
this functionality directly in the repository to avoid fetching undesired data in the first place).</p>
</div>
<div class="paragraph">
<p>Based on <code>QuerySpec.apply(&#8230;&#8203;)</code> there is a <code>InMemoryResourceRepository</code> that simply holds resources in a
<code>ConcurrentHashMap</code>. <code>POST</code> and <code>PATCH</code> will insert and update resources in the map, while <code>DELETE</code> will remove
them again. Next to holding small data sets, it is also well suited for <strong>mocking of repositories</strong>.
For example,  <code>InMemoryResourceRepository</code> might be used in the early phases of development to instantly give consumers
a fully working repository without having to do the actual implementation. Or it can be used as replacement
for third-party repositories during testing.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>QuerySpec.apply(&#8230;&#8203;)</code> makes use of the information held in-memory. In that regard, it is
  conceptually simple. Make sure the in-memory data fits requirements. For example,
  some application may want to filter relationships bi-directionally. In this case the in-memory
  data structures must maintain the relationship from both ends (like <code>project</code> and <code>tasks</code> relationships
  in <code>Task</code> and <code>Project</code> resources respectively). This may already be given, happen when the repositories
  perform a change, or through getters and setters that are also accessed by Crnk.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a id="jpa_module"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_jpa">11.2. JPA</h3>
<div class="paragraph">
<p>The JPA module allows to automatically expose JPA entities as JSON:API repositories. No implementation
or Crnk-specific annotations are necessary.</p>
</div>
<div class="paragraph">
<p>The feature set includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>expose JPA entities to JSON:API repositories</p>
</li>
<li>
<p>expose JPA relations as JSON:API repositories</p>
</li>
<li>
<p>decide which entities to expose as endpoints</p>
</li>
<li>
<p>sorting, filtering, paging, inclusion of related resources.</p>
</li>
<li>
<p>all default operators of crnk are supported: <code>EQ</code>, <code>NEQ</code>, <code>LIKE</code>, <code>LT</code>, <code>LE</code>, <code>GT</code>, <code>GE</code>.</p>
</li>
<li>
<p>filter, sort and include parameters can make use of the dot notation to
join to related entities. For example, <code>sort=-project.name,project.id</code>,
 <code>filter[project.name][NEQ]=someValue</code> or <code>include=project.tasks</code>.</p>
</li>
<li>
<p>support for entity inheritance by allowing sorting, filtering and inclusions
to refer to attributes on subtypes.</p>
</li>
<li>
<p>support for Jackson annotations to customize entity attributes on the JSON:API layer, see <a href="#jackson_annotations">here</a>.</p>
</li>
<li>
<p>DTO mapping support to map entities to DTOs before sending them to clients.</p>
</li>
<li>
<p>JPA Criteria API and QueryDSL support to issue queries.</p>
</li>
<li>
<p>filter API to intercept and modify issued queries.</p>
</li>
<li>
<p>support for computed attributes behaving like regular, persisted attributes.</p>
</li>
<li>
<p>automatic transaction handling spanning requests and doing a rollback in case of an exception.</p>
</li>
<li>
<p><code>OptimisticLockExceptionMapper</code> mapped to JSON:API errors with
<code>409</code> status code.</p>
</li>
<li>
<p><code>PersistenceException</code> and <code>RollbackException</code> are unwrapped
to the usually more interesting exceptions like
<code>ValidationException</code> and then translated to JSON:API errors.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not yet supported are sparse field sets queried by tuple queries.</p>
</div>
<div class="sect3">
<h4 id="_jpa_module_setup">11.2.1. JPA Module Setup</h4>
<div class="paragraph">
<p>To use the JPA module, two things are necessary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a set of existing entities</p>
</li>
<li>
<p>matching JPA repositories that have to be setup</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For an  example have a look at
<a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-integration-examples/spring-boot-example">spring-boot-example</a>.</p>
</div>
<div class="sect4">
<h5 id="_entity">Entity</h5>
<div class="paragraph">
<p>Any JPA entity can be used to expose as JSON:API resource:</p>
</div>
<div class="listingblock">
<div class="title">ScheduleEntity.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.crnk.example.springboot.domain.model</span>;

<span class="keyword">import</span> <span class="include">io.crnk.core.resource.annotations.JsonApiRelation</span>;
<span class="keyword">import</span> <span class="include">io.crnk.core.resource.annotations.JsonApiRelationId</span>;
<span class="keyword">import</span> <span class="include">io.crnk.core.resource.annotations.JsonApiResource</span>;
<span class="keyword">import</span> <span class="include">io.crnk.core.resource.annotations.SerializeType</span>;

<span class="keyword">import</span> <span class="include">javax.persistence.Column</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Entity</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.FetchType</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Id</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.JoinColumn</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.JoinColumns</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.ManyToMany</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.ManyToOne</span>;
<span class="keyword">import</span> <span class="include">java.util.Set</span>;

<span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">schedule</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ScheduleEntity</span> {

    <span class="annotation">@Id</span>
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@JsonApiRelationId</span>()
    <span class="annotation">@Column</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">creator_id</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> creatorId;

    <span class="annotation">@ManyToOne</span>(fetch = FetchType.LAZY)
    <span class="annotation">@JoinColumns</span>({<span class="annotation">@JoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">creator_id</span><span class="delimiter">&quot;</span></span>, insertable = <span class="predefined-constant">false</span>, updatable = <span class="predefined-constant">false</span>)})
    <span class="annotation">@JsonApiRelation</span>(serialize = SerializeType.ONLY_ID)
    <span class="directive">private</span> UserEntity creator;

    <span class="annotation">@ManyToMany</span>(fetch = FetchType.LAZY)
    <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;UserEntity&gt; verifiers;

    <span class="directive">public</span> <span class="predefined-type">Long</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">Long</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getCreatorId() {
        <span class="keyword">return</span> creatorId;
    }

    <span class="directive">public</span> <span class="type">void</span> setCreatorId(<span class="predefined-type">String</span> creatorId) {
        <span class="local-variable">this</span>.creatorId = creatorId;
        <span class="local-variable">this</span>.creator = <span class="predefined-constant">null</span>;
    }

    <span class="directive">public</span> UserEntity getCreator() {
        <span class="keyword">return</span> creator;
    }

    <span class="directive">public</span> <span class="type">void</span> setCreator(UserEntity creator) {
        <span class="local-variable">this</span>.creator = creator;
        <span class="local-variable">this</span>.creatorId = creator != <span class="predefined-constant">null</span> ? creator.getLoginId() : <span class="predefined-constant">null</span>;
    }

    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;UserEntity&gt; getVerifiers() {
        <span class="keyword">return</span> verifiers;
    }

    <span class="directive">public</span> <span class="type">void</span> setVerifiers(<span class="predefined-type">Set</span>&lt;UserEntity&gt; verifiers) {
        <span class="local-variable">this</span>.verifiers = verifiers;
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Entities are mapped to resources.</p>
</li>
<li>
<p>Crnk understands all JPA-related annotations and in many cases, not Crnk-specific annotations are necessary.</p>
</li>
<li>
<p>Embeddables are mapped to nested json structures.</p>
</li>
<li>
<p>Embeddables used as primary keys are mapped to/from a simple string to remain addressable as resource id. The order of attributes thereby determines the position
of the values in the string.</p>
</li>
<li>
<p>Not supported are relationships within embeddables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is possible to add additional JSON:API related fields to entities by annotating them with <code>@javax.persistence.Transient</code> (or the other way around by marking
it with <code>@JsonIgnore</code>).</p>
</div>
<div class="listingblock">
<div class="title">JpaTransientTestEntity.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JpaTransientTestEntity</span> <span class="directive">extends</span> TestMappedSuperclass {

        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="predefined-type">Long</span> id;

        <span class="annotation">@Transient</span>
        <span class="annotation">@JsonApiRelation</span>(serialize = SerializeType.LAZY, lookUp = LookupIncludeBehavior.NONE)
        <span class="directive">private</span> Task task;

        <span class="directive">public</span> <span class="predefined-type">Long</span> getId() {
                <span class="keyword">return</span> id;
        }

        <span class="directive">public</span> <span class="type">void</span> setId(<span class="predefined-type">Long</span> id) {
                <span class="local-variable">this</span>.id = id;
        }

        <span class="directive">public</span> Task getTask() {
                <span class="keyword">return</span> task;
        }

        <span class="directive">public</span> <span class="type">void</span> setTask(Task task) {
                <span class="local-variable">this</span>.task = task;
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@JsonApiRelationId</code> is also supported for JPA entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span class="annotation">@Column</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">project_id</span><span class="delimiter">&quot;</span></span>)
        <span class="annotation">@JsonApiRelationId</span>
        <span class="directive">private</span> <span class="predefined-type">Long</span> projectId;

    <span class="annotation">@JsonApiRelation</span>(serialize=SerializeType.ID_ONLY)
        <span class="annotation">@ManyToOne</span>(fetch = FetchType.LAZY)
        <span class="annotation">@JoinColumn</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">project_id</span><span class="delimiter">&quot;</span></span>, insertable = <span class="predefined-constant">false</span>, updatable = <span class="predefined-constant">false</span>)
        <span class="directive">private</span> Project project;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that both fields are mapped to the same column. The <code>project</code> field must be made read-only with <code>insertable</code> and <code>updateable</code> to let JPA know that
<code>projectId</code> is supposed to be used for write operations. In the example, <code>SerializeType.ID_ONLY</code> will trigger for <code>projectId</code> to always be written to the
response in the relationship data section without having to fully load the related <code>project</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jpa_repository_setup">JPA Repository Setup</h5>
<div class="paragraph">
<p>To then expose
an entity as resource, provide a repository implementation inheriting from
<code>JpaEntityRepositoryBase</code>:</p>
</div>
<div class="listingblock">
<div class="title">ScheduleRepositoryImpl.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.crnk.example.springboot.domain.repository</span>;

<span class="keyword">import</span> <span class="include">io.crnk.example.springboot.domain.model.ScheduleEntity</span>;
<span class="keyword">import</span> <span class="include">io.crnk.data.jpa.JpaEntityRepositoryBase</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ScheduleRepositoryImpl</span> <span class="directive">extends</span> JpaEntityRepositoryBase&lt;ScheduleEntity, <span class="predefined-type">Long</span>&gt; {

    <span class="directive">public</span> ScheduleRepositoryImpl() {
        <span class="local-variable">super</span>(ScheduleEntity.class);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no such repository is specified, Spring Boot will by default expose all entities if not configured otherwise.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jpa_module_setup_2">JPA module Setup</h5>
<div class="paragraph">
<p>Crnk provides a Spring Boot AutoConfiguration to setup the JPA Module.
for more advanced use cases and other frameworks, the JPA module can also be setup
manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        TransactionRunner transactionRunner = ...;

        JpaModuleConfig config = <span class="keyword">new</span> JpaModuleConfig();

        <span class="comment">// expose all entitities from provided EntityManagerFactory</span>
        config.exposeAllEntities(entityManagerFactory);

        JpaModule jpaModule = JpaModule.createServerModule(config, em, transactionRunner());

        CrnkFeature feature = <span class="keyword">new</span> CrnkFeature(...);
        feature.addModule(jpaModule);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>exposeAllEntities</code> takes an <code>EntityManagerFactory</code> and exposes all registered entities as
JSON:API repository.</p>
</li>
<li>
<p><code>JpaRepositoryConfig.Builder.setRepositoryDecorator</code> allows to setup a repository decorator that can intercept and change any request,
like setting up additional links and meta information.</p>
</li>
<li>
<p>The transactionRunner needs to be implemented by the application to hook into the transaction processing of the used
environment (Spring, JEE, etc.). This might be as simple as a Spring bean implementing <code>TransactionRunner</code> and carring a
<code>@Transactional</code> annotation. The JPA module then ensures that every requests happens within such a transaction. Crnk
 comes with two default implementations: <code>SpringTransactionRunner</code> and
<code>CdiTransactionRunner</code> that come are included in <code>crnk-setup-spring</code> and <code>crnk-cdi</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pagination_2">11.2.2. Pagination</h4>
<div class="paragraph">
<p>The JPA module implements both pagination approaches supported by Crnk.
Setting <code>JpaModule.setTotalResourceCountUsed(true|false)</code> allows to decide whether the total
number of resources should be counted or whether just the presence of a subsequent resource
is checked (by querying <code>limit + 1</code> entities). By default the total resources
are counted. Have a look at the <a href="#pagination">[pagination]</a> section for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_criteria_api_and_querydsl">11.2.3. Criteria API and QueryDSL</h4>
<div class="paragraph">
<p>The JPA module can work with two different query APIs, the default Criteria API
and QueryDSL. <code>JpaModule.setQueryFactory</code> allows
to choose between those two implementation. There is the <code>JpaCriteriaQueryFactory</code>
and the <code>QuerydslQueryFactory</code>. By default the Criteria API is used.
QueryDSL sits on top of JPQL and has to advantage of being easier to use.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lazy_and_eager_loading">11.2.4. Lazy and Eager Loading</h4>
<div class="paragraph">
<p>JPA relationships can either be <code>EAGER</code> or <code>LAZY</code>. The former is mapped to Crnk serialization type <code>ID_ONLY</code> and the later to <code>LAZY</code>.
If a relationship is supposed to be truly eager, <code>@JsonApiRelation(serializeType=SerializeType.EAGER)</code> can be used next to the JPA annotations.</p>
</div>
<div class="paragraph">
<p>Be careful with JPA since its default is <code>EAGER</code> loading. It is a typical source of performance issues.</p>
</div>
</div>
<div class="sect3">
<h4 id="_access_with_crnk_client">11.2.5. Access with Crnk client</h4>
<div class="paragraph">
<p>To setup a Crnk client with the JPA module use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        client = <span class="keyword">new</span> CrnkClient(getBaseUri().toString());

        JpaModule module = JpaModule.newClientModule();
        setupModule(module, <span class="predefined-constant">false</span>);
        client.addModule(module);

        ResourceRepositoryV2&lt;TaskEntity, <span class="predefined-type">UUID</span>&gt; genericRepo = client.getRepositoryForType(TypeEntity.class)
        TaskRepository typedRepo = client.getRepositoryForInterface(TaskRepository.class)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look at <a href="https://github.com/crnk-project/crnk-framework/blob/master/crnk-data/crnk-data-jpa/src/test/java/io/crnk/data/jpa/data/JpaQuerySpecEndToEndTest.java" class="bare">https://github.com/crnk-project/crnk-framework/blob/master/crnk-data/crnk-data-jpa/src/test/java/io/crnk/data/jpa/data/JpaQuerySpecEndToEndTest.java</a> within the <code>crnk-data-jpa</code>
test cases to see how everything is used together with <code>crnk-client</code>.</p>
</div>
<div class="paragraph">
<p>There is also the possibility to specify a repository interface. The interface has the benefit of providing proper typing of meta information,
link information and list return type. An example can look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">TaskRepository</span> <span class="directive">extends</span> ResourceRepositoryV2&lt;TaskEntity, <span class="predefined-type">UUID</span>&gt; {

        <span class="directive">static</span> <span class="type">class</span> <span class="class">TaskListLinks</span> <span class="directive">implements</span> LinksInformation, SelfLinksInformation {

                <span class="directive">public</span> <span class="predefined-type">String</span> someLink = <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>;

        }

        <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TaskListMeta</span> <span class="directive">implements</span> MetaInformation {

                <span class="directive">public</span> <span class="predefined-type">String</span> someMeta = <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>;

        }

        <span class="directive">public</span> <span class="type">class</span> <span class="class">TaskList</span> <span class="directive">extends</span> ResourceListBase&lt;TaskEntity, TaskListMeta, TaskListLinks&gt; {

        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> TaskList findAll(QuerySpec querySpec);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the server-side, the interface can be registered with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  JpaRepositoryConfig.builder(PersonEntity.class)
           .setInterfaceClass(PersonRepository.class).build()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_customizing_the_exposed_resources_over_the_underlying_entity_model">11.2.6. Customizing the exposed resources over the underlying entity model</h4>
<div class="paragraph">
<p>Not always it is desired to have a 1:1 mapping between resources and entities. There are
various techniques to customize the resource model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make use of the Crnk and Jackson annotations like <code>@JsonApiResource</code>, <code>JsonApiRelationId</code>, <code>JsonApiRelation</code> and <code>@JsonIgnore</code> to modify the entities on the resource layer.</p>
</li>
<li>
<p>Setup a DB view matching the desired resource and declare it as entity. This typically is the most efficient way to implement complex entity/resource mappings.</p>
</li>
<li>
<p>Perform any kind of modification in your repository by overriding <code>findAll</code>, <code>save</code>, <code>create</code>,
<code>delete</code>. Note that the repository itself must not necessarily return entity classes, but
 rather can also return a DTO.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Next to modifying the set of attributes and relationships, an application may
also want to apply more advanced filters (SQL <code>SUBSELECT</code>, <code>GROUP BY</code>, etc.).
Thereby, it is recommended to continue following resource-oriented REST principles.
Most notably, everything that can be sorted and filtered, should also be
queryable. There are two typical scenarios:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The desired complex filter is based on a single column. In this case,
a new <code>FilterOperator</code> should be implemented just like any other existing operator
like <code>EQ</code> and <code>LT</code>.</p>
</li>
<li>
<p>The desired complex filter spans multiple columns and possibly tables.
A basic solution can just exchange the entity for a DB view and make
a new column available with the computed result used for filtering. Or a
more advanced and performant solution can introduce the computed result
as new (nested) resource. The later the advantage that the computed
result is only evaluated when explicitly requested, either directly or through
an inclusion. The new resources can be setup as DB view holding
the computed result and a foreign key to the original table.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_standalone_usage">11.2.7. Standalone Usage</h4>
<div class="paragraph">
<p>The given snipped shows how to translate a QuerySpec to a JPA Criteria query without involving
repositories and Crnk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">                JpaCriteriaQueryFactory queryFactory = JpaCriteriaQueryFactory.newInstance(em);

                PathSpec idAttr = PathSpec.of(TestEntity.ATTR_id);
                QuerySpec querySpec = <span class="keyword">new</span> QuerySpec(TestEntity.class);
                querySpec.addFilter(idAttr.filter(FilterOperator.GT, <span class="integer">0L</span>));
                querySpec.addSort(idAttr.sort(Direction.DESC));
                querySpec.includeRelation(PathSpec.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">oneRelatedValue</span><span class="delimiter">&quot;</span></span>));

                JpaCriteriaQuery&lt;TestEntity&gt; query = queryFactory.query(TestEntity.class);
                JpaQueryExecutor&lt;TestEntity&gt; executor = query.buildExecutor(querySpec);
                <span class="predefined-type">List</span>&lt;TestEntity&gt; resultList = executor.getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="validation_module"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jsr_303_validation_module">11.3. JSR 303 Validation Module</h3>
<div class="paragraph">
<p>A <code>ValidationModule</code> provided by <code>io.crnk:crnk-validation</code> implements
resource validation and provides exception mappers for <code>javax.validation.ValidationException</code> and <code>javax.validation.ConstraintViolationException</code>.
Among others, it properly translates 'javax.validation.ConstraintViolation' instances to JSON:API errors.
A JSON:API error can, among others, contain a source pointer. This source pointer allows a clients/UI to
display the validation errors next to the corresponding input fields.</p>
</div>
<div class="paragraph">
<p>A translated exception can look like:</p>
</div>
<div class="paragraph">
<p>]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
	"errors": [
		{
			"status": "422",
			"code": "javax.validation.constraints.NotNull",
			"title": "may not be null",
			"source": {
				"pointer": "data/attributes/name"
			},
			"meta": {
				"resourceId": "1",
				"type": "ConstraintViolation",
				"messageTemplate": "{javax.validation.constraints.NotNull.message}",
				"resourceType": "projects"
			}
		}
	]
}</pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>422</code> status code used for such errors.</p>
</div>
<div class="paragraph">
<p>As mentioned above, resource validation mechanism enabled by default will be applied in case of one of the following request
types: <code>POST</code>, <code>PUT</code> and <code>PATCH</code>. Once described behavior is unwanted,
module should be defined in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
        <span class="annotation">@Bean</span>
    ValidationModule validationModule()
        <span class="keyword">return</span> ValidationModule.create(<span class="predefined-constant">false</span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="meta_module"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_meta_module">11.4. Meta Module</h3>
<div class="paragraph">
<p>This is a module that exposes the internal workings of Crnk as JSON:API repositories.
It lets you browse the set of available resources, their types, their attributes, etc. For example,
Crnk UI make use of the meta module to implement auto-completing of input fields.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There is currently no JSON:API standard for meta data. There are more
general formats like Swagger and ALPS. At some point those might be supported as
well (probably rather the later than the former). One
can view them to be complementary to the <code>MetaModule</code> as the later
is exactly tailored towards JSON:API, such as the accessability as regular
JSON:API (meta) repository and data structures matching the standard. Most likely,
any future standard implementation will built up on the information from the
<code>MetaModule</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_setup_3">11.4.1. Setup</h4>
<div class="paragraph">
<p>A setup can look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">                MetaModule metaModule = MetaModule.create();
                metaModule.addMetaProvider(<span class="keyword">new</span> ResourceMetaProvider());</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ResourceMetaProvider</code> exposes all JSON:API resources and repositories as meta data. You may add further provides to
expose more meta data, such as the <code>JpaMetaProvider</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_examples_2">11.4.2. Examples</h4>
<div class="paragraph">
<p>To learn more about the set of available resources, have a look at the <code>MetaElement</code> class and all its subclasses. Some of the
most important classes are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 70%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implementation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/element</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaElement</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base class implemented by any meta element.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base class implemented by any meta type element.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/primitiveType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaPrimitiveType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents primitive types like Strings and Integers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/arrayType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaArrayType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents an array type.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/listType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaListType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents an list type.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/setType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaSetType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents an set type.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/mapType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaMapType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents an map type.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/dataObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaDataObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base type for any object holding data, like
																			 JPA entities or JSON:API resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/attribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaAttribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents an attribute of a <code>MetaDataObject</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaResource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON:API resource representation extending <code>MetaDataObject</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/meta/resourceRepository</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MetaResourceRepository</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON:API repository representation holding resources.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A <code>MetaResource</code> looks like:</p>
</div>
<div class="paragraph">
<p>]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "id" : "resources.project",
    "type" : "meta/resource",
    "attributes" : {
      "name" : "Project",
      "resourceType" : "projects"
    },
    "relationships" : {
      "parent" : {
        ...
      },
      "interfaces" : {
        ...
      },
      "declaredKeys" : {
        ...
      },
      "children" : {
        ...
      },
      "declaredAttributes" : {
        ...
      },
      "subTypes" : {
        ...
      },
      "attributes" : {
        ...
      },
      "superType" : {
        ...
      },
      "elementType" : {
        ...
      },
      "primaryKey" : {
        ...
      }
    }
  }</pre>
</div>
</div>
<div class="paragraph">
<p>A <code>MetaAttribute</code> looks like:</p>
</div>
<div class="paragraph">
<p>]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "id" : "resources.project.name",
    "type" : "meta/resourceField",
    "attributes" : {
      "filterable" : true,
      "nullable" : true,
      "lazy" : false,
      "association" : false,
      "primaryKeyAttribute" : false,
      "sortable" : true,
      "version" : false,
      "insertable" : true,
      "meta" : false,
      "name" : "name",
      "updatable" : true,
      "links" : false,
      "derived" : false,
      "lob" : false,
      "cascaded" : false
    },
    "relationships" : {
      "parent" : {
        ...
      },
      "children" : {
        ...
      },
      "oppositeAttribute" : {
        ...
      },
      "type" : {
        ...
      }
    }
  }</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_identifiers_for_meta_elements">11.4.3. Identifiers for Meta Elements</h4>
<div class="paragraph">
<p>Of importance is the assignment of IDs to meta elements. For resources the resource type is used to compute the meta
id and a <code>resources</code> prefix is added. In the example above, person gets a <code>resources.person</code> meta id.
Related objects (DTOs, links/meta info) located in the same or a subpackage of a resource gets the same meta id prefix.
A <code>ProjectData</code> sitting in a <code>dto</code> subpackage would get a <code>resources.dto.projectdata</code> meta id.</p>
</div>
<div class="paragraph">
<p>The meta ids are used, for example, by the Typescript generator to determine the file structure and dependencies of generated
source files.</p>
</div>
<div class="paragraph">
<p>Applications are enabled to adapt the id generator process with:</p>
</div>
<div class="paragraph">
<p><code>new ResourceMetaProvider(idPrefix)</code></p>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="paragraph">
<p><code>ResourceMetaProvider.putIdMapping(String packageName, String idPrefix)</code></p>
</div>
<div class="paragraph">
<p>to override the default <code>resources</code> prefix and assign a specific prefix for a package.</p>
</div>
</div>
<div class="sect3">
<h4 id="_extending_the_meta_module">11.4.4. Extending the Meta Module</h4>
<div class="paragraph">
<p>There is a <code>MetaModuleExtension</code> extension that allows other Crnk modules contribute <code>MetaProvider</code>
implementation. This allows to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add <code>MetaFilter</code> implementations to intercept and modify meta elements upon initialization and request.</p>
</li>
<li>
<p>add <code>MetaPartition</code> implementations to introduce new, isolated areas in the meta model, like a JPA
meta model next to the JSON:API one (like for documentation purposes).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more detailed information have a look at the current <code>ResourceMetaProvider</code>.</p>
</div>
<div class="paragraph">
<p><a id="facet_module"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_faceted_search">11.5. Faceted Search</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This feature is new and considered experimental. Also have a look at the roadmap.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Faceted search is used by many UIs to allow users to quickly navigate data sets. For example, virtually
every online shop makes use of the feature to show product categories and the number of products in that
category. Those categories, denoted as facets, have a label, a set of values and a count for each value. Facets
may also depend on each other, whereas later facets are filtered by preceding ones. With <code>FacetModule</code> Crnk
provides an out-of-the-box solution to implement faceted search.</p>
</div>
<div class="sect3">
<h4 id="_setup_4">11.5.1. Setup</h4>
<div class="paragraph">
<p>To setup faceted search, the <code>FacetModule</code> must be added to  application. For Spring Boot there is
a <code>CrnkFacetAutoConfiguration</code> in place. To then enable faceted search for an attribute, it can be
annotated with <code>@Facet</code>:</p>
</div>
<div class="listingblock">
<div class="title">FacetedProject.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JsonApiResource</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">projects</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">FacetedProject</span> {

        <span class="annotation">@JsonApiId</span>
        <span class="directive">private</span> <span class="predefined-type">Long</span> id;

        <span class="annotation">@Facet</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> name;

        <span class="annotation">@Facet</span>
        <span class="directive">private</span> <span class="type">int</span> priority;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behind the scenes there are currently two implementations available that are automatically chosen based on the repository at hand:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>InMemoryFacetProvider</code> that queries all resources and computes the facets in-memory. Only <strong>suitable for small data sets</strong>!</p>
</li>
<li>
<p><code>JpaFacetProvider</code> that makes use of SQL <code>GROUP BY</code> queries to efficiently compute facets. Used for any JPA-backed repository.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For very large data sets, the use of ElasticSearch is recommended (not yet implemented). Applications are also free to
implement their own <code>FacetProvider</code> implementation and register it through <code>FacetModuleExtension</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_examples_3">11.5.2. Examples</h4>
<div class="paragraph">
<p>All the facets are then available as regular, new JSON:API resource that can filtered, paged, sorted, etc. like
any other resource:</p>
</div>
<div class="paragraph">
<p>]
.http://127.0.0.1:8080/api/facet</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{

  "data" : [ {
    "id" : "projects_name",
    "type" : "facet",
    "attributes" : {
      "values" : {
        "Some Project" : {
          "label" : "Some Project",
          "value" : "Some Project",
          "filterSpec" : {
            "path" : "name",
            "operator" : "EQ",
            "value" : "Some Project",
          },
          "count" : 1
        },
        ...
      },
      "name" : "name",
      "type" : "projects",
      "labels" : [ "Great Project", "Crnk Project", "Some Project", "JSON:API Project" ]
    },
  }]
}</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the values are ordered by their count in the <code>labels</code> attribute.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nesting">11.5.3. Nesting</h4>
<div class="paragraph">
<p>To select values of facets and update the counts of subsequent facets use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>http://127.0.0.1:8080/api/facet?filter[values.priority][SELECT]=1,2</pre>
</div>
</div>
<div class="paragraph">
<p>A facet value is selected through its label and the <code>SELECT</code> operator. In the given example, the priority
gets restricted to <code>1</code> and <code>2</code>. This in turn restricts the counts of facets that follow
the <code>priority</code> facet. To choose and order facets use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>http://127.0.0.1:8080/api/facet?filter[name]=priority,name</pre>
</div>
</div>
<div class="paragraph">
<p>Facets are then ordered as specified by <code>filter[name]</code>.</p>
</div>
<div class="paragraph">
<p>For more examples, see <code>InMemoryFacetProviderTest</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_grouping">11.5.4. Grouping</h4>
<div class="paragraph">
<p>To compute facets separately for each label of a particular facet, use the <code>GROUP</code> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>http://127.0.0.1:8080/api/facet?filter[values][GROUP]=priority,name</pre>
</div>
</div>
<div class="paragraph">
<p>It works equivalent to SQL <code>GROUP BY</code> queries. In the example a count is computed for every pair of <code>priority</code> and <code>name</code>
and returned as facet resource.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
the GROUP operator needs for further performance tuning.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_roadmap">11.5.5. Roadmap</h4>
<div class="ulist">
<ul>
<li>
<p>Limit number of facet values and introduce a "other" category.</p>
</li>
<li>
<p>Configurable null handling.</p>
</li>
<li>
<p>Data/time support.</p>
</li>
<li>
<p>Range-based facets.</p>
</li>
<li>
<p>Native Elastic Search implementation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Feedback and PRs welcomed!
<a id="generation"></a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generation">12. Generation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Crnk allows the generation of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Typescript stubs for type-safe, client-side web development.</p>
</li>
<li>
<p>Type-safe <code>QuerySpec</code> and <code>PathSpec</code> types.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Contributions for other languages like iOS would be very welcomed.</p>
</div>
<div class="paragraph">
<p><a id="generation_java"></a></p>
</div>
<div class="sect2">
<h3 id="_java_annotation_processor">12.1. Java Annotation Processor</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This annotation processor is still experimental. Feedback welcomed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>crnk-gen-java</code> provides an annotation processor to generate a type-safe API for the construction of <code>QuerySpec</code>
and <code>PathSpec</code> objects. The annotation processor is setup like any other annotation processor.
In Gradle it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>dependencies{
  annotationProcessor 'io.crnk:crnk-gen-java'
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One may also has enable annotation processors in the IDE (most notable in IntelliJ IDEA). One can then make use of it like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">test</span>;

<span class="keyword">import</span> <span class="include">io.crnk.core.queryspec.FilterOperator</span>;
<span class="keyword">import</span> <span class="include">io.crnk.core.queryspec.FilterSpec</span>;
<span class="keyword">import</span> <span class="include">io.crnk.core.queryspec.QuerySpec</span>;
<span class="keyword">import</span> <span class="include">io.crnk.core.queryspec.SortSpec</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">test.UserPathSpec</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TypedQuerySpecTest</span> {

    <span class="directive">public</span> QuerySpec createQuerySpec() {
        UserQuerySpec querySpec = <span class="keyword">new</span> UserQuerySpec();
        querySpec.sort().loginId().desc();
        querySpec.filter().projects().id().filter(FilterOperator.EQ, <span class="integer">12</span>);
        querySpec.field().loginId();
        querySpec.include().projects();
        <span class="keyword">return</span> querySpec;
    }

    <span class="directive">public</span> FilterSpec createFilterSpec() {
        <span class="keyword">return</span> userPathSpec.projects().id().filter(FilterOperator.EQ, <span class="integer">12</span>);
    }

    <span class="directive">public</span> SortSpec createSortSpec() {
        <span class="keyword">return</span> userPathSpec.projects().id().desc();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>More improvements to the generates types are thinkable in the future, such as limiting
the set of fields depending on the use case (inclusions, field sets, sorting, filtering) depending on the
capability of that particular field. Contributions welcomed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_openapi">12.2. OpenAPI</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This generator is still experimental. Feedback welcomed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>crnk-gen-openapi</code> provides a way to generate OpenAPI files. The OpenAPI Specification,
originally known as the Swagger Specification, is a specification for machine-readable interface
files for describing, producing, consuming, and visualizing RESTful web services.</p>
</div>
<div class="paragraph">
<p>The OpenAPI generator allows the generation of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specifications of paths for resources and related objects (like nested objects and enumeration types).</p>
</li>
<li>
<p>specifications of result documents (i.e. resources and any linking and meta information).</p>
</li>
<li>
<p>specifications of links information.</p>
</li>
<li>
<p>specifications of meta information.</p>
</li>
<li>
<p>specifications of standard errors</p>
</li>
<li>
<p>specifications of standard parameters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If a <code>templateName</code> file is provided, it will override the <code>projectName</code>, <code>projectVersion</code>, and
<code>projectDescription</code> passed into the generate step. Similarly, descriptions of operations can be
overridden within the provided OpenAPI template file.</p>
</div>
<div class="paragraph">
<p>There is a Gradle plugin to run OpenAPI (and other) generation. The setup looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>buildscript {
	dependencies {
		classpath "io.crnk:crnk-gen-gradle:${version}"
	}
}

apply plugin: 'crnk-gen'
crnkGen {
    runtime {
        // Gradle classpath configuration to use
        configuration = 'runtime'
    }

    // fork generation into new process to have clean environment
    forked = true

    // specify the package to look for resources
    resourcePackages = ['io.crnk.test']

    openapi {
        // enable OpenAPI generation within Gradle plugin
        enabled = true

				// specify name of openapi template in the build dir to merge onto
				templateName = "openapi-template.yml"

				// specify name of API to display in the generated OpenAPI file
				projectName = "Generated Title"

				// specify version of the API to display in the generated OpenAPI file
				projectVersion = "0.1.0"

				// specify name of openapi template in the build dir to merge onto
				projectDescription = "A generated description of the API."

        // specify location of generated sources
        genDir = file('src/resources')
    }
}
crnkGen.init()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Applying <code>crnk-gen</code> results in a new <code>generateOpenapi</code> task to perform the generation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_typescript">12.3. Typescript</h3>
<div class="paragraph">
<p>The Typescript generator allows the generation of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>interfaces for resources and related objects (like nested objects and enumeration types).</p>
</li>
<li>
<p>interfaces for result documents (i.e. resources and any linking and meta information).</p>
</li>
<li>
<p>interfaces for links information.</p>
</li>
<li>
<p>interfaces for meta information.</p>
</li>
<li>
<p>methods to create empty object instances.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It can generate either plain Typescript interfaces or
target <a href="http://github.com/abdulhaq-e/ngrx-json-api">ngrx-json-api</a>.
Support for other libraries/formats would be straightforward to add, contributions welcomed. A generated resource looks
like in <a href="#format_plain">plain-text format</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>import {
	ManyResourceRelationship,
	ManyResult,
	OneResourceRelationship,
	OneResult,
	Resource
} from './crnk';
import {DefaultPagedMetaInformation} from './default.paged.meta.information';
import {DefaultPagedLinksInformation} from './information/default.paged.links.information';
import {Projects} from './projects';
import {ScheduleStatus} from './schedule.status';
import {Tasks} from './tasks';

export interface Schedule extends Resource {
	name?: string;
	description?: string;
	taskSet?: ManyResourceRelationship&lt;Tasks&gt;;
	project?: OneResourceRelationship&lt;Projects&gt;;
	projects?: ManyResourceRelationship&lt;Projects&gt;;
	status?: OneResourceRelationship&lt;ScheduleStatus&gt;;
	delayed?: boolean;
	customData?: { [key: string]: string };
}
export interface ScheduleResult extends OneResult {
	data?: Schedule;
}
export module ScheduleListResult {
	export interface ScheduleListLinks extends DefaultPagedLinksInformation {
	}
	export interface ScheduleListMeta extends DefaultPagedMetaInformation {
	}
}
export interface ScheduleListResult extends ManyResult {
	data?: Array&lt;Schedule&gt;;
	links?: ScheduleListResult.ScheduleListLinks;
	meta?: ScheduleListResult.ScheduleListMeta;
}
export let createEmptySchedule = function(id: string): Schedule {
	return {
		id: id,
		type: 'schedule',
	};
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>and for <a href="http://github.com/abdulhaq-e/ngrx-json-api">ngrx-json-api</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>import {DefaultPagedMetaInformation} from './default.paged.meta.information';
import {DefaultPagedLinksInformation} from './information/default.paged.links.information';
import {Projects} from './projects';
import {ScheduleStatus} from './schedule.status';
import {Tasks} from './tasks';
import {CrnkStoreResource} from '@crnk/angular-ngrx';
import {
	ManyQueryResult,
	OneQueryResult,
	ResourceRelationship,
	TypedManyResourceRelationship,
	TypedOneResourceRelationship
} from 'ngrx-json-api';

export module Schedule {
	export interface Relationships {
		[key: string]: ResourceRelationship;
		taskSet?: TypedManyResourceRelationship&lt;Tasks&gt;;
		project?: TypedOneResourceRelationship&lt;Projects&gt;;
		projects?: TypedManyResourceRelationship&lt;Projects&gt;;
		status?: TypedOneResourceRelationship&lt;ScheduleStatus&gt;;
	}
	export interface Attributes {
		name?: string;
		description?: string;
		delayed?: boolean;
		customData?: { [key: string]: string };
	}
}
export interface Schedule extends CrnkStoreResource {
	relationships?: Schedule.Relationships;
	attributes?: Schedule.Attributes;
}
export interface ScheduleResult extends OneQueryResult {
	data?: Schedule;
}
export module ScheduleListResult {
	export interface ScheduleListLinks extends DefaultPagedLinksInformation {
	}
	export interface ScheduleListMeta extends DefaultPagedMetaInformation {
	}
}
export interface ScheduleListResult extends ManyQueryResult {
	data?: Array&lt;Schedule&gt;;
	links?: ScheduleListResult.ScheduleListLinks;
	meta?: ScheduleListResult.ScheduleListMeta;
}
export let createEmptySchedule = function(id: string): Schedule {
	return {
		id: id,
		type: 'schedule',
		attributes: {
		},
		relationships: {
			taskSet: {data: []},
			project: {data: null},
			projects: {data: []},
			status: {data: null},
		},
	};
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>For an example have a look at the Crnk example application, see <a href="https://github.com/crnk-project/crnk-example">crnk-project/crnk-example</a>.</p>
</div>
<div class="paragraph">
<p>There is a Gradle plugin to run Typescript (and other) generation. The setup looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>buildscript {
	dependencies {
		classpath "io.crnk:crnk-gen-gradle:${version}"
	}
}

apply plugin: 'crnk-gen'
crnkGen {
    runtime {
        // Gradle classpath configuration to use
        configuration = 'runtime'
    }

    // fork generation into new process to have clean environment
    forked = true

    // specify the package to look for resources
    resourcePackages = ['io.crnk.test']

    typescript {
        // enable Typescript generation within Gradle plugin
        enabled = true

        // specify output format
        format = 'PLAINJSON' // or 'JSONAPI'

        // specify location of generated sources
        genDir = file('src/resources')
    }
}
crnkGen.init()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Applying <code>crnk-gen</code> results in a new <code>generateTypescript</code> task to perform the generation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gradle_customizations">12.4. Gradle customizations</h3>
<div class="paragraph">
<p>Internally the Crnk Gradle plugin supports multiple ways of looking up the set of available resources and repositories
to generate. The simplest way is by scanning the classpath for <code>@JsonApiResource</code>-annotated classes.
The classpath for scanning can be set through the use of a regular Gradle configuration object, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>crnkGen{
	runtime {
		configuration = 'runtime'
	}

	...
}
crnkGen.init()</code></pre>
</div>
</div>
<div class="paragraph">
<p>More elaborate setups can also launch an application (e.g. with Spring or CDI) and extract the information
from the running application. While the former is simpler to setup, the later can deal with all border cases
like a repository being backed by something different than a <code>@JsonApiResource</code>-annotated class. Such a
Spring setup looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>crnkGen{

    // launch a Spring application to extract information about available resources
	runtime {
		configuration = 'runtime'
        spring {
        	profile = 'test'
        	configuration = 'io.crnk.example.ExampleApplication'
        	initializerMethod = 'someInitMethod' // optional
        	defaultProperties['someKey'] = 'someValue'
        }
	}

	...
}
crnkGen.init()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typically a test profile can used to bring the Spring application up as unit tests are supposed to be
self-contained and allow the application to boot up. The repositories are then retrieved from the
Spring dependency injection container.</p>
</div>
</div>
<div class="sect2">
<h3 id="_documentation_with_asciidoc">12.5. Documentation with AsciiDoc</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This is still experimental. Feedback welcomed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Documentation of REST APIs has a long history of various tooling. Swagger/OpenAPI there is the classical choice,
but comes with a variety of disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mechanisms used to extract information from an implementation often fail understand the full scope of it.</p>
</li>
<li>
<p>Annotations for descriptions lead to a large amount of boiler-plate.</p>
</li>
<li>
<p>Swagger UI is delivered as webapp and hard to enrich with custom information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This triggered, for example, the development of <a href="https://github.com/Swagger2Markup/swagger2markup">swagger2markup</a> to
make is of AsciiDoc as output target. This in turn lets developers manually written and generated
documentation and publish it as HTML and PDF in a potentially versioned manner.</p>
</div>
<div class="paragraph">
<p>Further progress iad made by <a href="https://docs.spring.io/spring-restdocs/docs/1.2.6.RELEASE/reference/html5/">spring-restdocs</a>.
Instead of attempting to write a specification, request and responses are captured from unit tests and
enriched with documentation to then save as AsciiDoc.  This ensures 100% accurate documentation at all time since.</p>
</div>
<div class="paragraph">
<p>JSON:API enables developers to take a further leap. Since it provides a well-defined standard for many aspects
of a REST endpoint, such as parameter handling, status codes and linking, it greatly simplifies the documentation task.
Many things are covered by the standard and the documentation can focus on the essential aspects of the
application. This in turn is realized by the AsciiDoc module of the Crnk generator.</p>
</div>
<div class="paragraph">
<p>The setup looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>crnkGen{
    runtime {
        configuration = 'typescriptGenRuntime'
    }

    // specify the package to look for resources
    resourcePackages = ['io.crnk.test']

    asciidoc {
        // enable Typescript generation within Gradle plugin
        enabled = true

        // title of generated document
        title = "Api Documentation"

        // specify location of generated sources
        genDir = file('build/generated/sources/asciidoc')
    }
}
crnkGen.init()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in a <code>generateAsciidoc</code> task to perform the generation.  The output directory then
contains a collection of files that can either be included individually or together with the main <code>index.adoc</code>.</p>
</div>
<div class="paragraph">
<p>Descriptions for resources and fields are extracted from JavaDoc.</p>
</div>
<div class="paragraph">
<p>The generated documentation can be enriched with request/response examples from unit tests. An example looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>package io.crnk.gen.asciidoc;

import io.crnk.client.CrnkClient;
import io.crnk.client.http.inmemory.InMemoryHttpAdapter;
import io.crnk.core.boot.CrnkBoot;
import io.crnk.core.queryspec.FilterOperator;
import io.crnk.core.queryspec.PathSpec;
import io.crnk.core.queryspec.QuerySpec;
import io.crnk.core.repository.ManyRelationshipRepository;
import io.crnk.core.repository.OneRelationshipRepository;
import io.crnk.core.repository.ResourceRepository;
import io.crnk.core.resource.list.ResourceList;
import io.crnk.format.plainjson.PlainJsonFormatModule;
import io.crnk.gen.asciidoc.capture.AsciidocCaptureConfig;
import io.crnk.gen.asciidoc.capture.AsciidocCaptureModule;
import io.crnk.test.mock.TestModule;
import io.crnk.test.mock.models.Project;
import io.crnk.test.mock.models.Task;
import io.crnk.test.mock.models.TaskStatus;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;

import java.io.File;
import java.util.Arrays;
import java.util.Collections;

public class AsciiDocCaptureTest {

    private ResourceRepository&lt;Task, Long&gt; taskRepository;
    private ResourceRepository&lt;Project, Long&gt; projectRepository;

    private OneRelationshipRepository&lt;Task, Long, Project, Long&gt; taskToProjectOneRelationRepository;
    private ManyRelationshipRepository&lt;Task, Long, Project, Long&gt; taskToProjectManyRelationRepository;

    private AsciidocCaptureModule asciidoc;

    @Before
    public void setup() {
        CrnkBoot boot = setupServer();

        asciidoc = setupAsciidoc();
        CrnkClient client = setupClient(boot, asciidoc);
        taskRepository = client.getRepositoryForType(Task.class);
        projectRepository = client.getRepositoryForType(Project.class);
        taskToProjectOneRelationRepository = client.getOneRepositoryForType(Task.class, Project.class);
        taskToProjectManyRelationRepository = client.getManyRepositoryForType(Task.class, Project.class);
    }

    private CrnkClient setupClient(CrnkBoot boot, AsciidocCaptureModule module) {
        String baseUrl = "http://127.0.0.1:8080/api";
        InMemoryHttpAdapter httpAdapter = new InMemoryHttpAdapter(boot, baseUrl);

        CrnkClient client = new CrnkClient(baseUrl);
        client.addModule(module);
        client.addModule(new PlainJsonFormatModule());
        client.setHttpAdapter(httpAdapter);
        return client;
    }

    private AsciidocCaptureModule setupAsciidoc() {
        File outputDir = new File("build/tmp/asciidoc/generated/sources/asciidoc");
        AsciidocCaptureConfig asciidocConfig = new AsciidocCaptureConfig();
        asciidocConfig.setGenDir(outputDir);
        return new AsciidocCaptureModule(asciidocConfig);
    }

    private CrnkBoot setupServer() {
        CrnkBoot boot = new CrnkBoot();
        boot.addModule(new TestModule());
        boot.addModule(new PlainJsonFormatModule());
        boot.boot();
        return boot;
    }

    @Test
    public void checkAccess() {
        Task newTask = new Task();
        newTask.setName("Favorite Task");
        newTask.setStatus(TaskStatus.OPEN);

        Task createdTask = asciidoc.capture("Create new Task").call(() -&gt; taskRepository.create(newTask));

        QuerySpec querySpec = new QuerySpec(Task.class);
        querySpec.addFilter(PathSpec.of("name").filter(FilterOperator.EQ, "Favorite Task"));
        querySpec.setOffset(0);
        querySpec.setLimit(5L);
        ResourceList&lt;Task&gt; list = asciidoc.capture("Find Task by Name").call(() -&gt; taskRepository.findAll(querySpec));
        Assert.assertNotEquals(0, list.size());

        createdTask.setName("Updated Task");
        asciidoc.capture("Update a Task").call(() -&gt; taskRepository.save(createdTask));

        asciidoc.capture("Delete a Task").call(() -&gt; taskRepository.delete(createdTask.getId()));
    }

	@Test
	public void checkOneRelationRepositoryAccess() {
		Task newTask = new Task();
		newTask.setName("Favorite Task");
		newTask.setStatus(TaskStatus.OPEN);
		Task createdTask = taskRepository.create(newTask);

		Project newProject = new Project();
		newProject.setName("Favorite Project");
		newProject.setDescription("It's just for test");
		Project createdProject = projectRepository.create(newProject);

		asciidoc.capture("Link Project and Task").call(() -&gt; taskToProjectOneRelationRepository.setRelation(createdTask, createdProject.getId(), "project"));

		asciidoc.capture("Find Project by Task").call(() -&gt; taskToProjectOneRelationRepository.findOneRelations(Collections.singleton(createdTask.getId()), "project", new QuerySpec(Project.class)));

		asciidoc.capture("Delete Project from Task").call(() -&gt; taskToProjectOneRelationRepository.setRelation(createdTask, null, "project"));
	}

	@Test
	public void checkManyRelationRepositoryAccess() {
		Task newTask = new Task();
		newTask.setName("Favorite Task");
		newTask.setStatus(TaskStatus.OPEN);
		Task createdTask = taskRepository.create(newTask);

		Project firstNewProject = new Project();
		firstNewProject.setName("First Favorite Project");
		firstNewProject.setDescription("It's just for test");
		Project firstCreatedProject = projectRepository.create(firstNewProject);

		Project secondNewProject = new Project();
		secondNewProject.setName("Second Favorite Project");
		secondNewProject.setDescription("It's just for test");
		Project secondCreatedProject = projectRepository.create(secondNewProject);

		asciidoc.capture("Link Task with several Projects").call(() -&gt; taskToProjectManyRelationRepository.addRelations(createdTask, Arrays.asList(firstCreatedProject.getId(), secondCreatedProject.getId()), "projects"));

		asciidoc.capture("Get Task relation Projects").call(() -&gt; taskToProjectManyRelationRepository.findManyRelations(Collections.singleton(createdTask.getId()), "projects", new QuerySpec(Project.class)));

		asciidoc.capture("Remove single Project from Task").call(() -&gt; taskToProjectManyRelationRepository.removeRelations(createdTask, Collections.singleton(firstCreatedProject.getId()), "projects"));
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example sets up a Crnk client and server. They are directly connected through <code>InMemoryHttpAdapter</code> to
by-pass the HTTP layer and forgo the setup of a web server. The <code>AsciidocCaptureModule</code> is add to the
client to do the capturing. To then capture a request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>asciidoc.capture("Create new Task").call(() -&gt; repository.create(newTask));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the output is matched with Crnk generator plugin, then the captured test cases will be picked up automatically.
A full setup is available in the main <a href="https://github.com/crnk-project/crnk-example">crnk-example</a> application.</p>
</div>
<div class="paragraph">
<p><a id="operations"></a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bulk_updates_with_operations_module">13. Bulk Updates with Operations Module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By its nature RESTful applications are limited to the insertion, update and deletion of single resources. As such, developers
have to design resources accordingly while having to consider aspects like transaction handling and atomicity. It is not
uncommon to combine multiple data objects on the server-side and expose it as single resource to clients. It is a simple
approach, but can also mean quite a substantial overhead when having to implement potentially redudant repositories.
Furthermore, things like validation handling, relationships and supporting complex object graphs can get tricky when a single
resource starts holding complex object graphs again.</p>
</div>
<div class="paragraph">
<p>For all the before mentioned reason support for <a href="http://jsonpatch.com/">jsonpatch.com</a> is provided. It allows to send multiple
insertions, updates and deletions with a single request and provides the results for each such executed operation.
Note that numerous attempts and discussions have taken place and are still ongoing to establish a common JSON:API standard,
but that does not seem to make much progress. With  <a href="http://jsonpatch.com/">jsonpatch.com</a> there is already an estabilished
standard that fits well for many use cases.</p>
</div>
<div class="paragraph">
<p>The implementation is provided as <code>OperationsModule</code> and the setup looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>		OperationsModule operationsModule = OperationsModule.create();
		...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further filters can be applied to intercept incoming requests. Typically applications will make use of that to start a new
transaction spanning all requests. This looks as follows:</p>
</div>
<div class="listingblock">
<div class="title">AbstractOperationsTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>            if (isTransactional()) {
				operationsModule.addFilter(new TransactionOperationFilter());
			}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is further an operations client implementation that works along the regular JSON:API client implementation:</p>
</div>
<div class="listingblock">
<div class="title">OperationsPostTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>        OperationsClient operationsClient = new OperationsClient(client);
        OperationsCall call = operationsClient.createCall();
        call.add(HttpMethod.POST, movie);
        call.add(HttpMethod.POST, person1);
        call.add(HttpMethod.POST, person2);
        call.execute();</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_operation_module_properties">13.1. Operation Module Properties</h3>
<div class="paragraph">
<p>The operations module can be customized using one of the following properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Operation Module Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Property Name</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Default Value</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">resumeOnError</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If an error occurs during the operation execution, continue the other operations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeChangedRelationships</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Toggle to include all changed relationships in the request by default. This only applies for POST and PATCH operation requests.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">displayOperationResponseOnSuccess</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, the response will always be included. Otherwise, it only displays the status codes of the operation unless an error has occurred.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here is an example of how to set these properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>OperationsModule operationsModule = OperationsModule.create();
operationsModule.setIncludeChangedRelationships(false);
operationsModule.resumeOnError(true);
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example_request_and_response">13.2. Example Request and Response</h3>
<div class="paragraph">
<p>An example request in JSON looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[ {
  "op" : "POST",
  "path" : "movie",
  "value" : {
    "id" : "43e7903e-9b14-4610-96f5-69d6f2fa347d",
    "type" : "movie",
    "attributes" : {
      "title" : "test",
      ...
    },
    "relationships" : {
      ...
    }
  }
}, {
  "op" : "POST",
  "path" : "person",
  "value" : {
    "id" : "b25bfdbd-8dd6-4abd-a859-f1dedf85246b",
    "type" : "person",
    "attributes" : {
      "name" : "1",
      "version" : null
    }
  }
}, {
  "op" : "POST",
  "path" : "person",
  "value" : {
    "id" : "f9d2bda5-d2f4-4c0c-85c7-cc56b6ea91e6",
    "type" : "person",
    "attributes" : {
      "name" : "2",
      "version" : null
    }
  }
} ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>and an example response JSON looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[ {
  "data" : {
    "id" : "43e7903e-9b14-4610-96f5-69d6f2fa347d",
    "type" : "movie",
    "attributes" : {
      "title" : "test",
      ...
    },
    "relationships" : {
      ..
    },
    "links" : {
      "self" : "http://localhost:58367/movie/43e7903e-9b14-4610-96f5-69d6f2fa347d"
    }
  },
  "status" : 201
}, {
  "data" : {
    "id" : "b25bfdbd-8dd6-4abd-a859-f1dedf85246b",
    "type" : "person",
    "attributes" : {
      "name" : "1",
      "version" : 0
    },
    "relationships" : {
      ...
    },
    "links" : {
      "self" : "http://localhost:58367/person/b25bfdbd-8dd6-4abd-a859-f1dedf85246b"
    }
  },
  "status" : 201
}, {
  "data" : {
    "id" : "f9d2bda5-d2f4-4c0c-85c7-cc56b6ea91e6",
    "type" : "person",
    "attributes" : {
      "name" : "2",
      "version" : 0
    },
    "relationships" : {
      ...
    },
    "links" : {
      "self" : "http://localhost:58367/person/f9d2bda5-d2f4-4c0c-85c7-cc56b6ea91e6"
    }
  },
  "status" : 201
} ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice in the response a status code for each request. It is import for the <code>Content-Type</code> and <code>Accept</code> HTTP headers
to have <code>application/json-patch+json</code>, otherwise the <code>OperationsModule</code> will ignore such requests.</p>
</div>
<div class="paragraph">
<p>The current limitations of the implementation are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Does so far not support bulk update of relationships.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With support for <code>GET</code> (find-one only), <code>POST</code>, <code>PATCH</code> and <code>DELETE</code> operations the most important building blocks should be in place.
The limitations are expected to be addressed at some point as well, contributions welcomed.</p>
</div>
<div class="paragraph">
<p>There is experimental support for <a href="#resource_bulk_repository">BulkResourceRepository</a>. If multiple changes to the
same repository are detected, it can make use of the appropriate bulk methods.</p>
</div>
<div class="paragraph">
<p><a id="monitoring"></a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring">14. Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a id="brave_module"></a></p>
</div>
<div class="sect2">
<h3 id="_opentracing">14.1. OpenTracing</h3>
<div class="paragraph">
<p><a href="https://opentracing.io/">OpenTracing</a> is a open, vendor-neutral API for tracing similar to SLF4J for logging.
The project is a member of the <a href="https://www.cncf.io/">Cloud Native Foundation</a>. <a href="https://www.jaegertracing.io/">Jeager</a> and
<a href="https://www.elastic.co/solutions/apm">Elastic APM</a> are two implementation providing support for it.
<code>crnk-monitor-opentracing</code> features an <code>OpenTracingServerModule</code>. The module sets a
human-readable name to any span tracing a JSON:API call, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /api/users</code></p>
</li>
<li>
<p><code>PATCH /api/users/{id}</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notice the <code>{id}</code> that will prevent dynamic parts of the URL from polluting the tracing data stores.</p>
</div>
<div class="paragraph">
<p>INFORMATION:  The module does not start spans on its own. It is the duty of the underlying HTTP layer
  to do so. This way the HTTP layer can cover all kinds of calls, not just JSON_API ones.</p>
</div>
<div class="paragraph">
<p>In Kibana together with Elastic APM it looks like:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/tracing.png" alt="tracing"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Distributed tracing  is  still an evolving topic. Most notably
 <a href="https://www.w3.org/community/trace-context/">W3C Trace Context</a> will provide a standard for
 header propagation that hopefully will allow various systems to better work together on a
 protocol-level.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_tracing_with_zipkinbrave">14.2. Tracing with Zipkin/Brave</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This module is deprecated. The use of OpenTracing is recommended instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>BraveClientModule</code> and <code>BraveServletModule</code> provided by <code>io.crnk:crnk-monitor-brave4</code> provides
integration into Zipkin/Brave to implement tracing for your repositories.  The module is applicable to
both a Crnk client or server.</p>
</div>
<div class="paragraph">
<p>The Crnk client can make use of either HttpClient or OkHttp to issue HTTP requests.
Accordingly, a matching brave integration must be added to the classpath:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io.zipkin.brave:brave-instrumentation-okhttp3</code></p>
</li>
<li>
<p><code>io.zipkin.brave:brave-instrumentation-httpclient</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>BraveClientModule</code> then takes care of the integration and will create a client span
for each request.</p>
</div>
<div class="paragraph">
<p>On the server-side, <code>BraveServletModule</code> creates a local span for each accessed repository.
Every request triggers one or more repository accesses (depending on whether
relations are included). Note however that <code>BraveServletModule</code> does not setup tracing
for incoming requests. That is the purpose of the JAX-RS/servlet integration of Brave.</p>
</div>
<div class="paragraph">
<p>Have a look at the Spring boot example application to see the <code>BraveServletModule</code> in use
together with a log reporter writing the output to console.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>io.crnk:crnk-brave</code> is deprecated and makes use of the Brave 3.x API.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_faq">15. FAQ</h2>
<div class="sectionbody">
<div class="qlist qanda">
<ol>
<li>
<p><em>How to do Cors with Crnk?</em></p>
<p>In most (if not all) cases Cors should be setup in the underlying
integration, like with the Servlet-API or as JAX-RS filter and
not within Crnk itself. This allows to make use of the native
Cors mechanisms of an integration and to share Cors handling with
the other parts of the application.</p>
</li>
<li>
<p><em>Is Swagger supported by Crnk?</em></p>
<p>Crnk comes with an experimental generator that will create an Open API-compatible
specification. For more general information about the benefits of a more opinionated
specification like JSON:API see <a href="http://www.crnk.io/related/" class="bare">http://www.crnk.io/related/</a>.</p>
</li>
<li>
<p><em>How can the serialization of Java 8 date and time data types be customized?</em></p>
<p>This is entirely in the hands of Jackson and not related to Crnk. A custom <code>JsonDeserializer</code>
and <code>JsonSerializer</code> can be implemented and registered with <code>ObjectMapper</code>.
See <a href="https://stackoverflow.com/questions/46263773/jackson-parse-custom-offset-date-time" class="bare">https://stackoverflow.com/questions/46263773/jackson-parse-custom-offset-date-time</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="moduledev"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_customizations_through_modules">16. Advanced Customizations through Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Crnk has a module API that allows to extend the core functionality by third-party contributions.
The mentioned JPA module in the next section is an example for that. The API is similar in spirit
to the one of the <code><a href="https://github.com/FasterXML/jackson" class="bare">https://github.com/FasterXML/jackson</a></code>. The main interface is <code>Module</code> with
a default implementation provided by <code>SimpleModule</code>. A module has access to a <code>ModuleContext</code>
that allows to register all kinds of extensions like new <code>ResourceInformationBuilder</code>,
<code>ResourceLookup</code>, <code>Filter</code>, <code>ExceptionMapper</code> and Jackson modules. It also gives access to the
<code>ResourceRegistry</code> holding information about all the repositories registered to crnk.
The <code>JpaModule</code> in <code>crnk-data-jpa</code> provides a good, more advanced example of using the
module API.</p>
</div>
<div class="paragraph">
<p><a id="requestfilter"></a></p>
</div>
<div class="sect2">
<h3 id="_request_filtering">16.1. Request Filtering</h3>
<div class="paragraph">
<p>Crnk provides three different, complementing mechanisms to hook into the request processing.</p>
</div>
<div class="paragraph">
<p>The <code>DocumentFilter</code> interface allows to intercept incoming requests and do
any kind of validation, changes, monitoring, transaction handling, etc. <code>DocumentFilter</code> can be
hooked into Crnk by setting up a module and registering the filter to the
<code>ModuleContext</code>. Note that for every request, this interface is called exactly once.</p>
</div>
<div class="paragraph">
<p>A request may span multiple repository accesses. To intercept the actual repository requests,
implement the <code>RepositoryFilter</code> interface. <code>RepositoryFilter</code> has a number of methods
that allow two intercept the repository request at different stages. Like <code>Filter</code> it can be
hooked into Crnk by setting up a module and registering the filter to the
<code>ModuleContext</code>.</p>
</div>
<div class="paragraph">
<p>Similar to <code>RepositoryFilter</code> it is possible to decorate a repository with another repository
implementing the same Crnk repository interfaces. The decorated repository instead of
the actual repository will get called and it is up to the decorated repository of how to proceed
with the request, usually by calling the actual repository. <code>RepositoryDecoratorFactory</code>
can be registered with <code>ModuleContext.addRepositoryDecoratorFactory</code>. The factory gets
notified about every repository registration and is then free to decorate it or not.</p>
</div>
<div class="paragraph">
<p><a id="modificationfilter"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_filter_modifications">16.2. Filter Modifications</h3>
<div class="paragraph">
<p>Changes to attributes and relationships can be tracked by implementing
<code>ResourceModificationFilter</code>. The filter is invoked upon an incoming request
while setting up the resource objects; before the actual repository is called.
Such filters are useful, for example, to implement auditing functionality.</p>
</div>
</div>
<div class="sect2">
<h3 id="_filter_priority">16.3. Filter Priority</h3>
<div class="paragraph">
<p><code>DocumentFilter</code>, <code>RepositoryFilter</code> and <code>ResourceModificationFilter</code> can implement
<code>Prioritizable</code> to introduce a priority among multiple filters.</p>
</div>
<div class="paragraph">
<p><a id="accesshttp"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_access_to_http_layer">16.4. Access to HTTP layer</h3>
<div class="paragraph">
<p><code>HttpRequestContext</code> resp. <code>HttpRequestContextProvider</code> provides access to the HTTP requests. Most
notably to get and set HTTP request and response headers. In many cases, the underlying
implementation like JAXRS or Servlet provides that access as well. With <code>HttpRequestContext</code>
there is an implementation that is independent of that implementation. As such it is well suited
for module development, in particular for request filtering. A typical use case is to set and
access security headers.</p>
</div>
<div class="paragraph">
<p><code>HttpRequestContextProvider.getRequestContext</code> returns the request context for the currently
active request. Modules have access to <code>HttpRequestContextProvider</code> trough the <code>ModuleContext</code>.
Repositories, filters and modules can implement <code>HttpRequestContextAware</code> to get
access to <code>HttpRequestContextProvider</code>.</p>
</div>
<div class="paragraph">
<p><a id="moduleextensions"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_module_extensions_and_dependencies">16.5. Module Extensions and dependencies</h3>
<div class="paragraph">
<p>ModuleExtension is an interface can can be implemented by modules to specify a contract how
others can extend it. The interface has two mandator properties: targetModule and
optional. targetModule specifies the module consuming those extensions (and providing
the implementation for it). optional specifies whether the target module must be registered
or not. In case of an optional extension without the module being registered, the extension
is simply ignored. The implementing module is free to add any further, custom methods to
provide extension hooks to other modules. To get access to this extensions, the
module can implement ModuleExtensionAware. Extensions must be registered during
Module.setupModule(&#8230;&#8203;) and will be available to the target module when Module.init() is called.</p>
</div>
<div class="paragraph">
<p>For an example have a look at MetaModuleExtension and the JpaModule making use of it.
The ModuleExtension was introduced with Crnk 2.0 and its use is expected to grow heavily
over time.</p>
</div>
<div class="paragraph">
<p><a id="thirdpartystores"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_integrate_third_party_data_stores">16.6. Integrate third-party data stores</h3>
<div class="paragraph">
<p>The core of Crnk is quite flexible when it comes to implementing repositories. As such, it is
not mandatory to make use of the Crnk annotations and conventions. Instead, it is also
(likely) possible to integrate an existing data store setup like JPA, JDBC, ElasticSearch, etc.
into Crnk. For this purpose a module can provide custom implementations of
<code>ResourceInformationBuilder</code> and <code>RepositoryInformationBuilder</code> trough
<code>ModuleContext.addResourceInformationBuilder</code> and <code>ModuleContext.addRepositoryInformationBuilder</code>.
For example, the JpaModule of  <code>crnk-data-jpa</code> makes use of that to read JPA instead of Crnk annotations.
Such a module can then register additional (usually dynamic) repositories with
<code>ModuleContext.addRepository</code>.</p>
</div>
<div class="paragraph">
<p><a id="customdiscovery"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_implement_a_custom_discovery_mechanism_2">16.7. Implement a custom discovery mechanism</h3>
<div class="paragraph">
<p>Crnk comes with out-of-the-box support for Spring and CDI. Both of them implement
<code>ServiceDiscovery</code>. You may provide your own implementation which can be hooked into the
various Crnk integrations, like the CrnkFeature. Alternatively, it can be auto-detected
through the Java service mechanism. For example, <code>crnk-cdi</code> makes use of:</p>
</div>
<div class="listingblock">
<div class="title">META-INF/services/io.crnk.core.module.discovery.ServiceDiscovery</div>
<div class="content">
<pre class="CodeRay highlight"><code>io.crnk.cdi.internal.CdiServiceDiscovery</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modules have access to that <code>ServiceDiscovery</code> trough the <code>ModuleContext.getServiceDiscovery()</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_let_a_module_hook_into_the_crnk_http_client_implementation">16.8. Let a module hook into the Crnk HTTP client implementation</h3>
<div class="paragraph">
<p>Modules for the Crnk client can additionally implement <code>HttpAdapterAware</code>. It gives
the module access to the underlying HTTP client implementation and allows arbitrary
customizations of it. Have a look at the Crnk client documentation for more information.</p>
</div>
<div class="paragraph">
<p><a id="customintegration"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_implement_a_custom_integration">16.9. Implement a custom integration</h3>
<div class="paragraph">
<p>Adding a new integration has become quite simple in recent times.
Have a look at <code>crnk-servlet</code> and <code>crnk-rs</code>. Most functionality
necessary is already be provided by <code>crnk-core</code>. The steps include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>implement <code>HttpRequestContextBase</code>.</p>
</li>
<li>
<p>instantiate <code>CrnkBoot</code> to setup crnk.</p>
</li>
<li>
<p>get the <code>RequestDispatcher</code> from <code>CrnkBoot</code>.</p>
</li>
<li>
<p>invoke the <code>RequestDispatcher</code> for each incoming request with the implemented
<code>HttpRequestContextBase</code>.</p>
</li>
<li>
<p>you may want to further implement <code>SecurityProvider</code>, <code>TransactionRunner</code>
and <code>PropertiesProvider</code> to interface with that particular systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="runtimerepository"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_create_repositories_at_runtime">16.10. Create repositories at runtime</h3>
<div class="paragraph">
<p>Repositories are usually created at compile-time, either by making use of the various annotations or a module
such as the <code>JpaModule</code>. However, the module API also allows the creation of repositories at runtime.
There are two complementary mechanisms in place to achieve this and outlined in the next two sections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
this feature is in incubation, more refinements are expected in upcoming releases.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_implementing_repositories_dynamically_at_runtime">16.10.1. Implementing repositories dynamically at runtime</h4>
<div class="paragraph">
<p>There are different possibilities to implement resources and repositories at runtime:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create resources classes at runtime with a library like <a href="http://bytebuddy.net/#/" class="bare">http://bytebuddy.net/#/</a> to follow the same
pattern as for any compile-time repository.</p>
</li>
<li>
<p><code>JsonAnyGetter</code> and <code>JsonAnySetter</code> annotations from Jackson allow to dynamically add properties to a resource.
Further implementing <code>ResourceTypeHolder</code> interface allows to manipulate the type of a resource. Together
the annotations allow the implementation of arbitrarily custom resources and type hierarchies. Note that
when making use of <code>ResourceTypeHolder</code> it may also become necessary to register the resource types
to the <code>ResourceRegistry</code> as <code>RegistryEntry</code> as outlined in the <code>Resource</code> example below.</p>
</li>
<li>
<p>Make use of the <code>Resource</code> class. It is the generic JSON:API resource presentation within the Crnk engine.</p>
</li>
<li>
<p>Make use of an arbitrary dynamic object like a <code>java.util.Map</code> and provide a <code>ResourceFieldAccessor</code> for
each <code>ResourceField</code> to specify how to read and write attributes (see below for <code>ResourceField</code> examples).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The use of <code>JsonAnyGetter</code> and <code>JsonAnySetter</code> is simplest and recommended for most use case.
An example is given in
<a href="https://github.com/crnk-project/crnk-example/blob/master/crnk-example-service/src/main/java/io/crnk/example/service/model/PersonEntity.java">PersonEntity</a>
Nevertheless the direct use of <code>Resource</code> opens up the possibility for more deeper control of everything:</p>
</div>
<div class="listingblock">
<div class="title">DynamicResourceRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code>public class DynamicResourceRepository extends ResourceRepositoryBase&lt;Resource, String&gt; implements UntypedResourceRepository&lt;Resource, String&gt; {

	private static Map&lt;String, Resource&gt; RESOURCES = new HashMap&lt;&gt;();

	private final String resourceType;

	public DynamicResourceRepository(String resourceType) {
		super(Resource.class);
		this.resourceType = resourceType;
	}

	@Override
	public String getResourceType() {
		return resourceType;
	}

	@Override
	public Class&lt;Resource&gt; getResourceClass() {
		return Resource.class;
	}

	@Override
	public DefaultResourceList&lt;Resource&gt; findAll(QuerySpec querySpec) {
		return querySpec.apply(RESOURCES.values());
	}
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This new repository can be registered to Crnk with a module:</p>
</div>
<div class="listingblock">
<div class="title">DynamicModule</div>
<div class="content">
<pre class="CodeRay highlight"><code>public class DynamicModule implements InitializingModule {

    private ModuleContext context;

    @Override
    public String getModuleName() {
        return "dynamic";
    }

    @Override
    public void setupModule(ModuleContext context) {
        this.context = context;
    }

    @Override
    public void init() {
        for (int i = 0; i &lt; 2; i++) {
            RegistryEntryBuilder builder = context.newRegistryEntryBuilder();

            String resourceType = "dynamic" + i;
            RegistryEntryBuilder.ResourceRepositoryEntryBuilder resourceRepository = builder.resourceRepository();
            resourceRepository.instance(new DynamicResourceRepository(resourceType));

            RegistryEntryBuilder.RelationshipRepositoryEntryBuilder parentRepository = builder.relationshipRepositoryForField("parent");
            parentRepository.instance(new DynamicRelationshipRepository(resourceType));
            RegistryEntryBuilder.RelationshipRepositoryEntryBuilder childrenRepository = builder.relationshipRepositoryForField("children");
            childrenRepository.instance(new DynamicRelationshipRepository(resourceType));

            InformationBuilder.ResourceInformationBuilder resource = builder.resource();
            resource.resourceType(resourceType);
            resource.implementationType(Resource.class);
            resource.addField("id", ResourceFieldType.ID, String.class);
            resource.addField("value", ResourceFieldType.ATTRIBUTE, String.class);
            resource.addField("parent", ResourceFieldType.RELATIONSHIP, Resource.class).oppositeResourceType(resourceType)
                    .oppositeName("children");
            resource.addField("children", ResourceFieldType.RELATIONSHIP, List.class).oppositeResourceType(resourceType)
                    .oppositeName("parent");

            context.addRegistryEntry(builder.build());
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new <code>RegistryEntry</code> is created and registered with Crnk. It provides information about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the resource and all its fields.</p>
</li>
<li>
<p>the repositories and instances thereof.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Have a look at the complete example
in <a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-client/src/test/java/io/crnk/client/dynamic"><code>crnk-client</code></a>
and
<a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-test/src/main/java/io/crnk/test/mock/dynamic"><code>crnk-test</code></a>
There is a further example test case and relationship repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="_registering_repositories_at_runtime">16.10.2. Registering repositories at runtime</h4>
<div class="paragraph">
<p>There are two possibilities to register a new repository at runtime:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by using a <code>Module</code> and invoking <code>ModuleContext.addRegistryEntry</code> as done in the previous section.</p>
</li>
<li>
<p>by implementing a <code>ResourceRegistryPart</code> and invoking <code>ModuleContext.addResourceRegistry</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first is well suited if there is a predefined set of repositories that need to be registered
(like a fixed set of JPA entities in the <code>JpaModule</code>). The later is suited for fully dynamic use cases where
the set of repositories can change over time (like tables in a database or tasks in an activiti instance). In this
case the repositories no longer need registration. Instead the custom <code>ResourceRegistryPart</code> implementation always
provides an up-to-date set of repositories that is used by the Crnk engine.</p>
</div>
<div class="paragraph">
<p>An example can be found at
<a href="https://github.com/crnk-project/crnk-framework/tree/master/crnk-core/src/test/java/io/crnk/core/engine/registry/CustomResourceRegistryTest.java">CustomResourceRegistryTest.java</a></p>
</div>
<div class="paragraph">
<p><a id="clientmodulediscovery"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_discovery_of_modules_by_crnkclient">16.11. Discovery of Modules by CrnkClient</h3>
<div class="paragraph">
<p>If a module does not need configuration, it can provide a <code>ClientModuleFactory</code>
implementation and register it to the <code>java.util.ServiceLoader</code> by adding a
'META-INF/services/io.crnk.client.module.ClientModuleFactory` file
with the implementation class name. This lets <code>CrnkClient</code> discover
the module automatically when calling <code>CrnkClient.findModules()</code>.
An example looks like:</p>
</div>
<div class="listingblock">
<div class="title">ValidationClientModuleFactory</div>
<div class="content">
<pre class="CodeRay highlight"><code>package io.crnk.validation.internal;

import io.crnk.client.module.ClientModuleFactory;
import io.crnk.validation.ValidationModule;

public class ValidationClientModuleFactory implements ClientModuleFactory {

	@Override
	public ValidationModule create() {
		return ValidationModule.create();
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="title">META-INF/services/io.crnk.client.module.ClientModuleFactory</div>
<div class="content">
<pre class="CodeRay highlight"><code>io.crnk.validation.internal.ValidationClientModuleFactory</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-04-16 18:24:55 UTC
</div>
</div>
</body>
</html>